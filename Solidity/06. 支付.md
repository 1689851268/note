# 以太比的单位

wei、gwei、finney 和 ether 是以太币（Ether）的不同单位。

1. wei 是以太币的最小单位，1 ether = 10^18 wei；这是 Solidity 中的默认单位

```solidity
uint public oneWei = 1 wei;
```

2. gwei 是 wei 的 10^9 倍，1 ether = 10^9 gwei；常用于表示交易费用 (gas price)

```solidity
uint public oneGwei = 1 gwei;
```

3. finney 是 wei 的 10^15 倍，1 ether = 10^3 finney

```solidity
uint public oneFinney = 1 finney;
```

4. ether 是 wei 的 10^18 倍；是以太坊的基本单位

```solidity
uint public oneEther = 1 ether;
```

<br><br>

# payable 修饰符

```solidity
contract Demo {
    // 接收以太币的函数, 必须使用 payable 修饰符
    function receiveEther() external payable {
        require(msg.value > 0, "Must send some Ether");
    }

    // 提现函数，将合约中的以太币发送给调用者
    function withdraw() external {
        uint256 amount = address(this).balance;
        require(amount > 0, "No Ether to withdraw");
        payable(msg.sender).transfer(amount);
    }

    // 获取合约的以太币余额
    function getBalance() external view returns (uint256) {
        return address(this).balance;
    }
}
```

1.  部署 Demo 合约

2.  设置以太币的数量，调用 receiveEther 函数

3.  调用 getBalance 函数，查看合约的以太币余额

4.  调用 withdraw 函数，将合约中的以太币发送给调用者

5.  再次调用 getBalance 函数，查看合约的以太币余额

<br><br>

# receive & fallback 方法

在 Solidity 中，receive & fallback 是一种特殊的函数。声明形式为 `receive/fallback() external payable { ... }`。它不需要 `function` 关键字，没有参数，也没有返回值。

**特性**：

-   receive & fallback 函数必须声明为 `external`，表示只能通过外部调用来触发。
-   receive 必须使用 `payable` 修饰符；fallback 可以使用 `payable` 修饰符。

**receive & fallback 的区别**：

-   receive：专门用于处理没有附加数据的以太币转账。
-   fallback：用于处理所有其他情况，包括调用不存在的函数或接收带有附加数据的以太币转账。如果合约没有定义 `receive` 方法，但定义了 `payable` 的 `fallback` 方法，那么在接收以太币时会调用 `fallback` 方法。

```solidity
contract Demo {
    event Log(string message, address sender, uint value, bytes data);

    // 定义 receive 方法
    receive() external payable {
        emit Log("receive", msg.sender, msg.value, "");
    }

    // 定义 fallback 方法
    fallback() external payable {
        emit Log("fallback", msg.sender, msg.value, msg.data);
    }
}
```

<br><br>

# 以太币的发送与接收

有 3 种方法发送以太币：

1.  transfer：有 2300 gas 的限制；如果转账失败，会回滚交易
2.  send：有 2300 gas 的限制；如果转账失败，不会回滚交易，而是返回 `false`；需要手动检查返回值并处理失败情况
3.  call：没有 gas 限制，可以指定 gas 量；如果转账失败，不会回滚交易，而是返回 `false`；需要手动检查返回值并处理失败情况

有 2 种方法接收以太币：

1. 用 payable 修饰 constructor，接收部署时传入的以太币
2. 编写 receive / fallback 方法，接收以太币

```solidity
contract SendEther {
    // 使用 transfer 方法发送以太币
    function sendEtherViaTransfer(address payable recipient) external payable {
        recipient.transfer(msg.value);
    }

    // 使用 send 方法发送以太币
    function sendEtherViaSend(address payable recipient) external payable {
        bool success = recipient.send(msg.value);
        require(success, "Send failed");
    }

    // 使用 call 方法发送以太币 (推荐)
    function sendEtherViaCall(address payable recipient) external payable {
        (bool success, ) = recipient.call{value: msg.value}("");
        require(success, "Call failed");
    }
}

contract ReceiveEther {
    event Received(address, uint, uint);

    // 接收部署时传入的以太币
    constructor() payable {}

    // 接收以太币
    receive() external payable {
        // 打印发送者、接收的以太币数量、剩余的 gas
        emit Received(msg.sender, msg.value, gasleft());
    }
}
```

1. 部署 SendEther 合约

2. 设置以太币的数量，部署 ReceiveEther 合约；部署完成后可以看到接收的以太币数量

3. ReceiveEther 合约的地址作为参数，设置以太币的数量，调用 SendEther 合约的 sendEtherViaTransfer 函数；可以看到 ReceiveEther 合约的以太币余额变化

4. ReceiveEther 合约的地址作为参数，设置以太币的数量，调用 SendEther 合约的 sendEtherViaSend 函数；可以看到 ReceiveEther 合约的以太币余额变化

5. ReceiveEther 合约的地址作为参数，设置以太币的数量，调用 SendEther 合约的 sendEtherViaCall 函数；可以看到 ReceiveEther 合约的以太币余额变化

<br>
