# 浏览器进程

现在的浏览器基本都采用多进程架构设计, 即一个标签页启动多个进程, 一般至少会有如下进程:

1. 浏览器进程: 浏览器的主进程, 负责协调,控制其他进程.
2. 渲染进程: 负责渲染页面内容.
3. GPU 进程: 负责使用显卡来提高渲染速度, 一般是涉及图形,视频的渲染.
4. 网络进程: 负责处理网络请求.
5. 插件进程: 当页面使用了插件, 如 Flash,PDF 等, 就会有对应的插件进程.

<br><br>

# 渲染进程

渲染进程即我们常说的浏览器内核, 它下面又分 5 类线程:

1. GUI 渲染线程: 负责渲染页面.

2. JS 引擎线程: 负责使用 JS 引擎处理 JS 脚本.

3. 事件触发线程: 管理事件队列, 当对应的事件被触发时, 事件触发线程就会把该事件添加到事件队列的队尾, 等待 JS 引擎的处理.

4. 定时器触发线程: 负责处理定时器, 计时完毕后, 会把定时器的回调函数添加到事件队列中, 等待 JS 引擎处理.

5. 异步 HTTP 请求线程: XMLHttpRequest 连接后, 浏览器会新开一个线程, 检测请求状态变更. 如果设置了回调函数, 异步线程就会产生状态变更事件, 将这个回调添加到事件队列中, 等待 JS 引擎处理.

<br>

## GUI 渲染线程

GUI 渲染线程对应**渲染引擎**. 渲染引擎的工作流程: 解析 HTML,解析 CSS,构建 DOM 树,构建渲染树,布局,分层,绘制,分块,光栅化,合成,显示.

-   当我们修改了一些元素的颜色或者背景色, 页面就会重绘 (Repaint).
-   当我们修改元素的尺寸, 页面就会回流 (Reflow).
-   当页面需要 Repaint / Reflow 时, 浏览器就会使用 GUI 渲染线程来绘制页面.
-   Reflow 比 Repaint 的成本要高.
-   GUI 渲染线程与 JS 引擎线程是互斥的. 当 JS 引擎执行时 GUI 线程会被挂起, GUI 更新会被保存在一个队列中等到 JS 引擎空闲再执行.

<br><br>

## JS 引擎线程

JS 引擎线程对应**JS 引擎 (JS 内核)**. JS 引擎的主要工作: 负责处理 JS 脚本, 包括安全性管理,内存管理,插件管理,处理网络请求,脚本执行,处理用户输入.

-   JS 引擎一直等待着任务队列中的任务到来, 然后加以处理.
-   一个 Tab 页中无论什么时候都只有一个 JS 线程在运行 JS 程序, 所以 JS 是单线程运行的.
-   GUI 渲染线程与 JS 引擎线程是互斥的, JS 引擎线程会阻塞 GUI 渲染线程, 也就是我们常遇到的 "JS 执行时间过长阻塞页面渲染" 的问题.

<br><br>

## 事件触发线程

-   用来控制事件循环, 并且管理着一个任务队列 (task queue).
-   当 JS 执行碰到事件绑定和一些异步操作 (如 setTimeout / 来自浏览器内核的其他线程, 如鼠标点击,AJAX 异步请求...), 会走事件触发线程将对应的事件添加到对应的线程中 (比如定时器操作, 便把定时器事件添加到定时器线程), 等异步事件有了结果, 便把他们的回调操作添加到任务队列, 等待 JS 引擎线程空闲时再处理.

<br><br>

## 定时器触发线程

-   `setInterval` 与 `setTimeout` 所在线程, 也叫定时器线程.
-   定时器通过单独的线程来计时. 计时完毕后, 添加到事件触发线程管理的事件队列中, 等待 JS 引擎空闲后执行.
-   W3C 在 HTML 标准中规定, 规定要求 `setTimeout` 中低于 4ms 的时间间隔算为 4ms.

<br><br>

## 异步 HTTP 请求线程

关于渲染进程中的 [异步 HTTP 请求线程] 和 [网络进程]:

渲染进程中的异步 HTTP 请求线程专门用来处理 JS 层面的异步请求, 比如 XMLHttpRequest,fetch 等; 网络进程比较全面, 负责处理所有的网络操作, 包括页面导航,处理主页面&子页面请求,资源加载等.

-   XMLHttpRequest 连接后是通过浏览器新开一个线程来进行请求的.

-   检测到状态变更时, 如果设置有回调函数, 异步线程就会触发状态变更事件, 并将这个回调放入事件队列中, 等待 JS 引擎执行.

    简而言之, 当执行到一个 http 异步请求时, 就把异步请求事件添加到异步请求线程, 等服务器响应 (准确来说应该是 http 状态更新), 再把回调函数添加到事件队列, 等待 JS 引擎线程来执行.

<br><br>

# 网络进程

网络进程下又分 4 类线程:

1. DNS 解析线程: 负责 DNS 解析.

2. SSL 线程: 处理 SSL/TLS 相关的加密和安全通信.

3. 网络请求线程: 处理网络请求, 包括接收和发送数据.

4. IPC 线程: 负责进程间通信.

主要功能包括: ① 处理网络请求,② HTTP 缓存管理,③ 网络安全保障,④ 跨域资源共享 (CORS),⑤ 代理服务器交互等.

<br><br>

# CPU & GPU

-   CPU（Central Processing Unit）: 中央处理器, 在单个任务上表现优异, 适用于处理复杂的,多变的计算任务.
-   GPU（Graphics Processing Unit）: 图形处理器, 在大规模并行计算上表现优异, 适用于处理大规模的,高度并行的,重复的计算任务.

<br><br>

# CSS 硬件加速原理

使用某些 CSS 属性后, 渲染引擎会把该元素单独分层交给 GPU 处理. GPU 处理图形计算更快,分层渲染不会造成页面的回流重绘.

<br>
