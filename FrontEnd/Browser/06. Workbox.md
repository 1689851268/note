# Workbox

## æ¦‚å¿µ

Workbox æ˜¯ç”± Google Chrome å›¢é˜Ÿå¼€å‘çš„å¼€æº JavaScript åº“é›†åˆ, ç”¨äºç®€åŒ– Service Worker çš„ç¼–å†™å’Œç®¡ç†. å®ƒå°è£…äº† Service Worker API çš„å¤æ‚æ€§, æä¾›äº†ä¸€å¥—é«˜çº§ API å’Œæœ€ä½³å®è·µ, è®©å¼€å‘è€…èƒ½å¤Ÿè½»æ¾å®ç° PWA (Progressive Web App) çš„æ ¸å¿ƒåŠŸèƒ½: ç¦»çº¿æ”¯æŒ, ç¼“å­˜ç®¡ç†, é¢„ç¼“å­˜, åå°åŒæ­¥ç­‰.

**æ ¸å¿ƒä»·å€¼:**

-   **ç®€åŒ–å¼€å‘**: å°†å¤æ‚çš„ Service Worker API å°è£…æˆæ˜“ç”¨çš„é«˜çº§æ¥å£
-   **ç”Ÿäº§çº§æ–¹æ¡ˆ**: Google å¤šå¹´ç»éªŒçš„æœ€ä½³å®è·µ, å·²åœ¨ YouTube, Google Photos ç­‰äº§å“ä¸­åº”ç”¨
-   **æ¨¡å—åŒ–è®¾è®¡**: æŒ‰éœ€å¼•å…¥æ‰€éœ€åŠŸèƒ½, é¿å…ä»£ç å†—ä½™
-   **æ„å»ºå·¥å…·é›†æˆ**: ä¸ Webpack, Vite, Rollup ç­‰ä¸»æµæ„å»ºå·¥å…·æ— ç¼é›†æˆ

<br>

## ä¸ºä»€ä¹ˆéœ€è¦ Workbox

### åŸç”Ÿ Service Worker çš„ç—›ç‚¹

```javascript
// æ‰‹å†™ Service Worker éœ€è¦å¤„ç†å¤§é‡ç»†èŠ‚
self.addEventListener("install", (event) => {
    event.waitUntil(
        caches.open("v1").then((cache) => {
            // éœ€è¦æ‰‹åŠ¨åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶åŠå…¶ç‰ˆæœ¬
            return cache.addAll([
                "/index.html",
                "/styles.css?v=1.0",
                "/app.js?v=1.0",
                // ...æ•°ç™¾ä¸ªæ–‡ä»¶
            ]);
        })
    );
});

self.addEventListener("fetch", (event) => {
    // éœ€è¦æ‰‹åŠ¨å®ç°å„ç§ç¼“å­˜ç­–ç•¥
    // éœ€è¦å¤„ç†å„ç§è¾¹ç•Œæƒ…å†µ
    // éœ€è¦æ‰‹åŠ¨ç®¡ç†ç¼“å­˜æ›´æ–°
    // ...å¤§é‡é‡å¤ä»£ç 
});
```

### ä½¿ç”¨ Workbox çš„ä¼˜åŠ¿

```javascript
// ä½¿ç”¨ Workbox, ç®€æ´æ¸…æ™°
import { precacheAndRoute } from "workbox-precaching";
import { registerRoute } from "workbox-routing";
import { CacheFirst } from "workbox-strategies";

// è‡ªåŠ¨é¢„ç¼“å­˜æ„å»ºæ—¶ç”Ÿæˆçš„èµ„æºæ¸…å•
precacheAndRoute(self.__WB_MANIFEST);

// å›¾ç‰‡ä½¿ç”¨ç¼“å­˜ä¼˜å…ˆç­–ç•¥
registerRoute(({ request }) => request.destination === "image", new CacheFirst({ cacheName: "images" }));
```

<br>

## æ ¸å¿ƒæ¨¡å—

Workbox é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡, ä¸»è¦åŒ…å«ä»¥ä¸‹æ ¸å¿ƒæ¨¡å—:

### 1. workbox-routing (è·¯ç”±ç®¡ç†)

ç”¨äºåŒ¹é…è¯·æ±‚ URL å¹¶åº”ç”¨å¯¹åº”çš„å¤„ç†ç­–ç•¥.

```javascript
import { registerRoute } from "workbox-routing";
import { CacheFirst } from "workbox-strategies";

// å­—ç¬¦ä¸²åŒ¹é…
registerRoute("/api/data", new CacheFirst());

// æ­£åˆ™åŒ¹é…
registerRoute(/\.(?:png|jpg|jpeg|svg|gif)$/, new CacheFirst());

// å‡½æ•°åŒ¹é…
registerRoute(({ request, url }) => {
    return request.destination === "script" || url.pathname.endsWith(".js");
}, new CacheFirst());
```

### 2. workbox-strategies (ç¼“å­˜ç­–ç•¥)

æä¾› 5 ç§å¸¸ç”¨çš„ç¼“å­˜ç­–ç•¥.

#### CacheFirst (ç¼“å­˜ä¼˜å…ˆ)

```javascript
import { CacheFirst } from "workbox-strategies";
import { registerRoute } from "workbox-routing";

registerRoute(
    ({ request }) => request.destination === "style",
    new CacheFirst({
        cacheName: "css-cache",
        plugins: [
            // å¯æ·»åŠ æ’ä»¶
        ],
    })
);
```

**æµç¨‹:** ç¼“å­˜ â†’ ç½‘ç»œ  
**é€‚ç”¨:** CSS, JS, å›¾ç‰‡ç­‰é™æ€èµ„æº

#### NetworkFirst (ç½‘ç»œä¼˜å…ˆ)

```javascript
import { NetworkFirst } from "workbox-strategies";

registerRoute(
    ({ url }) => url.pathname.startsWith("/api/"),
    new NetworkFirst({
        cacheName: "api-cache",
        networkTimeoutSeconds: 3, // 3 ç§’è¶…æ—¶åˆ™ä½¿ç”¨ç¼“å­˜
        plugins: [
            // æ’ä»¶é…ç½®
        ],
    })
);
```

**æµç¨‹:** ç½‘ç»œ â†’ ç¼“å­˜  
**é€‚ç”¨:** API è¯·æ±‚, HTML é¡µé¢

#### CacheOnly (ä»…ç¼“å­˜)

```javascript
import { CacheOnly } from "workbox-strategies";

registerRoute(
    "/offline.html",
    new CacheOnly({
        cacheName: "offline-cache",
    })
);
```

**æµç¨‹:** ä»…ç¼“å­˜  
**é€‚ç”¨:** ç¦»çº¿é¡µé¢, å¿…é¡»é¢„ç¼“å­˜çš„èµ„æº

#### NetworkOnly (ä»…ç½‘ç»œ)

```javascript
import { NetworkOnly } from "workbox-strategies";

registerRoute(({ url }) => url.pathname.startsWith("/admin/"), new NetworkOnly());
```

**æµç¨‹:** ä»…ç½‘ç»œ  
**é€‚ç”¨:** å®æ—¶æ•°æ®, æ•æ„Ÿä¿¡æ¯

#### StaleWhileRevalidate (ç¼“å­˜åŒæ—¶æ›´æ–°)

```javascript
import { StaleWhileRevalidate } from "workbox-strategies";

registerRoute(
    ({ request }) => request.destination === "script",
    new StaleWhileRevalidate({
        cacheName: "js-cache",
    })
);
```

**æµç¨‹:** è¿”å›ç¼“å­˜, åŒæ—¶è¯·æ±‚ç½‘ç»œæ›´æ–°ç¼“å­˜  
**é€‚ç”¨:** éœ€è¦å¿«é€Ÿå“åº”ä½†ä¹Ÿè¦ä¿æŒæ›´æ–°çš„èµ„æº

### 3. workbox-precaching (é¢„ç¼“å­˜)

åœ¨ Service Worker å®‰è£…æ—¶é¢„å…ˆç¼“å­˜å…³é”®èµ„æº.

```javascript
import { precacheAndRoute } from "workbox-precaching";

// __WB_MANIFEST ä¼šåœ¨æ„å»ºæ—¶è¢«æ›¿æ¢ä¸ºèµ„æºæ¸…å•
precacheAndRoute(self.__WB_MANIFEST);

// æˆ–æ‰‹åŠ¨æŒ‡å®š
precacheAndRoute([
    { url: "/index.html", revision: "1.0.0" },
    { url: "/styles.css", revision: "2.1.3" },
    { url: "/app.js", revision: "1.5.2" },
]);
```

**ç‰¹ç‚¹:**

-   è‡ªåŠ¨ç”Ÿæˆèµ„æºç‰ˆæœ¬å· (åŸºäºæ–‡ä»¶å†…å®¹ hash)
-   å®‰è£…æ—¶ä¸‹è½½æ‰€æœ‰èµ„æº
-   æ›´æ–°æ—¶åªä¸‹è½½å˜åŒ–çš„æ–‡ä»¶
-   è‡ªåŠ¨æ¸…ç†æ—§ç‰ˆæœ¬ç¼“å­˜

### 4. workbox-expiration (ç¼“å­˜è¿‡æœŸ)

ç®¡ç†ç¼“å­˜çš„æ•°é‡å’Œæ—¶æ•ˆæ€§.

```javascript
import { ExpirationPlugin } from "workbox-expiration";
import { CacheFirst } from "workbox-strategies";
import { registerRoute } from "workbox-routing";

registerRoute(
    ({ request }) => request.destination === "image",
    new CacheFirst({
        cacheName: "images",
        plugins: [
            new ExpirationPlugin({
                maxEntries: 50, // æœ€å¤šç¼“å­˜ 50 å¼ å›¾ç‰‡
                maxAgeSeconds: 30 * 24 * 60 * 60, // 30 å¤©è¿‡æœŸ
                purgeOnQuotaError: true, // å­˜å‚¨ç©ºé—´ä¸è¶³æ—¶è‡ªåŠ¨æ¸…ç†
            }),
        ],
    })
);
```

### 5. workbox-background-sync (åå°åŒæ­¥)

åœ¨ç½‘ç»œæ¢å¤æ—¶é‡æ–°å‘é€å¤±è´¥çš„è¯·æ±‚.

```javascript
import { BackgroundSyncPlugin } from "workbox-background-sync";
import { NetworkOnly } from "workbox-strategies";
import { registerRoute } from "workbox-routing";

const bgSyncPlugin = new BackgroundSyncPlugin("api-queue", {
    maxRetentionTime: 24 * 60, // é‡è¯• 24 å°æ—¶
});

registerRoute(
    ({ url }) => url.pathname.startsWith("/api/"),
    new NetworkOnly({
        plugins: [bgSyncPlugin],
    }),
    "POST" // åªå¯¹ POST è¯·æ±‚ç”Ÿæ•ˆ
);
```

**åœºæ™¯:** ç”¨æˆ·æäº¤è¡¨å•æ—¶ç½‘ç»œæ–­å¼€, ç­‰ç½‘ç»œæ¢å¤åè‡ªåŠ¨é‡å‘

### 6. workbox-cacheable-response (å¯ç¼“å­˜å“åº”)

æ§åˆ¶å“ªäº›å“åº”å¯ä»¥è¢«ç¼“å­˜.

```javascript
import { CacheableResponsePlugin } from "workbox-cacheable-response";
import { NetworkFirst } from "workbox-strategies";

registerRoute(
    ({ url }) => url.pathname.startsWith("/api/"),
    new NetworkFirst({
        plugins: [
            new CacheableResponsePlugin({
                statuses: [0, 200], // åªç¼“å­˜çŠ¶æ€ç ä¸º 0 æˆ– 200 çš„å“åº”
                headers: {
                    "X-Is-Cacheable": "true", // å¿…é¡»åŒ…å«æ­¤å“åº”å¤´
                },
            }),
        ],
    })
);
```

### 7. workbox-range-requests (èŒƒå›´è¯·æ±‚)

æ”¯æŒ HTTP Range è¯·æ±‚ (ç”¨äºéŸ³è§†é¢‘çš„åˆ†æ®µåŠ è½½).

```javascript
import { RangeRequestsPlugin } from "workbox-range-requests";
import { CacheFirst } from "workbox-strategies";

registerRoute(
    ({ request }) => request.destination === "video",
    new CacheFirst({
        plugins: [new RangeRequestsPlugin()],
    })
);
```

<br>

## ä½¿ç”¨æ–¹å¼

Workbox æä¾›ä¸‰ç§ä½¿ç”¨æ–¹å¼, é€‚åº”ä¸åŒçš„é¡¹ç›®éœ€æ±‚:

### æ–¹å¼ä¸€: CDN å¼•å…¥ (å¿«é€Ÿå¼€å§‹)

é€‚åˆå°å‹é¡¹ç›®æˆ–å¿«é€ŸåŸå‹.

```javascript
// sw.js
importScripts("https://storage.googleapis.com/workbox-cdn/releases/7.0.0/workbox-sw.js");

if (workbox) {
    console.log("Workbox åŠ è½½æˆåŠŸ");

    // é¢„ç¼“å­˜
    workbox.precaching.precacheAndRoute([
        { url: "/index.html", revision: "1.0" },
        { url: "/styles.css", revision: "1.0" },
    ]);

    // å›¾ç‰‡ç¼“å­˜ä¼˜å…ˆ
    workbox.routing.registerRoute(
        ({ request }) => request.destination === "image",
        new workbox.strategies.CacheFirst({
            cacheName: "images",
            plugins: [
                new workbox.expiration.ExpirationPlugin({
                    maxEntries: 60,
                    maxAgeSeconds: 30 * 24 * 60 * 60,
                }),
            ],
        })
    );

    // API ç½‘ç»œä¼˜å…ˆ
    workbox.routing.registerRoute(
        ({ url }) => url.pathname.startsWith("/api/"),
        new workbox.strategies.NetworkFirst({
            cacheName: "api",
        })
    );
} else {
    console.log("Workbox åŠ è½½å¤±è´¥");
}
```

**ä¼˜ç‚¹:** ç®€å•å¿«é€Ÿ, æ— éœ€æ„å»º  
**ç¼ºç‚¹:** éœ€è¦ç½‘ç»œåŠ è½½ Workbox, æ— æ³•ä½¿ç”¨æ„å»ºæ—¶ç‰¹æ€§

### æ–¹å¼äºŒ: npm åŒ… + æ‰‹å†™ Service Worker

é€‚åˆéœ€è¦ç²¾ç»†æ§åˆ¶çš„é¡¹ç›®.

**1. å®‰è£…ä¾èµ–**

```bash
npm install workbox-routing workbox-strategies workbox-precaching
```

**2. ç¼–å†™ Service Worker**

```javascript
// sw.js
import { precacheAndRoute } from "workbox-precaching";
import { registerRoute } from "workbox-routing";
import { CacheFirst, NetworkFirst, StaleWhileRevalidate } from "workbox-strategies";
import { ExpirationPlugin } from "workbox-expiration";
import { CacheableResponsePlugin } from "workbox-cacheable-response";

// é¢„ç¼“å­˜ (æ„å»ºå·¥å…·ä¼šè‡ªåŠ¨æ³¨å…¥èµ„æºæ¸…å•)
precacheAndRoute(self.__WB_MANIFEST);

// é™æ€èµ„æº: ç¼“å­˜ä¼˜å…ˆ
registerRoute(
    ({ request }) => ["style", "script", "font"].includes(request.destination),
    new CacheFirst({
        cacheName: "static-resources",
        plugins: [
            new CacheableResponsePlugin({ statuses: [0, 200] }),
            new ExpirationPlugin({
                maxEntries: 100,
                maxAgeSeconds: 7 * 24 * 60 * 60, // 7 å¤©
            }),
        ],
    })
);

// å›¾ç‰‡: ç¼“å­˜åŒæ—¶æ›´æ–°
registerRoute(
    ({ request }) => request.destination === "image",
    new StaleWhileRevalidate({
        cacheName: "images",
        plugins: [
            new ExpirationPlugin({
                maxEntries: 50,
                maxAgeSeconds: 30 * 24 * 60 * 60, // 30 å¤©
            }),
        ],
    })
);

// API: ç½‘ç»œä¼˜å…ˆ
registerRoute(
    ({ url }) => url.pathname.startsWith("/api/"),
    new NetworkFirst({
        cacheName: "api-cache",
        networkTimeoutSeconds: 5,
        plugins: [
            new CacheableResponsePlugin({
                statuses: [0, 200],
            }),
        ],
    })
);

// è·¨åŸŸè¯·æ±‚: ç½‘ç»œä¼˜å…ˆ
registerRoute(
    ({ url }) => url.origin !== self.location.origin,
    new NetworkFirst({
        cacheName: "cross-origin",
        plugins: [
            new CacheableResponsePlugin({
                statuses: [0, 200],
            }),
        ],
    })
);
```

**3. æ³¨å†Œ Service Worker**

```javascript
// main.js
if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
        navigator.serviceWorker.register("/sw.js");
    });
}
```

### æ–¹å¼ä¸‰: Webpack/Vite æ’ä»¶ (æ¨è)

é€‚åˆç°ä»£å‰ç«¯é¡¹ç›®, è‡ªåŠ¨ç”Ÿæˆ Service Worker.

#### Vite + vite-plugin-pwa

**1. å®‰è£…æ’ä»¶**

```bash
npm install -D vite-plugin-pwa
```

**2. é…ç½® vite.config.js**

```javascript
import { defineConfig } from "vite";
import { VitePWA } from "vite-plugin-pwa";

export default defineConfig({
    plugins: [
        VitePWA({
            registerType: "autoUpdate", // è‡ªåŠ¨æ›´æ–°
            includeAssets: ["favicon.ico", "robots.txt", "apple-touch-icon.png"],

            manifest: {
                name: "My App",
                short_name: "App",
                description: "My awesome app",
                theme_color: "#ffffff",
                icons: [
                    {
                        src: "pwa-192x192.png",
                        sizes: "192x192",
                        type: "image/png",
                    },
                    {
                        src: "pwa-512x512.png",
                        sizes: "512x512",
                        type: "image/png",
                    },
                ],
            },

            workbox: {
                // Workbox é…ç½®
                globPatterns: ["**/*.{js,css,html,ico,png,svg}"], // éœ€è¦é¢„ç¼“å­˜çš„æ–‡ä»¶

                runtimeCaching: [
                    // å›¾ç‰‡ç¼“å­˜
                    {
                        urlPattern: /\.(?:png|jpg|jpeg|svg|gif|webp)$/,
                        handler: "CacheFirst",
                        options: {
                            cacheName: "images",
                            expiration: {
                                maxEntries: 50,
                                maxAgeSeconds: 30 * 24 * 60 * 60,
                            },
                        },
                    },

                    // API ç¼“å­˜
                    {
                        urlPattern: /^https:\/\/api\.example\.com\/.*/,
                        handler: "NetworkFirst",
                        options: {
                            cacheName: "api",
                            networkTimeoutSeconds: 5,
                            expiration: {
                                maxEntries: 100,
                                maxAgeSeconds: 24 * 60 * 60,
                            },
                            cacheableResponse: {
                                statuses: [0, 200],
                            },
                        },
                    },

                    // å­—ä½“ç¼“å­˜
                    {
                        urlPattern: /^https:\/\/fonts\.googleapis\.com\/.*/,
                        handler: "StaleWhileRevalidate",
                        options: {
                            cacheName: "google-fonts",
                        },
                    },
                ],
            },
        }),
    ],
});
```

**3. åœ¨åº”ç”¨ä¸­ä½¿ç”¨**

```javascript
// main.js
import { registerSW } from "virtual:pwa-register";

// è‡ªåŠ¨æ›´æ–°
const updateSW = registerSW({
    onNeedRefresh() {
        // æœ‰æ–°ç‰ˆæœ¬æ—¶çš„å›è°ƒ
        if (confirm("å‘ç°æ–°ç‰ˆæœ¬, æ˜¯å¦ç«‹å³æ›´æ–°?")) {
            updateSW(true);
        }
    },
    onOfflineReady() {
        console.log("åº”ç”¨å·²å¯ç¦»çº¿ä½¿ç”¨");
    },
});
```

#### Webpack + workbox-webpack-plugin

**1. å®‰è£…æ’ä»¶**

```bash
npm install -D workbox-webpack-plugin
```

**2. é…ç½® webpack.config.js**

```javascript
const { GenerateSW } = require("workbox-webpack-plugin");

module.exports = {
    // ... å…¶ä»–é…ç½®

    plugins: [
        new GenerateSW({
            clientsClaim: true, // ç«‹å³æ¥ç®¡é¡µé¢
            skipWaiting: true, // è·³è¿‡ç­‰å¾…

            // é¢„ç¼“å­˜
            include: [/\.html$/, /\.js$/, /\.css$/],
            exclude: [/\.map$/, /^manifest.*\.js$/],

            // è¿è¡Œæ—¶ç¼“å­˜
            runtimeCaching: [
                {
                    urlPattern: /\.(?:png|jpg|jpeg|svg)$/,
                    handler: "CacheFirst",
                    options: {
                        cacheName: "images",
                        expiration: {
                            maxEntries: 60,
                            maxAgeSeconds: 30 * 24 * 60 * 60,
                        },
                    },
                },
                {
                    urlPattern: /^https:\/\/api\.example\.com\/.*/,
                    handler: "NetworkFirst",
                    options: {
                        cacheName: "api",
                        networkTimeoutSeconds: 3,
                    },
                },
            ],
        }),
    ],
};
```

<br>

## å®Œæ•´å®æˆ˜æ¡ˆä¾‹

### åœºæ™¯: åšå®¢ç½‘ç«™ PWA æ”¹é€ 

**éœ€æ±‚:**

-   ç¦»çº¿è®¿é—®æ–‡ç« 
-   å¿«é€ŸåŠ è½½å›¾ç‰‡
-   API æ•°æ®ç½‘ç»œä¼˜å…ˆ
-   è‡ªåŠ¨æ›´æ–°

**1. é¡¹ç›®ç»“æ„**

```
project/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.js
â”‚   â”œâ”€â”€ App.vue
â”‚   â””â”€â”€ ...
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ manifest.json
â”‚   â””â”€â”€ offline.html
â”œâ”€â”€ vite.config.js
â””â”€â”€ package.json
```

**2. å®‰è£…ä¾èµ–**

```bash
npm install -D vite-plugin-pwa
```

**3. é…ç½® vite.config.js**

```javascript
import { defineConfig } from "vite";
import vue from "@vitejs/plugin-vue";
import { VitePWA } from "vite-plugin-pwa";

export default defineConfig({
    plugins: [
        vue(),
        VitePWA({
            registerType: "autoUpdate",

            // PWA é…ç½®æ¸…å•
            manifest: {
                name: "My Blog",
                short_name: "Blog",
                description: "A beautiful blog powered by PWA",
                theme_color: "#42b983",
                background_color: "#ffffff",
                display: "standalone",
                start_url: "/",
                icons: [
                    {
                        src: "/icon-192.png",
                        sizes: "192x192",
                        type: "image/png",
                    },
                    {
                        src: "/icon-512.png",
                        sizes: "512x512",
                        type: "image/png",
                        purpose: "any maskable",
                    },
                ],
            },

            // Workbox é…ç½®
            workbox: {
                // é¢„ç¼“å­˜æ–‡ä»¶
                globPatterns: ["**/*.{js,css,html,ico,png,svg,woff2}"],

                // è¿è¡Œæ—¶ç¼“å­˜
                runtimeCaching: [
                    // æ–‡ç« é¡µé¢: ç½‘ç»œä¼˜å…ˆ, 5 ç§’è¶…æ—¶
                    {
                        urlPattern: /^https:\/\/blog\.example\.com\/posts\/.*/,
                        handler: "NetworkFirst",
                        options: {
                            cacheName: "posts",
                            networkTimeoutSeconds: 5,
                            expiration: {
                                maxEntries: 50,
                                maxAgeSeconds: 7 * 24 * 60 * 60, // 7 å¤©
                            },
                            cacheableResponse: {
                                statuses: [0, 200],
                            },
                        },
                    },

                    // å›¾ç‰‡: ç¼“å­˜åŒæ—¶æ›´æ–°
                    {
                        urlPattern: /\.(?:png|jpg|jpeg|svg|gif|webp)$/,
                        handler: "StaleWhileRevalidate",
                        options: {
                            cacheName: "images",
                            expiration: {
                                maxEntries: 100,
                                maxAgeSeconds: 30 * 24 * 60 * 60, // 30 å¤©
                            },
                        },
                    },

                    // CDN èµ„æº: ç¼“å­˜ä¼˜å…ˆ
                    {
                        urlPattern: /^https:\/\/cdn\.jsdelivr\.net\/.*/,
                        handler: "CacheFirst",
                        options: {
                            cacheName: "cdn",
                            expiration: {
                                maxEntries: 50,
                                maxAgeSeconds: 365 * 24 * 60 * 60, // 1 å¹´
                            },
                            cacheableResponse: {
                                statuses: [0, 200],
                            },
                        },
                    },

                    // API: ç½‘ç»œä¼˜å…ˆ
                    {
                        urlPattern: /^https:\/\/api\.example\.com\/.*/,
                        handler: "NetworkFirst",
                        options: {
                            cacheName: "api",
                            networkTimeoutSeconds: 3,
                            expiration: {
                                maxEntries: 100,
                                maxAgeSeconds: 24 * 60 * 60, // 1 å¤©
                            },
                            cacheableResponse: {
                                statuses: [0, 200],
                            },
                        },
                    },
                ],

                // å¯¼èˆªå›é€€ (ç¦»çº¿æ—¶æ˜¾ç¤º)
                navigateFallback: "/offline.html",
                navigateFallbackDenylist: [/^\/api\//], // API è¯·æ±‚ä¸ä½¿ç”¨å›é€€
            },

            // å¼€å‘é€‰é¡¹
            devOptions: {
                enabled: false, // å¼€å‘ç¯å¢ƒä¸å¯ç”¨
                type: "module",
            },
        }),
    ],
});
```

**4. åœ¨åº”ç”¨ä¸­æ³¨å†Œ**

```javascript
// main.js
import { createApp } from "vue";
import App from "./App.vue";
import { registerSW } from "virtual:pwa-register";

const app = createApp(App);

// æ³¨å†Œ Service Worker
const updateSW = registerSW({
    immediate: true,

    onNeedRefresh() {
        // æ˜¾ç¤ºæ›´æ–°æç¤º
        const result = confirm("å‘ç°æ–°ç‰ˆæœ¬, æ˜¯å¦ç«‹å³æ›´æ–°? (å°†åˆ·æ–°é¡µé¢)");
        if (result) {
            updateSW(true); // æ›´æ–°å¹¶åˆ·æ–°
        }
    },

    onOfflineReady() {
        console.log("åº”ç”¨å·²å¯ç¦»çº¿è®¿é—®");
        // å¯ä»¥æ˜¾ç¤ºä¸€ä¸ªæç¤º
    },

    onRegistered(registration) {
        console.log("Service Worker æ³¨å†ŒæˆåŠŸ");

        // æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡æ›´æ–°
        setInterval(() => {
            registration.update();
        }, 60 * 60 * 1000);
    },

    onRegisterError(error) {
        console.error("Service Worker æ³¨å†Œå¤±è´¥:", error);
    },
});

app.mount("#app");
```

**5. åˆ›å»ºç¦»çº¿é¡µé¢**

```html
<!-- public/offline.html -->
<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ç¦»çº¿æ¨¡å¼</title>
        <style>
            body {
                display: flex;
                align-items: center;
                justify-content: center;
                height: 100vh;
                margin: 0;
                font-family: system-ui, -apple-system, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
            }
            .container {
                text-align: center;
                padding: 2rem;
            }
            h1 {
                font-size: 3rem;
                margin: 0 0 1rem;
            }
            p {
                font-size: 1.2rem;
                opacity: 0.9;
            }
            button {
                margin-top: 2rem;
                padding: 1rem 2rem;
                font-size: 1rem;
                background: white;
                color: #667eea;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                transition: transform 0.2s;
            }
            button:hover {
                transform: scale(1.05);
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>ğŸ“¡</h1>
            <h1>ç½‘ç»œè¿æ¥å·²æ–­å¼€</h1>
            <p>è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥åé‡è¯•</p>
            <button onclick="location.reload()">é‡æ–°åŠ è½½</button>
        </div>
    </body>
</html>
```

**6. æ„å»ºå¹¶æµ‹è¯•**

```bash
# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build

# é¢„è§ˆ (æµ‹è¯• Service Worker)
npm run preview
```

**æµ‹è¯•æ­¥éª¤:**

1. è®¿é—®ç½‘ç«™, ç­‰å¾… Service Worker æ³¨å†Œ
2. æ‰“å¼€ DevTools â†’ Application â†’ Service Workers, ç¡®è®¤å·²æ¿€æ´»
3. å‹¾é€‰ "Offline" æ¨¡æ‹Ÿç¦»çº¿ç¯å¢ƒ
4. åˆ·æ–°é¡µé¢, åº”è¯¥èƒ½æ­£å¸¸è®¿é—®
5. è®¿é—®æœªç¼“å­˜çš„é¡µé¢, åº”è¯¥æ˜¾ç¤ºç¦»çº¿é¡µé¢

<br>

## é«˜çº§ç‰¹æ€§

### 1. è‡ªå®šä¹‰æ’ä»¶

```javascript
import { registerRoute } from "workbox-routing";
import { NetworkFirst } from "workbox-strategies";

// è‡ªå®šä¹‰æ’ä»¶: æ·»åŠ è‡ªå®šä¹‰å“åº”å¤´
class CustomHeaderPlugin {
    requestWillFetch({ request }) {
        const headers = new Headers(request.headers);
        headers.set("X-Custom-Header", "Workbox");

        return new Request(request, { headers });
    }

    cachedResponseWillBeUsed({ cachedResponse }) {
        if (cachedResponse) {
            console.log("ä½¿ç”¨ç¼“å­˜å“åº”");
        }
        return cachedResponse;
    }
}

registerRoute(
    ({ url }) => url.pathname.startsWith("/api/"),
    new NetworkFirst({
        plugins: [new CustomHeaderPlugin()],
    })
);
```

### 2. æ¶ˆæ¯é€šä¿¡

**Service Worker å‘é¡µé¢å‘é€æ¶ˆæ¯:**

```javascript
// sw.js
import { clientsClaim } from "workbox-core";

self.addEventListener("activate", (event) => {
    event.waitUntil(
        (async () => {
            clientsClaim();

            // é€šçŸ¥æ‰€æœ‰å®¢æˆ·ç«¯
            const clients = await self.clients.matchAll();
            clients.forEach((client) => {
                client.postMessage({
                    type: "CACHE_UPDATED",
                    message: "ç¼“å­˜å·²æ›´æ–°",
                });
            });
        })()
    );
});
```

**é¡µé¢æ¥æ”¶æ¶ˆæ¯:**

```javascript
// main.js
navigator.serviceWorker.addEventListener("message", (event) => {
    if (event.data.type === "CACHE_UPDATED") {
        console.log(event.data.message);
        // æ˜¾ç¤ºæç¤ºæˆ–æ›´æ–° UI
    }
});
```

**é¡µé¢å‘ Service Worker å‘é€æ¶ˆæ¯:**

```javascript
// main.js
navigator.serviceWorker.ready.then((registration) => {
    registration.active.postMessage({
        type: "CLEAR_CACHE",
        cacheName: "images",
    });
});

// sw.js
self.addEventListener("message", (event) => {
    if (event.data.type === "CLEAR_CACHE") {
        caches.delete(event.data.cacheName);
    }
});
```

### 3. é¢„åŠ è½½å¯¼èˆªè¯·æ±‚

```javascript
import { NavigationRoute, registerRoute } from "workbox-routing";
import { NetworkFirst } from "workbox-strategies";

// å¯¹å¯¼èˆªè¯·æ±‚ä½¿ç”¨ç‰¹æ®Šå¤„ç†
const navigationRoute = new NavigationRoute(
    new NetworkFirst({
        cacheName: "navigations",
        networkTimeoutSeconds: 3,
    }),
    {
        // æ’é™¤æŸäº›è·¯å¾„
        denylist: [/^\/admin/, /^\/api/],
    }
);

registerRoute(navigationRoute);
```

### 4. æ¡ä»¶ç¼“å­˜

```javascript
import { registerRoute } from "workbox-routing";
import { NetworkFirst } from "workbox-strategies";

registerRoute(({ request, url }) => {
    // åªç¼“å­˜ GET è¯·æ±‚
    if (request.method !== "GET") {
        return false;
    }

    // åªç¼“å­˜åŒæºè¯·æ±‚
    if (url.origin !== self.location.origin) {
        return false;
    }

    // æ’é™¤æŸäº›è·¯å¾„
    if (url.pathname.startsWith("/admin")) {
        return false;
    }

    return true;
}, new NetworkFirst());
```

<br>

## è°ƒè¯•æŠ€å·§

### 1. å¼€å¯è°ƒè¯•æ—¥å¿—

```javascript
// sw.js
import { setLogLevel } from "workbox-core";

// å¼€å‘ç¯å¢ƒå¼€å¯è¯¦ç»†æ—¥å¿—
if (process.env.NODE_ENV === "development") {
    setLogLevel("debug");
} else {
    setLogLevel("warn");
}
```

### 2. Chrome DevTools

**Application â†’ Service Workers:**

-   æŸ¥çœ‹ Service Worker çŠ¶æ€
-   æ‰‹åŠ¨æ›´æ–°
-   æ³¨é”€ Service Worker
-   æ¨¡æ‹Ÿç¦»çº¿ç¯å¢ƒ

**Application â†’ Cache Storage:**

-   æŸ¥çœ‹æ‰€æœ‰ç¼“å­˜å†…å®¹
-   æ‰‹åŠ¨åˆ é™¤ç¼“å­˜
-   æ£€æŸ¥é¢„ç¼“å­˜æ¸…å•

**Network é¢æ¿:**

-   ç­›é€‰ "Service Worker" æŸ¥çœ‹è¢«æ‹¦æˆªçš„è¯·æ±‚
-   æŸ¥çœ‹èµ„æºæ¥æº (from ServiceWorker)

### 3. å¸¸ç”¨è°ƒè¯•ä»£ç 

```javascript
// æŸ¥çœ‹æ‰€æœ‰ç¼“å­˜
caches.keys().then(console.log);

// æŸ¥çœ‹æŒ‡å®šç¼“å­˜çš„å†…å®¹
caches.open("images").then((cache) => {
    cache.keys().then(console.log);
});

// æ‰‹åŠ¨æ¸…é™¤æ‰€æœ‰ç¼“å­˜
caches.keys().then((keys) => {
    keys.forEach((key) => caches.delete(key));
});

// è·å–å½“å‰ Service Worker
navigator.serviceWorker.getRegistration().then(console.log);

// æ‰‹åŠ¨è§¦å‘æ›´æ–°
navigator.serviceWorker.getRegistration().then((reg) => {
    reg.update();
});
```

<br>

## æ€§èƒ½ä¼˜åŒ–

### 1. æŒ‰éœ€é¢„ç¼“å­˜

```javascript
// åªé¢„ç¼“å­˜æ ¸å¿ƒèµ„æº
import { precacheAndRoute } from "workbox-precaching";

const criticalAssets = self.__WB_MANIFEST.filter((asset) => {
    // åªé¢„ç¼“å­˜ HTML, CSS å’Œæ ¸å¿ƒ JS
    return /\.(html|css)$/.test(asset.url) || asset.url.includes("main.js") || asset.url.includes("vendor.js");
});

precacheAndRoute(criticalAssets);
```

### 2. åˆ†çº§ç¼“å­˜ç­–ç•¥

```javascript
// ä¸åŒèµ„æºä½¿ç”¨ä¸åŒçš„ç¼“å­˜æ—¶é•¿
import { ExpirationPlugin } from "workbox-expiration";

// é•¿æœŸç¼“å­˜: ä¸å˜çš„èµ„æº (å¸¦ hash çš„æ–‡ä»¶)
registerRoute(
    /\.[\da-f]{8}\.(js|css)$/,
    new CacheFirst({
        cacheName: "immutable",
        plugins: [
            new ExpirationPlugin({
                maxAgeSeconds: 365 * 24 * 60 * 60, // 1 å¹´
            }),
        ],
    })
);

// çŸ­æœŸç¼“å­˜: å¯èƒ½å˜åŒ–çš„èµ„æº
registerRoute(
    /\.(?:png|jpg)$/,
    new StaleWhileRevalidate({
        cacheName: "images",
        plugins: [
            new ExpirationPlugin({
                maxAgeSeconds: 7 * 24 * 60 * 60, // 7 å¤©
                maxEntries: 50,
            }),
        ],
    })
);
```

### 3. æ™ºèƒ½æ›´æ–°æ£€æµ‹

```javascript
// main.js
import { registerSW } from "virtual:pwa-register";

const updateSW = registerSW({
    onRegistered(registration) {
        // éæ´»è·ƒæ—¶æ‰æ£€æŸ¥æ›´æ–° (é¿å…å½±å“ç”¨æˆ·ä½“éªŒ)
        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === "hidden") {
                registration.update();
            }
        });

        // æ¯ 6 å°æ—¶æ£€æŸ¥ä¸€æ¬¡
        setInterval(() => {
            registration.update();
        }, 6 * 60 * 60 * 1000);
    },
});
```

<br>

## å¸¸è§é—®é¢˜

### 1. é¢„ç¼“å­˜æ–‡ä»¶è¿‡å¤šå¯¼è‡´å®‰è£…ç¼“æ…¢

**é—®é¢˜:** é¢„ç¼“å­˜äº†å‡ ç™¾ä¸ªæ–‡ä»¶, Service Worker å®‰è£…éœ€è¦å¾ˆé•¿æ—¶é—´

**è§£å†³æ–¹æ¡ˆ:**

```javascript
// åªé¢„ç¼“å­˜æ ¸å¿ƒèµ„æº
workbox: {
    globPatterns: [
        '**/*.{html,css}',
        '**/main.*.js',
        '**/vendor.*.js',
    ],
    // å…¶ä»–èµ„æºä½¿ç”¨è¿è¡Œæ—¶ç¼“å­˜
}
```

### 2. Service Worker æ›´æ–°ä¸åŠæ—¶

**é—®é¢˜:** ä¿®æ”¹äº†ä»£ç ä½†ç”¨æˆ·çœ‹ä¸åˆ°æœ€æ–°ç‰ˆæœ¬

**è§£å†³æ–¹æ¡ˆ:**

```javascript
// é…ç½® Service Worker æ–‡ä»¶ä¸ç¼“å­˜
// vite.config.js
workbox: {
    clientsClaim: true,
    skipWaiting: true,
}

// æœåŠ¡å™¨å“åº”å¤´
// Cache-Control: no-cache (é’ˆå¯¹ sw.js)
```

### 3. å¼€å‘ç¯å¢ƒå—ç¼“å­˜å½±å“

**é—®é¢˜:** å¼€å‘æ—¶ç¼“å­˜å¯¼è‡´æ— æ³•çœ‹åˆ°æœ€æ–°ä¿®æ”¹

**è§£å†³æ–¹æ¡ˆ:**

```javascript
// vite.config.js
VitePWA({
    devOptions: {
        enabled: false, // å¼€å‘ç¯å¢ƒç¦ç”¨
    },
});

// æˆ–åœ¨ DevTools ä¸­å‹¾é€‰ "Bypass for network"
```

### 4. ç¼“å­˜å ç”¨ç©ºé—´è¿‡å¤§

**é—®é¢˜:** ç¼“å­˜æ–‡ä»¶è¶Šæ¥è¶Šå¤š, å ç”¨å¤§é‡å­˜å‚¨ç©ºé—´

**è§£å†³æ–¹æ¡ˆ:**

```javascript
import { ExpirationPlugin } from "workbox-expiration";

new ExpirationPlugin({
    maxEntries: 50, // é™åˆ¶æ•°é‡
    maxAgeSeconds: 30 * 24 * 60 * 60, // é™åˆ¶æ—¶é—´
    purgeOnQuotaError: true, // ç©ºé—´ä¸è¶³æ—¶è‡ªåŠ¨æ¸…ç†
});
```

<br>

## æœ€ä½³å®è·µ

1. **æ¸è¿›å¢å¼º**: ç¡®ä¿ä¸æ”¯æŒ Service Worker çš„æµè§ˆå™¨ä¹Ÿèƒ½æ­£å¸¸ä½¿ç”¨
2. **åˆç†é¢„ç¼“å­˜**: åªé¢„ç¼“å­˜å¿…è¦çš„æ ¸å¿ƒèµ„æº, å…¶ä»–èµ„æºä½¿ç”¨è¿è¡Œæ—¶ç¼“å­˜
3. **ç‰ˆæœ¬æ§åˆ¶**: ä½¿ç”¨æ–‡ä»¶ hash ç¡®ä¿ç¼“å­˜å¤±æ•ˆæœºåˆ¶æ­£ç¡®
4. **åŠæ—¶æ›´æ–°**: å®šæœŸæ£€æŸ¥æ›´æ–°, ä½†é¿å…å½±å“ç”¨æˆ·ä½“éªŒ
5. **é”™è¯¯å¤„ç†**: ä¸ºæ‰€æœ‰ç­–ç•¥æ·»åŠ å›é€€æ–¹æ¡ˆ
6. **æ€§èƒ½ç›‘æ§**: è®°å½•ç¼“å­˜å‘½ä¸­ç‡, æŒç»­ä¼˜åŒ–
7. **ç”¨æˆ·æç¤º**: æœ‰æ–°ç‰ˆæœ¬æ—¶å‹å¥½åœ°æç¤ºç”¨æˆ·
8. **æµ‹è¯•è¦†ç›–**: æµ‹è¯•ç¦»çº¿åœºæ™¯, ç½‘ç»œä¸ç¨³å®šåœºæ™¯

<br>

## ä¸åŸç”Ÿ Service Worker å¯¹æ¯”

| ç‰¹æ€§     | åŸç”Ÿ Service Worker    | Workbox                |
| -------- | ---------------------- | ---------------------- |
| å­¦ä¹ æ›²çº¿ | é™¡å³­, éœ€è¦ç†è§£åº•å±‚ API | å¹³ç¼“, é«˜çº§ API æ˜“ç”¨    |
| ä»£ç é‡   | å¤§é‡æ ·æ¿ä»£ç            | ç®€æ´æ¸…æ™°               |
| é¢„ç¼“å­˜   | æ‰‹åŠ¨ç®¡ç†æ–‡ä»¶æ¸…å•       | è‡ªåŠ¨ç”Ÿæˆ, è‡ªåŠ¨ç‰ˆæœ¬æ§åˆ¶ |
| ç¼“å­˜ç­–ç•¥ | æ‰‹åŠ¨å®ç°               | å¼€ç®±å³ç”¨çš„ 5 ç§ç­–ç•¥    |
| æ’ä»¶ç³»ç»Ÿ | æ—                      | ä¸°å¯Œçš„æ’ä»¶ç”Ÿæ€         |
| æ„å»ºé›†æˆ | éœ€è‡ªè¡Œå¤„ç†             | ä¸ä¸»æµæ„å»ºå·¥å…·æ— ç¼é›†æˆ |
| è°ƒè¯•     | å¤æ‚                   | å†…ç½®æ—¥å¿—å’Œè°ƒè¯•å·¥å…·     |
| ç»´æŠ¤æ€§   | éš¾ä»¥ç»´æŠ¤               | ç»“æ„æ¸…æ™°, æ˜“äºç»´æŠ¤     |

<br>

## æµè§ˆå™¨å…¼å®¹æ€§

Workbox æ”¯æŒæ‰€æœ‰æ”¯æŒ Service Worker çš„æµè§ˆå™¨:

-   Chrome 40+
-   Firefox 44+
-   Safari 11.1+
-   Edge 17+
-   Opera 27+

**æ³¨æ„:** éƒ¨åˆ†é«˜çº§ç‰¹æ€§ (å¦‚ Background Sync) çš„æ”¯æŒæƒ…å†µå¯èƒ½ä¸åŒ

<br>

## å‚è€ƒèµ„æ–™

-   [Workbox å®˜æ–¹æ–‡æ¡£](https://developer.chrome.com/docs/workbox)
-   [vite-plugin-pwa æ–‡æ¡£](https://vite-pwa-org.netlify.app/)
-   [PWA æœ€ä½³å®è·µ](https://web.dev/progressive-web-apps/)
-   [Service Worker Cookbook](https://serviceworke.rs/)
