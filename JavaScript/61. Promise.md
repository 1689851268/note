# Promise çš„ä½¿ç”¨

Promise å®ä¾‹æœ‰ 2 ä¸ªé˜¶æ®µã€3 ä¸ªçŠ¶æ€:

1.  æœªå†³é˜¶æ®µ (unsettled) : æŒ‚èµ·çŠ¶æ€ pending
2.  å·²å†³é˜¶æ®µ (settled) : å®ŒæˆçŠ¶æ€ fulfilledã€å¤±è´¥çŠ¶æ€ rejected

<br>

ä½¿ç”¨ Promise API: `new Promise(executor)`

å‚æ•° `executor` ç§°ä¸ºæ‰§è¡Œå™¨, æ˜¯ä¸€ä¸ªå‡½æ•° `(resolve, reject) => {}`:

1.  è°ƒç”¨ `resolve`, Promise å®ä¾‹çš„çŠ¶æ€ä¼šä» pending å˜ä¸º fulfilled
2.  è°ƒç”¨ `reject`, Promise å®ä¾‹çš„çŠ¶æ€ä¼šä» pending å˜ä¸º rejected

å¦‚æœä¸è°ƒç”¨ `resolve` / `reject`, åˆ™ Promise å®ä¾‹çš„çŠ¶æ€å°†ä¸€ç›´æ˜¯ pending.

```js
const pro1 = new Promise(() => {});
console.log(pro1); //  PromiseÂ { <pending> }

const pro2 = new Promise((resolve) => resolve());
console.log(pro2); //  PromiseÂ { <fulfilled>: undefined }

const pro3 = new Promise((_, reject) => reject());
console.log(pro3); //  PromiseÂ { <rejected>: undefined }
```

<br>

è°ƒç”¨ `resolve` / `reject` æ—¶, å¯ä¼ å…¥ 1 ä¸ªå‚æ•°ä½œä¸ºè¯¥ Promise å®ä¾‹çš„å€¼:

```js
const pro1 = new Promise((resolve) => resolve("value"));
console.log(pro1); // PromiseÂ { <fulfilled>: 'value' }

const pro2 = new Promise((_, reject) => reject("reason"));
console.log(pro2); // PromiseÂ { <rejected>: 'reason' }
```

<br>

æŠ›å‡ºé”™è¯¯, Promise å®ä¾‹çš„çŠ¶æ€ä¹Ÿä¼šä» pending å˜ä¸º rejected:

```js
const pro = new Promise(() => {
    throw "error";
});
console.log(pro); // PromiseÂ { <rejected>: 'error' }
```

<br>

çŠ¶æ€åªèƒ½ä» pending å˜ä¸º fulfilled / rejected, ä¸”çŠ¶æ€ä¸€æ—¦æ”¹å˜å°±ä¸ä¼šå†è¢«æ›´æ–°:

```js
const pro = new Promise((resolve) => {
    resolve("ok");
    throw "error"; // åé¢çš„ throw æ— æ•ˆ
});
console.log(pro); // PromiseÂ { <fulfilled>: ok }
```

<br><br>

# then & catch & finally

`new Promise(executor)` ä¸­çš„æ‰§è¡Œå™¨ `executor` æ˜¯**åŒæ­¥**æ‰§è¡Œçš„, ä½† Promise.prototype ä¸Šçš„æ–¹æ³• `then` & `catch` & `finally` ä¸­çš„å›è°ƒå‡½æ•°æ˜¯**å¼‚æ­¥**æ‰§è¡Œçš„, å±äºå¼‚æ­¥ä»»åŠ¡é‡Œé¢çš„**å¾®ä»»åŠ¡**.

```js
console.log("before executor");

new Promise((resolve) => {
    resolve();
    console.log("executor");
}).then(() => {
    console.log("then");
});

console.log("after executor");
```

ä¸Šä¾‹è¾“å‡ºçš„é¡ºåº: `before executor` â†’ `executor` â†’ `after executor` â†’ `then`

<br>

## pro.then ( onResolve, onReject )

1. å›è°ƒå‡½æ•° `onResolve`: ç”¨äºå¤„ç† fulfilled çŠ¶æ€çš„ Promise å®ä¾‹

2. å›è°ƒå‡½æ•° `onReject`: ç”¨äºå¤„ç† rejected çŠ¶æ€çš„ Promise å®ä¾‹

`onReject` & `onResolve` éƒ½æ¥æ”¶ 1 ä¸ªå‚æ•°, å‚æ•°å€¼ä¸ºè°ƒç”¨è¯¥æ–¹æ³•çš„ Promise å®ä¾‹çš„å€¼:

```js
const pro1 = Promise.resolve("Fulfilled");
pro1.then((value) => {
    console.log("pro1", value); // pro1 Fulfilled
});

const pro2 = Promise.reject("Rejected");
pro2.then(null, (reason) => {
    console.log("pro2", reason); // pro2 Rejected
});
```

<br>

ğŸŒŸ `onResolve` & `onReject` ä¼šè¿”å›ä¸€ä¸ª**æ–°çš„** Promise å®ä¾‹:

```js
const proThen = Promise.resolve("Fulfilled").then((value) => {
    console.log("value", value); // value Fulfilled
    return Promise.reject("superman");
});

console.log("proThen", proThen); // proThen PromiseÂ {<pending>}
```

å› ä¸º then æ–¹æ³•ä¸­çš„å›è°ƒå‡½æ•°å±äºå¾®ä»»åŠ¡, æ‰€ä»¥ä¸Šä¾‹çš„è¾“å‡ºé¡ºåºä¸º `proThen Promise {<pending>}` â†’ `value Fulfilled`

ä¹Ÿå› ä¸º then æ˜¯å¼‚æ­¥æ“ä½œ, æ‰€ä»¥æ— æ³•åŒæ­¥è·å–æ­£ç¡®çš„ `proThen` å€¼ï¼›å¦‚æœæƒ³è·å–æ­£ç¡®çš„ `proThen` å€¼, å¯ä»¥å¼‚æ­¥è·å–:

```js
const pro = Promise.resolve("pro");

const then1 = pro.then((val1) => {
    console.log("val1", val1); // val1 pro
    return Promise.resolve("ok");
});
setTimeout(console.log, 0, then1); // PromiseÂ {<fulfilled>: 'ok'}

const then2 = pro.then((val2) => {
    console.log("val2", val2); // val2 pro
    return Promise.reject("reason");
});
setTimeout(console.log, 0, then2); // PromiseÂ {<rejected>: 'reason'}
```

ä¸Šä¾‹çš„è¾“å‡ºé¡ºåºä¸º: `val1 pro` - `val2 pro` - `PromiseÂ {<fulfilled>: 'ok'}` - `PromiseÂ {<rejected>: 'reason'}`

<br>

å¦‚æœ `return` çš„æ•°æ®ä¸æ˜¯ Promise å®ä¾‹, JS ä¼šåˆ›å»º fulfilled çŠ¶æ€çš„ Promise å®ä¾‹, å¹¶å°† `return` çš„æ•°æ®è®¾ç½®ä¸ºè¯¥ Promise å®ä¾‹çš„å€¼.

```js
const pro = Promise.resolve("proFulfilled");

const then = pro.then((value) => {
    console.log("value", value); // value proFulfilled
    return "superman";
});
setTimeout(console.log, 0, then); // PromiseÂ {<fulfilled>: 'superman'}
```

å¦‚æœæ²¡æœ‰ `return` è¯­å¥, åˆ™è¯¥ Promise å®ä¾‹çš„å€¼ä¸º `undefined`:

```js
const pro = Promise.resolve("proFulfilled");

const then = pro.then((value) => {
    console.log("value", value); // value proFulfilled
});
setTimeout(console.log, 0, then); // PromiseÂ {<fulfilled>: undefined}
```

<br>

å¦‚æœæ²¡æœ‰ç¼–å†™ `onResolve` & `onReject`, åˆ™ then æ–¹æ³•ä¼šç›´æ¥è¿”å›ä¸€ä¸ª**æ–°çš„** Promise å®ä¾‹, è¯¥å®ä¾‹çš„å€¼ã€çŠ¶æ€ä¼šä¸è°ƒç”¨è¯¥ then æ–¹æ³•çš„ Promise å®ä¾‹ä¸€æ ·.

```js
const pro1 = Promise.resolve("pro");
const then1 = pro1.then();
setTimeout(() => {
    console.log("pro1", pro1); // pro1 Promise { 'pro' }
    console.log("then1", then1); // then1 Promise { 'pro' }
    console.log(pro1 === then1); // false
});

const pro2 = new Promise(() => {});
const then2 = pro2.then();
setTimeout(() => {
    console.log("pro2", pro2); // pro2 Promise { <pending> }
    console.log("then2", then2); // then2 Promise { <pending> }
    console.log(pro2 === then2); // false
});
```

<br>

## pro.catch ( onReject )

`catch(onReject)` æ˜¯ `then(null, onRejected)` çš„è¯­æ³•ç³–:

```js
const pro = new Promise((_, reject) => {
    reject("error");
});

const proCatch = pro.catch((reason) => {
    console.log("reason", reason); // reason error
});

setTimeout(console.log, 0, proCatch); // PromiseÂ {<fulfilled>: undefined}
```

<br>

## pro.finally ( callback )

-   çŠ¶æ€ä¸º fulfilled & rejected çš„ Promise å®ä¾‹éƒ½**ä¼š**è¢« `finally` çš„å›è°ƒå‡½æ•°å¤„ç†, ä½†æ˜¯ pending çŠ¶æ€çš„ Promise å®ä¾‹**ä¸ä¼š**.
-   finally çš„å›è°ƒå‡½æ•°ä¸æ¥æ”¶å‚æ•°.

```js
const pro1 = Promise.resolve();
pro1.finally((_) => console.log("pro1 resolve")); // pro1 resolve

const pro2 = Promise.reject();
pro2.finally((_) => console.log("pro2 reject")); // pro2 reject

const pro3 = new Promise(() => {});
pro3.finally((_) => console.log("pro3 pending"));
```

-   finally æ–¹æ³•é»˜è®¤è¿”å›**æ–°çš„** Promise å®ä¾‹, æ–°çš„ Promise å®ä¾‹çš„ [çŠ¶æ€] å’Œ [å€¼] ä¸è°ƒç”¨ finally çš„ Promise å®ä¾‹ä¸€è‡´ ğŸŒŸ
-   å³ä½¿é‡å†™äº†æ–°çš„ return è¯­å¥, è¯¥ return è¯­å¥ä¹Ÿä¸ä¼šç”Ÿæ•ˆ

```js
const pro = Promise.resolve("pro");
console.log("pro", pro); // pro PromiseÂ {<fulfilled>: 'pro'}

const fin = pro.finally((_) => {
    console.log("finally"); // finally
    return Promise.resolve("finally"); // return è¯­å¥æ— æ•ˆ
});

setTimeout(() => {
    console.log("fin", fin); // fin PromiseÂ {<fulfilled>: 'pro'}
    console.log(fin === pro); // false
}, 0);
```

<br>

## éœ€è¦ææ‡‚

**å¤šä¸ªå›è°ƒçš„æ‰§è¡Œ**

å¦‚æœ Promise å®ä¾‹è°ƒç”¨äº†å¤šä¸ªå›è°ƒå‡½æ•°, å›è°ƒå‡½æ•°ä¼šæŒ‰é¡ºåºæ‰§è¡Œ:

```js
const pro = Promise.resolve("data");
pro.then((value) => console.log(value + 1)); // data1
pro.then((value) => console.log(value + 2)); // data2
```

<br>

**é“¾å¼è°ƒç”¨**

å› ä¸º `then` / `catch` / `finally` è¿”å›çš„è¿˜æ˜¯ä¸€ä¸ª `Promise` å®ä¾‹, æ‰€ä»¥å¯ä»¥é“¾å¼è°ƒç”¨:

```js
const pro = Promise.resolve("first");

pro.then((val1) => {
    console.log("val1", val1); // val1 first
    return "second";
})
    .then((val2) => console.log("val2", val2)) // val2 second
    .then((val3) => console.log("val3", val3)); // val3 undefined
```

ä¸Šä¾‹ä¸­, ç¬¬ 1 ä¸ª `then` è¿”å›äº† `"second"`, æ‰€ä»¥ `val2` ä¸º `"second"`ï¼›ç¬¬ 2 ä¸ª `then` æ²¡æœ‰è¿”å›å€¼, æ‰€ä»¥ `val3` ä¸º `undefined`

-   åœ¨é“¾å¼è°ƒç”¨ä¸­, æ²¡æœ‰æŒ‰ç…§è§„åˆ™ä¼ å…¥å›è°ƒå‡½æ•°çš„ thenã€catchã€finally æ–¹æ³•, å¯ä»¥çœ‹æˆä¼šè¢«ç›´æ¥è·³è¿‡:

```js
const p1 = Promise.resolve("p1");

p1.then((res1) => console.log("res1", res1)) // res1 p1
    .then((res2) => {
        console.log("res2", res2); // res2 undefined
        return "string";
    })
    .then("æˆ‘æ˜¯å­—ç¬¦ä¸²") // è¿™é‡Œæœ‰ä¸¤ä¸ªæ²¡å†™å›è°ƒå‡½æ•°çš„ then æ–¹æ³•, å¯ä»¥çœ‹æˆè¢«ç›´æ¥è·³è¿‡äº†
    .then() // å…¶å® then æ–¹æ³•è¿˜æ˜¯ä¼šè¿”å›æ–°çš„ Promise å®ä¾‹, æ­¤æ—¶è¿”å›çš„ Promise å®ä¾‹çš„çŠ¶æ€å’Œå€¼ä¸è°ƒç”¨å®ƒçš„ Promise å®ä¾‹ä¸€æ ·
    .then((res3) => console.log("res3", res3)); // res3 string
```

<br>

**Promise å¼‚å¸¸ç©¿é€**

ä½¿ç”¨ Promise çš„é“¾å¼è°ƒç”¨æ—¶, å¯ä»¥åœ¨æœ€åè®¾ç½® `catch` æ–¹æ³•, å¹¶æŒ‡å®šå¤±è´¥çš„å›è°ƒå‡½æ•°.
è¿™æ ·, å‰é¢ä»»ä½•æ“ä½œå‡ºç°å¼‚å¸¸, éƒ½ä¼šä¼ åˆ°æœ€åçš„ `catch` ä¸­, æ‰§è¡Œå…¶å›è°ƒå‡½æ•°.

```js
const pro = Promise.resolve("pro");

pro.then((val1) => {
    console.log("val1", val1); // val1 pro
    return Promise.reject("reject");
})
    .then((val2) => {
        console.log("val2", val2);
        return "then2' return";
    })
    .catch((reason) => console.log("reason", reason)); // reason reject
```

ä¸Šä¾‹ä¸­, å› ä¸ºç¬¬ä¸€ä¸ª `then` æ–¹æ³•è¿”å›çš„æ˜¯ rejected çŠ¶æ€çš„ Promise å®ä¾‹, æ‰€ä»¥ä¸ä¼šèµ°åé¢çš„ `then` æ–¹æ³•, ç›´æ¥è·³åˆ°äº†æœ€åçš„ `catch` æ–¹æ³•ä¸­.

```js
const pro = Promise.resolve("ok");

pro.then((val1) => {
    console.log("val1", val1); // val1 ok
    throw "error";
})
    .then((val2) => console.log("val2", val2))
    .catch((reason) => console.log("reason", reason)); // reason error
```

ä¸Šä¾‹ä¸­, å› ä¸ºç¬¬ 1 ä¸ª `then` æ–¹æ³•æŠ›å‡ºäº†é”™è¯¯, æ‰€ä»¥ä¸ä¼šæ‰§è¡Œç¬¬äºŒä¸ª `then` æ–¹æ³•, ç›´æ¥è·³åˆ°äº†æœ€åçš„ `catch` æ–¹æ³•

<br>

**ä¸­æ–­ Promise é“¾**

ä¸­æ–­ Promise é“¾, å°±æ˜¯è¯´åœ¨ä½¿ç”¨ `then` çš„é“¾å¼è°ƒç”¨æ—¶, åœ¨ä¸­é—´æ–­å¼€, ä¸å†æ‰§è¡Œåé¢çš„å›è°ƒå‡½æ•°.

åœ¨å›è°ƒå‡½æ•°ä¸­, è¿”å›ä¸€ä¸ª pending çŠ¶æ€çš„ Promise å¯¹è±¡

```js
const pro = Promise.resolve("ok");

pro.then((val1) => {
    console.log("val1", val1); // val1 ok
    return new Promise(() => {});
})
    .then((val2) => console.log("val2", val2))
    .catch((reason) => console.log("reason", reason));
```

ä¸Šè¿°ä»£ç ä¸­, å› ä¸ºç¬¬ 1 ä¸ª `then` è¿”å› pending çŠ¶æ€çš„ Promise å¯¹è±¡, æ‰€ä»¥ Promise é“¾æ²¡æœ‰ç»§ç»­å¾€ä¸‹æ‰§è¡Œ

<br><br>

# resolve & reject

## Promise.resolve ( value )

-   ç”¨äºåˆ›å»º fulfilled çŠ¶æ€çš„ Promise å®ä¾‹
-   å‚æ•° `value` ä¸º Promise å®ä¾‹çš„å€¼ï¼›ä¸ä¼ å‚çš„è¯, Promise å®ä¾‹çš„å€¼ä¸º `undefined`

```js
const pro1 = Promise.resolve(123);
console.log("pro1", pro1); // pro1 PromiseÂ {<fulfilled>: 123}

const pro2 = Promise.resolve();
console.log("pro2", pro2); // pro2 PromiseÂ {<fulfilled>: undefined}
```

-   å¦‚æœå‚æ•° `value` æ˜¯ Promise å®ä¾‹, åˆ™ç›´æ¥è¿”å›è¯¥å®ä¾‹

```js
const pro1 = new Promise((resolve) => resolve("resolve"));
const pro2 = Promise.resolve(pro1);
console.log(pro2); // PromiseÂ {<fulfilled>: 'resolve'}
console.log(pro1 === pro2); // true
```

<br>

## Promise.reject ( reason )

-   ç”¨äºåˆ›å»º rejected çŠ¶æ€çš„ Promise å®ä¾‹
-   å‚æ•° `reason` ä¸º Promise å®ä¾‹çš„å€¼ï¼›ä¸ä¼ å‚çš„è¯, Promise å®ä¾‹çš„å€¼ä¸º `undefined`

```js
const pro1 = Promise.reject("reason");
console.log("pro1", pro1); // pro1 PromiseÂ {<rejected>: 'reason'}

const pro2 = Promise.reject();
console.log("pro2", pro2); // pro2 PromiseÂ {<rejected>: undefined}
```

-   ä¸ `Promise.resolve(value)` ä¸åŒçš„æ˜¯: å³ä½¿å‚æ•° `reason` æ˜¯ Promise å®ä¾‹, ä¹Ÿä¼šæˆä¸ºæ–°åˆ›å»ºçš„ Promise å®ä¾‹çš„å€¼

```js
const pro1 = new Promise((resolve) => resolve("pro"));
const pro2 = Promise.reject(pro1);
console.log("pro2", pro2); // pro2 PromiseÂ {<rejected>: Promise}
```

<br><br>

# all & any & allSettled & race

## Promise.all ( promiseArr )

-   `Promise.all(promiseArr)` æ¥æ”¶ä¸€ä¸ª Promise å¯¹è±¡æ•°ç»„ä½œä¸ºå‚æ•°
-   è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡

å½“æ‰€æœ‰çš„ Promise éƒ½ resolve å, æŒ‰ç…§ä¼ å…¥çš„ Promise æ•°ç»„çš„é¡ºåº å°†æ¯ä¸ª Promise å¯¹è±¡çš„å€¼å­˜å‚¨åœ¨ä¸€ä¸ªæ–°çš„æ•°ç»„ä¸­, å¹¶å°†è¯¥æ•°ç»„åŒ…è£…ä¸º Promise å®ä¾‹çš„å€¼, ä½œä¸º Promise.all æ–¹æ³•çš„è¿”å›å€¼.

```js
const p1 = new Promise((resolve) => {
    setTimeout(() => {
        resolve("resolve p1");
    }, 500);
});
const p2 = new Promise((resolve) => {
    setTimeout(() => {
        resolve("resolve p2");
    }, 1000);
});
const p3 = new Promise((resolve) => {
    setTimeout(() => {
        resolve("resolve p3");
    }, 1500);
});

Promise.all([p1, p3, p2]).then((res) => {
    console.log("res", res); // res ['resolve p1', 'resolve p2', 'resolve p3']  ( 1.5s åè¾“å‡º )
});
```

åªè¦æœ‰ä¸€ä¸ª Promise è¢« reject, å°±ä¼šç«‹å³è¿”å›ä¸€ä¸ª rejected çš„ Promise å¯¹è±¡, å…¶ä¸­åŒ…å«ç¬¬ä¸€ä¸ªè¢« reject çš„ Promise å¯¹è±¡çš„é”™è¯¯ä¿¡æ¯:

```js
const p1 = new Promise((resolve) => {
    setTimeout(() => {
        resolve("resolve p1");
    }, 1000);
});
const p2 = new Promise((resolve, reject) => {
    setTimeout(() => {
        reject("reject p2");
    }, 2000);
});
const p3 = new Promise((resolve) => {
    setTimeout(() => {
        reject("reject p3");
    }, 10000);
});

Promise.all([p1, p3, p2]).catch((err) => {
    console.log("err", err); // err reject p2  ( 2s åè¾“å‡º )
});
```

<br>

## Promise.any ( promiseArr )

-   `Promise.any(promiseArr)` æ¥æ”¶ä¸€ä¸ª Promise å¯¹è±¡æ•°ç»„ä½œä¸ºå‚æ•°
-   è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡

å¦‚æœä¼ å…¥çš„ Promise æ•°ç»„ä¸­è‡³å°‘æœ‰ä¸€ä¸ª Promise å¯¹è±¡è¢« resolve, åˆ™ Promise.any çš„è¿”å›å€¼ä¼šå˜æˆä¸€ä¸ª fulfilled çŠ¶æ€çš„ Promise å¯¹è±¡, å¹¶ä¸”è¿™ä¸ªå¯¹è±¡çš„å€¼ä¼šç­‰äºæœ€å…ˆè¢« resolve çš„ Promise å¯¹è±¡çš„å€¼.

```js
const p1 = Promise.reject("reject p1");
const p2 = new Promise((resolve) => setTimeout(() => resolve("resolve p2"), 1000));
const p3 = Promise.resolve("resolve p3");

Promise.any([p1, p2, p3])
    .then((value) => console.log(value)) // resolve p3
    .catch((error) => console.error(error));
```

å¦‚æœä¼ å…¥çš„ Promise æ•°ç»„ä¸­, æ‰€æœ‰çš„ Promise å¯¹è±¡éƒ½è¢« reject, åˆ™ Promise.any çš„è¿”å›å€¼ä¼šå˜æˆä¸€ä¸ª rejected çŠ¶æ€çš„ Promise å¯¹è±¡, å¹¶æŠ›å‡ºä¸€ä¸ª AggregateError é”™è¯¯, å…¶ä¸­åŒ…å«äº†æ‰€æœ‰ reject çš„åŸå› ä¿¡æ¯:

```js
const p1 = Promise.reject("reject p1");
const p2 = new Promise((_, reject) => setTimeout(() => reject("reject p2"), 1000));
const p3 = Promise.reject("reject p3");

Promise.any([p1, p2, p3])
    .then((value) => console.log(value))
    .catch((error) => console.error(error)); // AggregateError: All promises were rejected
```

<br>

## Promise.allSettled ( promiseArr )

-   `Promise.all(promiseArr)` æ¥æ”¶ä¸€ä¸ª Promise å¯¹è±¡æ•°ç»„ä½œä¸ºå‚æ•°
-   åœ¨æ‰€æœ‰ Promise å¯¹è±¡éƒ½ settle åè¿”å›ä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡, è¯¥å¯¹è±¡çš„å€¼æ˜¯ä¸€ä¸ªæ•°ç»„, åŒ…å«æ¯ä¸ª Promise å¯¹è±¡çš„ settle çŠ¶æ€ä¿¡æ¯ï¼ˆå³ä¸ç®¡ resolve è¿˜æ˜¯ reject éƒ½ä¼šè¢«å¤„ç†ï¼‰
-   æ³¨æ„: è‹¥æœ‰é”™è¯¯, åˆ™æŠ›å‡ºé”™è¯¯ä¿¡æ¯, å¹¶ç»ˆæ­¢å‡½æ•°

```js
const p1 = new Promise((resolve) => {
    setTimeout(() => {
        resolve("resolve p1");
    }, 1000);
});
const p2 = new Promise((resolve, reject) => {
    setTimeout(() => {
        reject("reject p2");
    }, 2000);
});
const p3 = new Promise((resolve, reject) => {
    setTimeout(() => {
        reject("reject p3");
    }, 3000);
});

const pas = Promise.allSettled([p1, p2, p3]).then((valArr) => {
    valArr.forEach((item, index) => {
        console.log(`item ${index + 1}: `, item);
        // item 1:  {status: 'fulfilled', value: 'resolve p1'}
        // item 2:  {status: 'rejected', reason: 'reject p2'}
        // item 3:  {status: 'rejected', reason: 'reject p3'}
    });
});
```

<br>

## Promise.race ( promiseArr )

-   `Promise.race(promiseArr)` æ¥æ”¶ä¸€ä¸ª Promise å¯¹è±¡æ•°ç»„ä½œä¸ºå‚æ•°
-   è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡, åœ¨ `promiseArr` åŒ…å«çš„ Promise å¯¹è±¡ä¸­æœ‰ä¸€ä¸ªå¯¹è±¡ settle æ—¶ç«‹å³ resolve / reject
-   æ³¨æ„: æŠ›å‡ºå¼‚å¸¸çš„ Promise å®ä¾‹ä¸ä¼šè¢« Promise.race å¤„ç†

```js
const p1 = new Promise((resolve) => {
    setTimeout(() => {
        resolve("resolve p1");
    }, 500);
});
const p2 = new Promise((_, reject) => {
    setTimeout(() => {
        reject("reject p2");
    }, 1000);
});
const p3 = new Promise(() => {
    setTimeout(() => {
        throw "error p3"; // æŠ›å‡ºå¼‚å¸¸, ä¸ä¼šè¢«å¤„ç†
    }, 0);
});

Promise.race([p1, p2, p3])
    .then((value) => console.log("value", value)) // value resolve p1
    .catch((reason) => console.log("reason", reason));
```

å¯ä»¥ä½¿ç”¨ Promise.race æ¥å®ç°ä¸€ä¸ªè¶…æ—¶æ§åˆ¶, å¦‚æœæŸä¸ªå¼‚æ­¥æ“ä½œåœ¨æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰å®Œæˆ, å°±æŠ›å‡ºè¶…æ—¶å¼‚å¸¸:

```js
function timeoutPromise(promise, timeout) {
    // è¿”å›ä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡
    return Promise.race([
        promise, // åŸå§‹çš„ Promise å¯¹è±¡
        new Promise((_, reject) => {
            // å°†ç»™å®šçš„æ—¶é—´è½¬æ¢ä¸ºæ¯«ç§’å•ä½
            setTimeout(() => {
                reject(new Error("Operation timed out"));
            }, timeout);
        }),
    ]);
}

const timeout = 5000; // è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º 5 ç§’é’Ÿ
const promise = new Promise((resolve, reject) => {
    setTimeout(() => {
        resolve("Operation completed successfully");
    }, 3000);
});

// è°ƒç”¨ timeoutPromise å‡½æ•°æµ‹è¯•
timeoutPromise(promise, timeout)
    .then((result) => {
        console.log(result); // æ‰“å°è¾“å‡º "Operation completed successfully"
    })
    .catch((error) => {
        console.error(error); // æ‰“å°è¾“å‡º "Error: Operation timed out"
    });
```

ä¸Šä¾‹ä¸­, setTimeout å‡½æ•°æ¨¡æ‹Ÿäº†ä¸€ä¸ªéœ€è¦ç­‰å¾… 3 ç§’é’Ÿæ‰èƒ½å®Œæˆçš„å¼‚æ­¥æ“ä½œ. æˆ‘ä»¬è®¾ç½®äº†è¶…æ—¶æ—¶é—´ä¸º 5 ç§’é’Ÿ, æ‰€ä»¥ Promise.race æ–¹æ³•ä¼šåœ¨ 3 ç§’é’Ÿåè¿”å›åŸå§‹çš„ Promise å¯¹è±¡çš„ç»“æœ. å¦‚æœåœ¨ 5 ç§’é’Ÿå†…æœªå®Œæˆè¯¥æ“ä½œ, åˆ™ä¼šæŠ›å‡ºè¶…æ—¶é”™è¯¯

<br><br>

# æ¡ˆä¾‹

demo - fs é…åˆ Promise å¼‚æ­¥è¯»å–æ–‡ä»¶:

```js
const fs = require("fs");

// // â‘  å¼‚æ­¥æ“ä½œçš„ä¼ ç»Ÿè§£å†³æ–¹æ¡ˆ: ä½¿ç”¨ [å›è°ƒå‡½æ•°] å®Œæˆå¼‚æ­¥æ“ä½œ
// fs.readFile("./1.txt", (err1, data1) => {
//     if (err1) return console.log(err1.message);
//     console.log("data1", `${data1}`);

//     fs.readFile("./2.txt", (err2, data2) => {
//         if (err2) return console.log(err2.message);
//         console.log("data2", `${data2}`);

//         fs.readFile("./3.txt", (err3, data3) => {
//             if (err3) return console.log(err3.message);
//             console.log("data3", `${data3}`);
//         });
//     });
// });

// â‘¡ ä½¿ç”¨ Promise å®Œæˆå¼‚æ­¥æ“ä½œ
new Promise((resolve, reject) => {
    fs.readFile("./1.txt", (err1, data1) => {
        if (err1) reject(err1.message);
        resolve(data1);
    });
})
    .then((val1) => {
        console.log("data1", `${val1}`);
        // è¿”å›å¼‚æ­¥æ“ä½œçš„ç»“æœ
        return new Promise((resolve, reject) => {
            fs.readFile("./2.txt", (err2, data2) => {
                if (err2) reject(err2.message);
                resolve(data2);
            });
        });
    })
    .then((val2) => {
        console.log("data2", `${val2}`);
        // è¿”å›å¼‚æ­¥æ“ä½œçš„ç»“æœ
        return new Promise((resolve, reject) => {
            fs.readFile("./3.txt", (err3, data3) => {
                if (err3) reject(err3.message);
                resolve(data3);
            });
        });
    })
    .then((val3) => {
        console.log("data3", `${val3}`);
    })
    .catch((err) => {
        console.log(err);
    });
```

<br>

å°† fs å°è£…æˆ Promise å¯¹è±¡æ¥ä½¿ç”¨

```js
const fs = require("fs");

function myReadFile(path) {
    return new Promise((resolve, reject) => {
        fs.readFile(path, (err, data) => {
            if (err) reject(err.message);
            resolve(data);
        });
    });
}

myReadFile("./1.txt")
    .then((val1) => {
        console.log("data1", `${val1}`);
        // è¿”å›å¼‚æ­¥æ“ä½œçš„ç»“æœ
        return myReadFile("./2.txt");
    })
    .then((val2) => {
        console.log("data2", `${val2}`);
        // è¿”å›å¼‚æ­¥æ“ä½œçš„ç»“æœ
        return myReadFile("./3.txt");
    })
    .then((val3) => {
        console.log("data3", `${val3}`);
    })
    .catch((err) => {
        console.log(err);
    });
```

<br>

æ¯æ¬¡éƒ½è¦è‡ªå·±å°è£…, ç•¥æ˜¾éº»çƒ¦. `util.promisify` åº”è¿è€Œç”Ÿ

-   **`util.promisify` çš„ä½œç”¨: å°†å‡½æ•°å°è£…æˆ Promise å®ä¾‹**:

```js
const util = require("util"); // æ— éœ€ä¸‹è½½, ç›´æ¥å¼•å…¥å³å¯ä½¿ç”¨
let myReadFile = util.promisify(fs.readFile);
```

-   ä¹Ÿå¯ä»¥ä½¿ç”¨ **then-fs** ä¾èµ–åŒ…, then-fs å·²ç»å°† fs.readFile æ–¹æ³•å°è£…å¥½äº†

    â‘  `npm i then-fs`ã€â‘¡ `const thenFs = require("then-fs")`

```js
const thenFs = require("then-fs");
let myReadFile = thenFs.readFile;
```

<br>
