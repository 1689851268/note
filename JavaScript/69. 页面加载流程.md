# 页面加载的流程

1. **创建** document 对象。解析 HTML 及其文本内容后，添加 Element 对象和 Text 节点到文档中。
   这个阶段的 **`document.readyState = 'loading'`**。

2. 如果遇到 `link` 标签引入外部 CSS 文件，浏览器会创建新线程加载 CSS 文件，同时继续解析文档（异步）。

3. ① 如果引入外部 JS 文件，且没有设置 `async`、`defer` 等操作，浏览器会加载 JS 文件，阻塞主线程，等 JS 文件加载、并执行完，再继续解析文档（同步）。

    ② 如果引入外部 JS 文件，且设置了 `async`、`defer` 等操作，浏览器会创建新线程加载 JS 文件，同时继续解析文档（异步）。

4. 如果遇到 `img`、`iframe` 等标签，浏览器会异步加载 `src`，同时继续解析文档（异步）。

5. 文档**解析**完成后，设置有 `defer` 的脚本会按顺序执行（同步）、此时的 **`document.readyState = 'interactive'`**。

    <u>document 对象触发 `DOMContentLoaded` 事件</u>，这标志着程序从 [同步脚本执行阶段] → [事件驱动阶段]。

6. 等所有异步的数据资源**加载**完后，**`document.readyState = 'complete'`**，<u>window 对象触发 `load` 事件</u>。

    从此，以异步响应方式处理用户输入、网络事件...

简单来说：
① **创建** document 对象，此时 `document.readyState = 'loading'`。
② 文档**解析**完成：此时 `document.readyState = 'interactive'`，document 对象触发 `DOMContentLoaded` 事件。
③ 文档**加载**完成：此时 `document.readyState = 'complete'`，window 对象触发 `load` 事件。

```js
console.log('create', document.readyState); // create loading

// DOM 解析完成
document.addEventListener(
    'DOMContentLoaded',
    () => console.log('DOMContentLoaded', document.readyState) // DOMContentLoaded interactive
);

// 资源加载完
window.onload = function () {
    console.log('onload', document.readyState); // onload complete
};

// document.readyState 更新
document.onreadystatechange = function () {
    console.log('onreadystatechange', document.readyState);
    // onreadystatechange interactive
    // onreadystatechange complete
};
```

<br>

## 同步加载 JS

-   浏览器会同步加载 JS 代码，以防 JS 操作 DOM 时出错。

-   浏览器加载 .html 时，如果遇到了 script 标签，会停下来 先把 script 标签里的 JS 执行完。
    如果 script 标签里 有外部文件，那就必须等待其下载、执行，然后浏览器才会继续往下执行。

    如果网速较慢，JS 文件的下载就会阻止后面代码的执行。

<br>

## 重构 & 重绘

DOM 树生成后，会等待 CSS 树生成，之后再等 Render 树生成，最后才绘制页面。

我们可以简单地理解为：
reflow 重构是结构发生了变化，进而影响页面布局。eg：元素的宽高...（效率较低，需要生成新的 DOM 树，再生成新的 Render 树）
repaint 重绘是样式发生了变化，不会影响页面布局。eg：元素的颜色...（效率较高）

<br>
