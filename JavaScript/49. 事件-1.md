# äº‹ä»¶çš„ç”¨æ³•

## äº‹ä»¶ç»‘å®š

**DOM0:**

é€šè¿‡å…ƒç´ çš„ `onäº‹ä»¶ç±»å‹` å±æ€§ç»‘å®š:

```js
const btn = document.getElementById("btn");

btn.onclick = function (event) {
    console.log("æŒ‰é’®è¢«ç‚¹å‡»");
};
```

**ç‰¹ç‚¹:**

-   åŒä¸€äº‹ä»¶ç±»å‹åªèƒ½ç»‘å®šä¸€ä¸ªå¤„ç†å‡½æ•° (åç»‘å®šä¼šè¦†ç›–å‰é¢çš„)
-   åªèƒ½åœ¨å†’æ³¡é˜¶æ®µè§¦å‘

<br>

**DOM2 (æ¨è):**

ä½¿ç”¨ `addEventListener` æ–¹æ³•ç»‘å®š:

```js
element.addEventListener(type, listener, options);
```

**å‚æ•°è¯´æ˜:**

-   `type`: äº‹ä»¶ç±»å‹å­—ç¬¦ä¸² (ä¸å¸¦ `on` å‰ç¼€), å¦‚ `'click'`, `'keydown'`
-   `listener`: äº‹ä»¶å¤„ç†å‡½æ•° / åŒ…å« `handleEvent` æ–¹æ³•çš„å¯¹è±¡
-   `options`: é…ç½®å¯¹è±¡ / å¸ƒå°”å€¼ (`{ capture: Boolean }` çš„ç®€å†™)

**é…ç½®å¯¹è±¡å±æ€§:**

| å±æ€§      | ç±»å‹        | é»˜è®¤å€¼                            | è¯´æ˜                                                  |
| --------- | ----------- | --------------------------------- | ----------------------------------------------------- |
| `capture` | Boolean     | `false`                           | `true` è¡¨ç¤ºåœ¨æ•è·é˜¶æ®µè§¦å‘, `false` è¡¨ç¤ºåœ¨å†’æ³¡é˜¶æ®µè§¦å‘ |
| `once`    | Boolean     | `false`                           | `true` è¡¨ç¤ºç›‘å¬å™¨è§¦å‘ä¸€æ¬¡åè‡ªåŠ¨ç§»é™¤                   |
| `passive` | Boolean     | ç‰¹å®šäº‹ä»¶ä¸º `true`, ä¸€èˆ¬ä¸º `false` | `true` è¡¨ç¤ºæ°¸è¿œä¸ä¼šè°ƒç”¨ `preventDefault()`            |
| `signal`  | AbortSignal | -                                 | é€šè¿‡ `AbortController` æ§åˆ¶ç›‘å¬å™¨çš„ç§»é™¤               |

**ä½¿ç”¨ç¤ºä¾‹:**

```js
const btn = document.getElementById("btn");

// åŸºç¡€ç”¨æ³•
btn.addEventListener("click", function (event) {
    console.log("ç‚¹å‡»äº‹ä»¶è§¦å‘");
});

// æ•è·é˜¶æ®µè§¦å‘
btn.addEventListener("click", handler, true);
// æˆ–è€…
btn.addEventListener("click", handler, { capture: true });

// ä¸€æ¬¡æ€§ç›‘å¬å™¨
btn.addEventListener("click", handler, { once: true });

// ä½¿ç”¨ AbortSignal æ§åˆ¶ç§»é™¤
const controller = new AbortController();
btn.addEventListener("click", handler, { signal: controller.signal });
controller.abort(); // ç§»é™¤ç›‘å¬å™¨
```

**ç›‘å¬å™¨å¯ä»¥æ˜¯å¯¹è±¡:**

```js
const handler = {
    handleEvent(event) {
        console.log(`äº‹ä»¶ç±»å‹: ${event.type}`);
    },
};

btn.addEventListener("click", handler);
```

**æ¨èä½¿ç”¨ `addEventListener` çš„ç†ç”±:**

1. å¯ä¸ºåŒä¸€äº‹ä»¶ç±»å‹ç»‘å®šå¤šä¸ªç›‘å¬å™¨, æŒ‰ç»‘å®šé¡ºåºä¾æ¬¡æ‰§è¡Œ
2. å¯ç²¾ç¡®æ§åˆ¶åœ¨æ•è·/å†’æ³¡é˜¶æ®µè§¦å‘
3. é€‚ç”¨èŒƒå›´å¹¿: Element, Document, Window, XMLHttpRequest ç­‰æ‰€æœ‰ EventTarget å¯¹è±¡
4. æä¾›æ›´ä¸°å¯Œçš„é…ç½®é€‰é¡¹

<br>

## äº‹ä»¶è§£ç»‘

**DOM0:**

```js
element.onclick = null;
```

<br>

**DOM2:**

```js
element.removeEventListener(type, listener, options);
```

**æ³¨æ„äº‹é¡¹:**

-   å¿…é¡»ä½¿ç”¨ç›¸åŒçš„ `listener` å‡½æ•°å¼•ç”¨ (åŒ¿åå‡½æ•°æ— æ³•è§£ç»‘)
-   `capture` å‚æ•°å¿…é¡»ä¸ç»‘å®šæ—¶ä¸€è‡´
-   å…¶ä»–é…ç½®é¡¹ (`once`, `passive`, `signal`) æ— éœ€åŒ¹é…

```js
// âŒ é”™è¯¯ç¤ºä¾‹: æ— æ³•è§£ç»‘åŒ¿åå‡½æ•°
btn.addEventListener("click", () => console.log("clicked"));
btn.removeEventListener("click", () => console.log("clicked")); // æ— æ•ˆ

// âœ… æ­£ç¡®ç¤ºä¾‹
function handleClick() {
    console.log("clicked");
}
btn.addEventListener("click", handleClick);
btn.removeEventListener("click", handleClick); // æœ‰æ•ˆ
```

<br><br>

# äº‹ä»¶æµ

å½“ç”¨æˆ·åœ¨ç½‘é¡µä¸Šè§¦å‘æŸä¸ªäº‹ä»¶æ—¶ (å¦‚ç‚¹å‡»ä¸€ä¸ªåµŒå¥—å…ƒç´ ), äº‹ä»¶ä¼šæŒ‰ç…§ç‰¹å®šé¡ºåºåœ¨ DOM æ ‘ä¸Šä¼ æ’­, è¿™ä¸ªè¿‡ç¨‹ç§°ä¸º **äº‹ä»¶æµ (Event Flow)**.

äº‹ä»¶æµåŒ…å«ä¸‰ä¸ªé˜¶æ®µ:

1. **æ•è·é˜¶æ®µ (Capturing Phase)**: äº‹ä»¶ä» `Window` â†’ `Document` â†’ `<html>` â†’ ... â†’ ç›®æ ‡å…ƒç´ çš„çˆ¶çº§
2. **ç›®æ ‡é˜¶æ®µ (Target Phase)**: äº‹ä»¶åˆ°è¾¾ç›®æ ‡å…ƒç´ æœ¬èº«
3. **å†’æ³¡é˜¶æ®µ (Bubbling Phase)**: äº‹ä»¶ä»ç›®æ ‡å…ƒç´ çš„çˆ¶çº§ â†’ ... â†’ `<html>` â†’ `Document` â†’ `Window`

<br>

## äº‹ä»¶è§¦å‘é¡ºåº

ç‚¹å‡»ä¸€ä¸ªåµŒå¥—å…ƒç´ æ—¶, äº‹ä»¶ä¼šæŒ‰ç…§ä»¥ä¸‹é¡ºåºè§¦å‘:

```html
<div id="parent">
    parent
    <div id="child">child</div>
</div>
```

```js
parent.addEventListener("click", () => console.log("çˆ¶-æ•è·"), true);
child.addEventListener("click", () => console.log("å­-æ•è·"), true);
child.addEventListener("click", () => console.log("å­-å†’æ³¡"), false);
parent.addEventListener("click", () => console.log("çˆ¶-å†’æ³¡"), false);

// ç‚¹å‡» child, è¾“å‡ºé¡ºåº:
// 1. çˆ¶-æ•è·
// 2. å­-æ•è·
// 3. å­-å†’æ³¡
// 4. çˆ¶-å†’æ³¡
```

**å¯è§†åŒ–æµç¨‹:**

```mermaid
sequenceDiagram
    participant W as Window
    participant P as parent (div)
    participant C as child (div)

    Note over W,C: ç”¨æˆ·ç‚¹å‡» child

    rect rgb(220, 240, 255)
        Note right of W: æ•è·é˜¶æ®µ â¬‡ï¸
        W->>P: äº‹ä»¶ä¼ æ’­
        activate P
        P->>P: è§¦å‘ "çˆ¶-æ•è·"
        P->>C: äº‹ä»¶ä¼ æ’­
        deactivate P
    end

    rect rgb(255, 240, 220)
        Note right of C: ç›®æ ‡é˜¶æ®µ ğŸ¯
        activate C
        C->>C: è§¦å‘ "å­-æ•è·"
        C->>C: è§¦å‘ "å­-å†’æ³¡"
        deactivate C
    end

    rect rgb(240, 255, 220)
        Note right of C: å†’æ³¡é˜¶æ®µ â¬†ï¸
        C->>P: äº‹ä»¶å†’æ³¡
        activate P
        P->>P: è§¦å‘ "çˆ¶-å†’æ³¡"
        P->>W: äº‹ä»¶å†’æ³¡
        deactivate P
    end
```

<br>

## ç‰¹æ®Šæƒ…å†µ: ç›®æ ‡å…ƒç´ 

å½“äº‹ä»¶åˆ°è¾¾ç›®æ ‡å…ƒç´ æœ¬èº«æ—¶, **å…ˆæ‰§è¡Œæ•è·é˜¶æ®µçš„ç›‘å¬å™¨, å†æ‰§è¡Œå†’æ³¡é˜¶æ®µçš„ç›‘å¬å™¨**:

```js
child.addEventListener("click", () => console.log("A-å†’æ³¡"), false);
child.addEventListener("click", () => console.log("B-æ•è·"), true);
child.addEventListener("click", () => console.log("C-å†’æ³¡"), false);

// ç‚¹å‡» child, è¾“å‡ºé¡ºåº:
// B-æ•è· â†’ A-å†’æ³¡ â†’ C-å†’æ³¡ (æ•è·é˜¶æ®µä¼˜å…ˆ, åŒé˜¶æ®µæŒ‰ç»‘å®šé¡ºåº)
```

**è§„åˆ™:**

1. ç›®æ ‡å…ƒç´ ä¸Šçš„æ•è·ç›‘å¬å™¨å…ˆæ‰§è¡Œ
2. ç›®æ ‡å…ƒç´ ä¸Šçš„å†’æ³¡ç›‘å¬å™¨åæ‰§è¡Œ
3. åŒé˜¶æ®µçš„ç›‘å¬å™¨æŒ‰ç»‘å®šé¡ºåºæ‰§è¡Œ

<br><br>
