# `new URL()` 构造函数

`URL` 是 JavaScript 中的一个内置类, 提供了用于创建、解析和操作 URL 的便捷接口. 通过 `new URL()` 构造函数, 我们可以轻松地处理和修改 URL 的各个组成部分.

<br>

## 基本语法

```javascript
new URL(url, [base]);
```

**参数:**

-   `url`: 字符串, 表示绝对或相对的 URL
-   `base`: 可选参数, 字符串, 表示基准 URL. 当 `url` 为相对 URL 时, 需要提供 `base` 作为参考

<br>

## 创建 URL 对象

绝对 URL:

```javascript
// 创建绝对 URL
const url1 = new URL("https://example.com/path?query=123#hash");
console.log(url1.href); // 'https://example.com/path?query=123#hash'
```

相对 URL:

```javascript
// 创建相对 URL, 需要提供基准 URL
const url2 = new URL("/path", "https://example.com");
console.log(url2.href); // 'https://example.com/path'

// 相对路径示例
const url3 = new URL("subpath", "https://example.com/path/");
console.log(url3.href); // 'https://example.com/path/subpath'
```

<br>

## URL 对象的属性

`URL` 对象提供了多种属性, 方便我们访问和修改 URL 的各个部分:

| 属性           | 描述                 | 示例                                             |
| -------------- | -------------------- | ------------------------------------------------ |
| `href`         | 完整的 URL 字符串    | `'https://example.com:8080/path?query=123#hash'` |
| `protocol`     | 协议部分, 以冒号结尾 | `'https:'`                                       |
| `username`     | 用户名部分           | `'user'`                                         |
| `password`     | 密码部分             | `'pass'`                                         |
| `host`         | 主机名和端口号       | `'example.com:8080'`                             |
| `hostname`     | 主机名, 不包括端口号 | `'example.com'`                                  |
| `port`         | 端口号               | `'8080'`                                         |
| `pathname`     | 路径部分             | `'/path'`                                        |
| `search`       | 查询字符串, 包括问号 | `'?query=123'`                                   |
| `searchParams` | URLSearchParams 对象 | 用于操作查询参数                                 |
| `hash`         | 片段标识符, 包括井号 | `'#hash'`                                        |

```javascript
const url = new URL("https://user:pass@example.com:8080/path?query=123#hash");

console.log(url.href); // 'https://user:pass@example.com:8080/path?query=123#hash'
console.log(url.protocol); // 'https:'
console.log(url.username); // 'user'
console.log(url.password); // 'pass'
console.log(url.host); // 'example.com:8080'
console.log(url.hostname); // 'example.com'
console.log(url.port); // '8080'
console.log(url.pathname); // '/path'
console.log(url.search); // '?query=123'
console.log(url.hash); // '#hash'
```

<br>

## 操作查询参数

`searchParams` 属性是一个 `URLSearchParams` 对象, 提供了操作查询参数的方法:

| 方法                  | 描述                                                   |
| --------------------- | ------------------------------------------------------ |
| `append(name, value)` | 添加指定名称和值的参数                                 |
| `delete(name)`        | 删除指定名称的所有参数                                 |
| `get(name)`           | 获取指定名称的第一个参数值                             |
| `getAll(name)`        | 获取指定名称的所有参数值, 返回数组                     |
| `has(name)`           | 判断是否存在指定名称的参数                             |
| `set(name, value)`    | 设置指定名称的参数值, 若存在多个同名参数则删除其他参数 |

```javascript
const url = new URL("https://example.com/path?query=123");

// 添加参数
url.searchParams.append("page", "2");
console.log(url.href); // 'https://example.com/path?query=123&page=2'

// 设置参数 (覆盖同名参数)
url.searchParams.set("query", "456");
console.log(url.href); // 'https://example.com/path?query=456&page=2'

// 获取参数
console.log(url.searchParams.get("query")); // '456'
console.log(url.searchParams.get("page")); // '2'

// 检查参数是否存在
console.log(url.searchParams.has("query")); // true

// 获取所有同名参数
url.searchParams.append("query", "789");
console.log(url.searchParams.getAll("query")); // ['456', '789']

// 删除参数
url.searchParams.delete("page");
console.log(url.href); // 'https://example.com/path?query=456&query=789'
```

<br>

## 修改 URL 的其他部分

`URL` 对象的属性是可写的, 可以直接修改:

```javascript
const url = new URL("https://example.com/path?query=123#hash");

// 修改各个部分
url.protocol = "http:";
url.hostname = "new-example.com";
url.port = "8080";
url.pathname = "/new-path";
url.hash = "#new-hash";

console.log(url.href); // 'http://new-example.com:8080/new-path?query=123#new-hash'
```

<br>

## 实际应用场景

### 1. 构建 API 请求 URL

```javascript
const baseUrl = "https://api.example.com";
const endpoint = "/users";
const params = { id: 123, page: 1 };

const url = new URL(endpoint, baseUrl);
Object.entries(params).forEach(([key, value]) => {
    url.searchParams.set(key, value);
});

console.log(url.href); // 'https://api.example.com/users?id=123&page=1'

// 用于 fetch 请求
fetch(url)
    .then((response) => response.json())
    .then((data) => console.log(data));
```

### 2. 解析当前页面 URL

```javascript
// 在浏览器环境中
const currentUrl = new URL(window.location.href);
console.log("当前协议:", currentUrl.protocol);
console.log("当前主机:", currentUrl.hostname);
console.log("当前路径:", currentUrl.pathname);

// 获取查询参数
const userId = currentUrl.searchParams.get("userId");
if (userId) {
    console.log("用户ID:", userId);
}
```

### 3. 动态构建下载链接

```javascript
function createDownloadUrl(fileId, token) {
    const baseUrl = "https://files.example.com";
    const url = new URL(`/download/${fileId}`, baseUrl);
    url.searchParams.set("token", token);
    url.searchParams.set("timestamp", Date.now().toString());

    return url.href;
}

const downloadUrl = createDownloadUrl("file123", "abc123");
console.log(downloadUrl); // 'https://files.example.com/download/file123?token=abc123&timestamp=1703123456789'
```

<br>

## 错误处理

如果提供的 `url` 或 `base` 不是有效的 URL, `new URL()` 会抛出 `TypeError` 异常:

```javascript
try {
    const url = new URL("invalid-url");
} catch (error) {
    console.error("URL 解析错误:", error.message);
    // URL 解析错误: Failed to construct 'URL': Invalid URL
}

try {
    const url = new URL("/path", "invalid-base");
} catch (error) {
    console.error("基准 URL 错误:", error.message);
    // 基准 URL 错误: Failed to construct 'URL': Invalid base URL
}
```

<br>

## 浏览器兼容性

`URL` 构造函数在现代浏览器中有很好的支持:

-   **Chrome**: 32+
-   **Firefox**: 26+
-   **Safari**: 7+
-   **Edge**: 12+
-   **Node.js**: 10.0.0+

对于较老的浏览器, 可以使用 polyfill 或手动解析 URL.

<br>

## 注意事项

1. **自动类型转换**: `URL` 对象可以直接传递给需要 URL 字符串的方法 (如 `fetch`、`XMLHttpRequest`), 因为它们会自动调用 `toString()` 方法获取字符串表示.

2. **Web Workers 支持**: `URL` 对象在 Web Workers 中同样可用.

3. **Node.js 环境**: 在 Node.js 环境中, `URL` 构造函数是全局可用的, 无需额外引入模块.

4. **性能考虑**: 对于频繁的 URL 操作, 使用 `URL` 对象比字符串拼接更高效且更安全.

<br>

## 与字符串方法的对比

```javascript
// 传统字符串方法 (容易出错)
const baseUrl = "https://api.example.com";
const endpoint = "/users";
const params = "?id=123&page=1";
const url = baseUrl + endpoint + params;

// 使用 URL 对象 (更安全)
const url = new URL("/users", "https://api.example.com");
url.searchParams.set("id", "123");
url.searchParams.set("page", "1");
```

通过 `new URL()` 构造函数, 我们可以更方便、更安全地处理 URL, 提升代码的可读性和维护性.

<br>
