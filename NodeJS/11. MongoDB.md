# MongoDB

éå…³ç³»å‹æ•°æ®åº“ï¼Œå­˜å‚¨çš„æ•°æ®éƒ½æ˜¯ key-value çš„å½¢å¼

<br>

**å®‰è£…æ•°æ®åº“**

-   å®˜ç½‘ä¸‹è½½ï¼Œç„¶åé…ç½®ç¯å¢ƒå˜é‡å³å¯
-   å¯åœ¨å°é»‘å±è¾“å…¥ `mongo` è¿æ¥æ•°æ®åº“ï¼Œä»¥æŸ¥çœ‹æ˜¯å¦å®‰è£…æˆåŠŸ
-   å¯åŠ¨/å…³é—­æ•°æ®åº“æœåŠ¡ï¼š`window` + `r` ğŸ‘‰ è¾“å…¥ `services.msc` æ‰“å¼€ä»»åŠ¡ç®¡ç†å™¨ ğŸ‘‰ æ‰¾åˆ° MongoDB æ•°æ®åº“ï¼Œå³é”® `å¯åŠ¨` / `åœæ­¢`

<br>

**åŸºæœ¬æ¦‚å¿µ**

1. æ•°æ®åº“ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå¯¹è±¡
2. è¡¨ï¼šä¹Ÿå« "é›†åˆ"ï¼Œå°±æ˜¯æ•°æ®åº“å¯¹è±¡çš„å±æ€§
3. æ–‡æ¡£ï¼šç›¸å½“äºè¡Œ
4. å­—æ®µï¼šç›¸å½“äºåˆ—

<br><br>

# å¸¸ç”¨å‘½ä»¤

## æ•°æ®åº“æ“ä½œ

1. `show dbs`ï¼šæŸ¥è¯¢æ‰€æœ‰æ•°æ®åº“

```mongodb
> show dbs
admin   0.000GB
config  0.000GB
local   0.000GB
```

<br>

2. `db`ï¼šæŸ¥çœ‹å½“å‰æ•°æ®åº“

```bash
> db
test
```

å¯ä»¥çœ‹è§ï¼Œå½“å‰ä½¿ç”¨çš„æ•°æ®åº“ä¸º testï¼›ä½†æ˜¯ï¼Œå› ä¸ºç°åœ¨ test æ•°æ®åº“ä¸­æ²¡æœ‰æ•°æ®ï¼Œæ‰€ä»¥ä¸ä¼šè¢« `show dbs` æŸ¥è¯¢å‡ºæ¥

<br>

3. `use æ•°æ®åº“å`ï¼šåˆ‡æ¢æ•°æ®åº“ï¼›å¦‚æœæ‰¾ä¸åˆ°è¯¥æ•°æ®åº“ï¼Œåˆ™ä¼šåˆ›å»ºè¯¥æ•°æ®åº“

<br>

4. `db.dropDatabase()`ï¼šåˆ é™¤å½“å‰æ•°æ®åº“

<br>

## é›†åˆæ“ä½œ

1. `show collections`ï¼šå±•ç¤ºå½“å‰æ•°æ®åº“ä¸­çš„è¡¨(é›†åˆ)

<br>

2. `db.createCollection(é›†åˆåç§°, é…ç½®å¯¹è±¡)`ï¼šåˆ›å»ºé›†åˆ

    1. `capped`ï¼šBooleanï¼›æ˜¯å¦é™åˆ¶é›†åˆçš„å¤§å°ã€‚å¦‚æœä¸º `true`ï¼Œåˆ™éœ€è¦è®¾ç½® `size` å±æ€§ã€‚é»˜è®¤ä¸º `false`ã€‚å½“é›†åˆçš„å¤§å°è¾¾åˆ° `size` æ—¶ï¼Œä¼šè‡ªåŠ¨è¦†ç›–æ—§æ•°æ®ã€‚

    2. `autoIndexId`ï¼šBooleanï¼›æ˜¯å¦è‡ªåŠ¨åˆ›å»º `_id` å­—æ®µä½œä¸ºç´¢å¼•ã€‚é»˜è®¤ä¸º `false`ã€‚

    3. `size`ï¼šNumberï¼›é™åˆ¶é›†åˆçš„å¤§å°ï¼Œå•ä½ä¸ºå­—èŠ‚ã€‚é»˜è®¤ä¸º `4096`ã€‚

    4. `max`ï¼šNumberï¼›é™åˆ¶é›†åˆä¸­æ–‡æ¡£çš„ä¸ªæ•°ã€‚é»˜è®¤æ— é™åˆ¶ã€‚

```bash
db.createCollection('student', { capped: true, size: 10000, max: 1000 })
```

> åœ¨æ’å…¥æ–‡æ¡£æ—¶ï¼ŒMongoDB é¦–å…ˆæ£€æŸ¥å›ºå®šé›†åˆçš„ `size` å­—æ®µï¼Œç„¶åæ£€æŸ¥ `max` å­—æ®µã€‚

å€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨ MongoDB ä¸­ï¼Œå…¶å®ä¸éœ€è¦æˆ‘ä»¬æ˜¾å¼çš„æ¥åˆ›å»ºé›†åˆã€‚å½“æˆ‘ä»¬æ’å…¥ä¸€äº›æ–‡æ¡£æ—¶ï¼ŒMongoDB ä¼šè‡ªåŠ¨åˆ›å»ºé›†åˆã€‚

<br>

3. `db.é›†åˆåç§°.find()`ï¼šæŸ¥è¯¢è¯¥è¡¨ä¸­çš„æ•°æ®(æ–‡æ¡£)

<br>

## æ–‡æ¡£æ“ä½œ

1. `db.é›†åˆåç§°.insertOne(æ–‡æ¡£å¯¹è±¡)`ï¼šå‘é›†åˆä¸­æ’å…¥ä¸€ä¸ªæ–‡æ¡£

```bash
db.student.insertOne({ name: 'å°æ˜', age: 18 })
```

<br>

2. `db.é›†åˆåç§°.insertMany([æ–‡æ¡£å¯¹è±¡1, æ–‡æ¡£å¯¹è±¡2, ...])`ï¼šå‘é›†åˆä¸­æ’å…¥å¤šä¸ªæ–‡æ¡£

```bash
db.student.insertMany([{ name: 'å°çº¢', age: 18 }, { name: 'å°é»„', age: 19 }])
```

<br>

3. `db.é›†åˆåç§°.updateOne(æŸ¥è¯¢æ¡ä»¶, æ›´æ–°å†…å®¹)`ï¼šæ›´æ–°ä¸€ä¸ªæ–‡æ¡£

```bash

```

<br>

4. `db.é›†åˆåç§°.updateMany(æŸ¥è¯¢æ¡ä»¶, æ›´æ–°å†…å®¹)`ï¼šæ›´æ–°å¤šä¸ªæ–‡æ¡£

```bash

```

<br>

5. `db.é›†åˆåç§°.remove(æŸ¥è¯¢æ¡ä»¶)`ï¼šåˆ é™¤ä¸€ä¸ªæ–‡æ¡£

```bash

```

<br>

6. `db.é›†åˆåç§°.deleteMany(æŸ¥è¯¢æ¡ä»¶)`ï¼šåˆ é™¤å¤šä¸ªæ–‡æ¡£

```bash

```

<br><br>

# mongoose

node.js çš„ç¬¬ä¸‰æ–¹æ¨¡å— mongooseï¼Œç”¨äºæ“ä½œ MongoDB æ•°æ®åº“

1. åˆå§‹åŒ–é¡¹ç›®ï¼š`npm init -y`
2. ä¸‹è½½ mongoose æ¨¡å—ï¼š`npm i mongoose`
3. å¼•å…¥ mongoose æ¨¡å—ï¼š`const mongoose = require('mongoose')`
4. è¿æ¥æ•°æ®åº“ï¼š

```js
// localhost - æ•°æ®åº“çš„ ip åœ°å€
// 27017 - MongoDB çš„ç«¯å£å·ï¼Œé»˜è®¤ä¸º 27017
// node - æ•°æ®åº“åï¼Œè¡¨ç¤ºä½¿ç”¨è¯¥æ•°æ®åº“ï¼›æ²¡æœ‰åˆ™è‡ªåŠ¨åˆ›å»º
mongoose.connect('mongodb://localhost:27017/node').then(
    (_) => {
        console.log('è¿æ¥æˆåŠŸï¼');
    },
    (reason) => {
        console.log('è¿æ¥å¤±è´¥ï¼', reason);
    }
);
```

4. æ–­å¼€æ•°æ®åº“è¿æ¥ï¼š`mongoose.disconnect()`

<br>

å¯é€šè¿‡ç›‘å¬ `open` & `close` äº‹ä»¶ï¼Œæ¥ç›‘å¬æ•°æ®åº“çš„è¿æ¥ä¸æ–­å¼€ï¼š

```js
mongoose.connection.once('open', () => {
    // once è¡¨ç¤ºç›‘å¬ä¸€æ¬¡
    console.log('æ•°æ®åº“å·²è¿æ¥');
});
mongoose.connection.on('close', () => {
    // on æ ‡ç­¾ç›‘å¬
    console.log('æ•°æ®åº“å·²æ–­å¼€');
});
```

<br><br>

# Schema æ¨¡å¼

Schema æ˜¯ mongoose çš„ä¸€ä¸ªæ–¹æ³•ï¼Œå¯ä»¥è®¾è®¡è¡¨ç»“æ„ï¼Œç”¨äºåˆ›å»º model æ¨¡å‹

<br>

**MongoDB æ”¯æŒçš„æ•°æ®ç±»å‹**ï¼šâ‘  Stringã€â‘¡ Numberã€â‘¢ Booleanã€â‘£ Dateã€â‘¤ Arrayã€â‘¥ ObjectIDã€â‘¦ Bufferã€â‘§ Mapã€â‘¨ Schema

-   æ·»åŠ æ•°æ®æ—¶ï¼Œå¦‚æœæ•°æ®ç±»å‹å†™é”™äº†ï¼ŒMongoDB ä¼šè¿›è¡Œéšå¼ç±»å‹è½¬æ¢ï¼›å¦‚æœè½¬æ¢ä¸æˆåŠŸï¼Œåˆ™æŠ›å‡ºé”™è¯¯

-   MongoDB æ²¡æœ‰ Object ç±»å‹ï¼Œå¦‚æœå¼ºè¡Œè®¾ç½®ä¸º Object ç±»å‹ï¼Œä¼šè½¬ä¸º Array ç±»å‹

```js
// åˆ›å»º Schema å®ä¾‹
const studentSchema = new mongoose.Schema({
    name: String,
    age: Number,
    course: Array,
});
// åˆ›å»º Student é›†åˆ
const StudentModel = mongoose.model('Student', studentSchema);
```

<br>

**é…ç½® Schema**ï¼š

-   `timestamps`ï¼šä¸º `true` æ—¶ï¼Œä¼šæ·»åŠ  `createdAt` & `updatedAt` ä¸¤ä¸ªå­—æ®µï¼Œä»£è¡¨ [åˆ›å»ºæ—¶é—´] & [æ›´æ–°æ—¶é—´]
-   `versionKey`ï¼šä¸º `false` æ—¶ï¼Œä¸ä¼šæ·»åŠ ç‰ˆæœ¬å· `__v` å­—æ®µ

```js
const studentSchema = new mongoose.Schema(
    {
        name: String,
        age: Number,
        course: Array,
    },
    {
        timestamps: true,
        versionKey: false,
    }
);
```

æ³¨æ„ï¼šæˆ‘ä»¬è¦åœ¨åˆ›å»ºè¡¨æ—¶å°±ç¡®å®šè¡¨ç»“æ„ï¼Œç¡®å®šåä¸è¦è½»æ˜“æ›´æ”¹ï¼

<br><br>

# è¡¨çº¦æŸ

## é€šç”¨çº¦æŸ

1. `require`ï¼šBooleanï¼›æ˜¯å¦å¿…éœ€å¡«å†™ã€‚å¦‚æœä¸º `true`ï¼Œæ²¡å¡«å†™æ—¶ä¼šæŠ›å‡ºé”™è¯¯ã€‚å¯ä»¥å†™ä¸º `require: [true, "message"]`ï¼Œåé¢çš„ `"message"` æ˜¯æŠ¥é”™ä¿¡æ¯ã€‚
2. `default`ï¼šæŒ‡å®šé»˜è®¤å€¼ã€‚å¯ä»¥æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚å¦‚æœæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåˆ™é»˜è®¤å€¼ä¸ºè¯¥å‡½æ•°çš„è¿”å›å€¼ã€‚
3. `validate`ï¼šè‡ªå®šä¹‰éªŒè¯ã€‚æœ‰ä¸€ä¸ª `validator` æ–¹æ³• & ä¸€ä¸ª `message` å±æ€§ã€‚`validator` çš„å‚æ•°ä¸ºå½“å‰å­—æ®µï¼›`return true` è¡¨ç¤ºé€šè¿‡éªŒè¯ï¼Œ`return false` åˆ™æŠ›å‡ºé”™è¯¯ï¼Œé”™è¯¯ä¿¡æ¯ä¸º `message`ã€‚

```js
const studentSchema = new mongoose.Schema({
    name: {
        type: String,
        required: true,
        validate: {
            validator(name) {
                if (name.length <= 5) return true;
                return false;
            },
            message: 'name is too long',
        },
    },
    age: {
        type: Number,
        required: [true, 'age is required'],
        default: 21,
    },
    course: {
        type: Array,
        default: ['HTML', 'CSS', 'JS'],
    },
});
```

<br>

## String çº¦æŸ

1. `lowercase`ï¼šBooleanï¼›å°å†™
2. `uppercase`ï¼šBooleanï¼›å¤§å†™
3. `trim`ï¼šBooleanï¼›å»é™¤ç©ºæ ¼
4. `minlength`ï¼šNumberï¼›æœ€å°é•¿åº¦
5. `maxlength`ï¼šNumberï¼›æœ€å¤§é•¿åº¦
6. `enum`ï¼šArrayï¼›åªèƒ½å¡«å†™ Array ä¸­çš„å…ƒç´ 
7. `match`ï¼šRegexï¼›éœ€åŒ¹é…æ­£åˆ™

```js
const studentSchema = new Schema({
    name: {
        type: String,
        trim: true,
        enum: ['superman', 'superwoman'],
    },
    age: Number,
    course: Array,
});
```

<br>

## Number çº¦æŸ

1. `min`ï¼šæœ€å°æ•°å€¼
2. `max`ï¼šæœ€å¤§æ•°å€¼

```js
const studentSchema = new Schema({
    name: String,
    age: {
        type: Number,
        min: 18,
    },
    course: Array,
});
```

<br>

## Array [å…ƒç´ çš„] çº¦æŸ

1. `type`ï¼šè®¾ç½®æ•°ç»„å…ƒç´ çš„ç±»å‹ï¼ˆå¯ç”¨ç±»å‹å‚è€ƒ MongoDB æ”¯æŒçš„æ•°æ®ç±»å‹ï¼‰ï¼›åªè®¾ç½® `type` æ—¶å¯ç›´æ¥å†™å±æ€§å€¼

```js
const studentSchema = new Schema({
    name: String,
    age: Number,
    course: [String], // ä¼šå°†å…ƒç´ éšå¼è½¬æ¢ä¸º String ç±»å‹, è½¬ä¸äº†åˆ™æŠ¥é”™
});
```

2. `minlength` / `maxlength`ï¼šè®¾ç½®æ•°ç»„å…ƒç´ çš„é•¿åº¦

```js
const studentSchema = new Schema({
    name: String,
    age: Number,
    course: [
        {
            type: String,
            minlength: 4, // å…ƒç´ çš„æœ€å°é•¿åº¦ä¸º 4
        },
    ],
});
```

-   å¯ä»¥å‘ç°ï¼Œå…¶å®å°±æ˜¯å°†é…ç½®å¯¹è±¡å†™åˆ° `[]` é‡Œé¢å•¦~

<br><br>

# æ·»åŠ æ•°æ®

## save

åˆ›å»ºæ¨¡å‹å®ä¾‹ `StudentModel`ï¼Œè°ƒç”¨ `save` æ–¹æ³•ï¼š

```js
new StudentModel({
    name: 'å°é™ˆ',
    age: 20,
    course: ['C++', 'Java'],
}).save((err, result) => {
    if (err) console.log('err', err);
    else console.log('result', result);
});
```

æ‰“å°çš„æ•°æ®ï¼š

```js
result {
  name: 'å°é™ˆ',
  age: 20,
  course: [ 'C++', 'Java' ],
  _id: new ObjectId("622b317092def5225f02c6b7"),
  __v: 0
}
```

å¯ä»¥çœ‹è§ï¼ŒMongoDB è‡ªåŠ¨ç»™æˆ‘ä»¬æ·»åŠ äº† `_id` å±æ€§ï¼Œè¿™æ˜¯æ•°æ®çš„å”¯ä¸€æ ‡è¯†

<br>

## create

`model.create(dataObj, (err, result) => {})`ï¼š

```js
StudentModel.create(
    {
        name: 'å°é»„',
        age: 21,
        course: ['HTML', 'CSS', 'JS'],
    },
    (err, result) => {
        if (err) console.log('err', err);
        else console.log('result', result);
    }
);
```

<br>

æ·»åŠ å¤šä¸ªæ•°æ® `model.create(dataObj1, dataObj2, (err, result1, result2) => {})`ï¼š

```js
StudentModel.create(
    {
        // ä¼ å…¥å¤šä¸ªå¯¹è±¡
        name: 'å°èƒ¡',
        age: 20,
        course: ['MongoDB'],
    },
    {
        name: 'å°å‚…',
        age: 20,
        course: ['Go'],
    },
    (err, result1, result2) => {
        // æ¥æ”¶ä¼šå¤šä¸ªå¯¹è±¡å‚æ•°
        if (err) console.log('err', err);
        else {
            console.log('result1', result1);
            console.log('result2', result2);
        }
    }
);
```

<br>

æ·»åŠ å¤šä¸ªæ•°æ® `model.create([dataObj1, dataObj2], (err, resultArr) => {})`ï¼š

```js
StudentModel.create(
    [
        {
            // ä¼ å…¥ä¸€ä¸ªæ•°ç»„
            name: 'å°éƒ‘',
            age: 20,
            course: ['MySQL'],
        },
        {
            name: 'å°ä»²',
            age: 22,
            course: [],
        },
    ],
    (err, result) => {
        // æ¥æ”¶å›ä¸€ä¸ªæ•°ç»„å‚æ•°
        if (err) console.log('err', err);
        else console.log('result', result);
    }
);
```

<br><br>

# æŸ¥è¯¢æ•°æ®

## find

æŸ¥è¯¢æ‰€æœ‰æ•°æ® `model.find((err, result) => {})` ä»¥æ•°ç»„çš„å½¢å¼è¿”å›è¡¨ä¸­çš„æ•°æ®ï¼›æ— æ•°æ®åˆ™è¿”å›ç©ºæ•°ç»„ï¼š

```js
StudentModel.find((err, result) => {
    if (err) console.log('err', err);
    else console.log('result', result);
});
```

<br>

æ ¹æ®æ¡ä»¶æŸ¥è¯¢ `æ¨¡å‹.find(conditions, (err, result) => {})`ï¼š

`æ¨¡å‹.find({ key: value }, (err, result) => {})`ï¼š

```js
StudentModel.find(
    {
        age: 21,
    },
    (err, result) => {
        if (err) console.log('err', err);
        else console.log('result', result);
    }
);
```

`æ¨¡å‹.find({ key: æ­£åˆ™ }, (err, result) => {})`ï¼š

```js
StudentModel.find(
    {
        name: /å°å‚…/,
    },
    (err, result) => {
        if (err) console.log('err', err);
        else console.log('result', result);
    }
);
```

ä½¿ç”¨ `$gt` - å¤§äºã€`$gte` - å¤§äºç­‰äºã€`$lt` - å°äºã€`$lte` - å°äºç­‰äºã€`$ne` - ä¸ç­‰äºï¼š

```js
StudentModel.find(
    {
        age: { $gte: 21 }, // å¹´é¾„ >= 21 çš„
    },
    (err, result) => {
        if (err) console.log('err', err);
        else console.log('result', result);
    }
);
```

`$exists` - å­˜åœ¨æŸå±æ€§ï¼š

```js
StudentModel.find(
    {
        name: { $exists: false }, // æ²¡æœ‰è®¾ç½® name å±æ€§çš„
    },
    (err, result) => {
        if (err) console.log('err', err);
        else console.log('result', result);
    }
);
```

> æ³¨æ„ï¼šå¦‚æœæ˜¯ä¸€ä¸ªä¸å­˜åœ¨çš„å­—æ®µï¼Œæ¯”å¦‚ `gender`ï¼Œä¸è®º `$exists` ä¸ºä½•å€¼ï¼Œéƒ½ä¼šè¿”å›æ‰€æœ‰çš„æ•°æ®

```js
StudentModel.find(
    {
        gender: { $exists: true },
    },
    (err, result) => {
        if (err) console.log('err', err);
        else console.log('result', result);
    }
);
```

`$size` - **æ•°ç»„**é•¿åº¦åŒ¹é…ï¼š

```js
StudentModel.find(
    {
        course: { $size: 2 },
    },
    (err, result) => {
        if (err) console.log('err', err);
        else console.log('result', result);
    }
);
```

`$in` / `$nin` - åœ¨ / ä¸åœ¨æŒ‡å®šçš„å¤šä¸ªå­—æ®µä¹‹å†…ï¼š

```js
StudentModel.find(
    {
        name: { $in: ['å°è°¢', 'å°èƒ¡'] }, // åå­—åœ¨ ["å°è°¢", "å°èƒ¡"] é‡Œé¢çš„
    },
    (err, result) => {
        if (err) console.log('err', err);
        else console.log('result', result);
    }
);
```

`$all` - **æ•°ç»„**ä¸­æ˜¯å¦å­˜åœ¨æŒ‡å®šçš„æ‰€æœ‰é¡¹ï¼š

```js
StudentModel.find(
    {
        course: { $all: ['C++', 'Java'] },
    },
    (err, result) => {
        if (err) console.log('err', err);
        else console.log('result', result);
    }
);
```

`$or` / `$nor` - æˆ–è€… / æˆ–è€…å–åï¼š

```js
StudentModel.find(
    {
        $or: [{ name: 'å°é™ˆ' }, { age: 22 }], // åå­—ä¸º [å°é™ˆ] æˆ–è€… age ä¸º [22] çš„
    },
    (err, result) => {
        if (err) console.log('err', err);
        else console.log('result', result);
    }
);
```

`$where` - å¯ä»¥ä½¿ç”¨ JS ä»£ç  / å‡½æ•°ï¼š

```js
StudentModel.find(
    {
        $where: 'this.age === 20',
    },
    (err, result) => {
        if (err) console.log('err', err);
        else console.log('result', result);
    }
);
```

<br>

è¿”å›æŒ‡å®šå­—æ®µ - `model.find(conditions, projection, (err, result) => {})`

-   `{ name: 1 }`ï¼šåªæ˜¾ç¤º `name` å±æ€§ & `_id` å±æ€§
-   `{ age: 1, _id: 0 }`ï¼šåªæ˜¾ç¤º `name` å±æ€§

```js
StudentModel.find(null, { name: 1, _id: 0 }, (err, result) => {
    if (err) console.log('err', err);
    else console.log('result', result);
});
```

<br>

è®¾ç½®è¿”å›çš„æ•°æ®æ ¼å¼ - `æ¨¡å‹.find(conditions, projection, options, (err, result) => {})`

-   `{ sort: { age: 1 } }`ï¼šæŒ‰ç…§ age é¡¹ï¼Œå‡åºæ’åˆ—ï¼›`-1` åˆ™é™åºæ’åº
-   `{ skip: 2 }`ï¼šç•¥è¿‡å‰ 2 æ¡æ•°æ®
-   `{ limit: 5 }`ï¼šæœ€å¤šè¿”å› 5 æ¡æ•°æ®

```js
StudentModel.find(null, null, { sort: { age: 1 }, limit: 3 }, (err, result) => {
    if (err) console.log('err', err);
    else console.log('result', result);
});
```

<br>

## findOne

è¿”å›ç¬¬ä¸€ä¸ªæŸ¥æ‰¾åˆ°çš„æ•°æ®ï¼Œæ— æ•°æ®åˆ™è¿”å› `null`

```js
StudentModel.findOne((err, result) => {
    if (err) console.log('err', err);
    else console.log('result', result);
});
```

<br>

## findbyId

æ ¹æ® id æŸ¥è¯¢ - `model.findById(id, (err, result) => {})` è¿”å›æŒ‡å®šæ•°æ®ï¼Œä¸å­˜åœ¨è¯¥æ•°æ®åˆ™è¿”å› `null`ï¼š

```js
StudentModel.findById('6229fd57809fbf2dc34f83dd', (err, result) => {
    if (err) console.log('err', err);
    else console.log('result', result);
});
```

<br><br>

# æ›´æ”¹æ•°æ®

## updateOne

æ›´æ”¹ä¸€ä¸ªæ•°æ® - `model.updateOne(condition, newData, callback)`ï¼š

```js
StudentModel.updateOne(
    { name: 'å°ä»²' },
    {
        course: ['æ‘¸é±¼'],
    },
    (err, result) => {
        if (err) console.log('err', err);
        else console.log('result', result);
    }
);
```

<br>

## updateMany

æ›´æ”¹å¤šä¸ªæ•°æ® - `æ¨¡å‹.updateMany(condition, newData, callback)`ï¼š

```js
StudentModel.updateMany(
    { name: 'å°é»„' },
    {
        $inc: { age: 1 }, // age + 1
    },
    (err, result) => {
        if (err) console.log('err', err);
        else console.log('result', result);
    }
);
```

<br>

## findByIdAndUpdate

æ ¹æ® id æ›´æ”¹æ•°æ®- `æ¨¡å‹.findByIdAndUpdate(id, newData, (err, oldData)=>{})`ï¼š

```js
StudentModel.updateOne(
    '622aea67f487ff334ba925d4',
    {
        // åˆ é™¤ age å­—æ®µ, å±æ€§å€¼éšä¾¿å†™, åæ­£éƒ½è¢«åˆ é™¤äº†
        $unset: { age: 0 },
    },
    (err, result) => {
        if (err) console.log('err', err);
        else console.log('result', result);
    }
);
```

<br>

**æ›´æ–°æ•°ç»„å…ƒç´ **ï¼š

`$push: { arr: XXX }` - ä¸ºæ•°ç»„æ·»åŠ å…ƒç´  XXXï¼š

```js
StudentModel.updateMany(
    { name: 'å°é»„' },
    {
        $push: { course: 'Vue' }, // ä¸ºæ•°ç»„æ·»åŠ å…ƒç´ 
    },
    (err, result) => {
        if (err) console.log('err', err);
        else console.log('result', result);
    }
);
```

`$addToSet: { arr: XXX }` - ä¸ºæ•°ç»„æ·»åŠ å…ƒç´  XXXï¼Œå¦‚æœ XXX å·²å­˜åœ¨åˆ™ä¸æ·»åŠ ï¼š

```js
StudentModel.updateOne(
    { name: 'å°é»„' },
    {
        $addToSet: { course: 'React' }, // ä¸ºæ•°ç»„æ·»åŠ å…ƒç´ , å¦‚æœå·²å­˜åœ¨åˆ™ä¸æ·»åŠ 
    },
    (err, result) => {
        if (err) console.log('err', err);
        else console.log('result', result);
    }
);
```

`$pop: { arr: 1 }` - åˆ é™¤æ•°ç»„çš„æœ€åä¸€é¡¹ï¼›å¦‚æœè®¾ç½®ä¸º `-1` åˆ™åˆ é™¤ç¬¬ä¸€é¡¹ï¼š

```js
StudentModel.updateOne(
    { name: 'å°é»„' },
    {
        $pop: { course: 1 }, // åˆ é™¤æ•°ç»„çš„æœ€åä¸€é¡¹; å€¼ä¸º -1 åˆ™åˆ é™¤ç¬¬ä¸€é¡¹
    },
    (err, result) => {
        if (err) console.log('err', err);
        else console.log('result', result);
    }
);
```

`$pull: { arr: XXX }` - åˆ é™¤æ•°ç»„æ‰€æœ‰å€¼ä¸º XXX çš„å…ƒç´ ï¼š

```js
StudentModel.updateOne(
    { name: 'å°é»„' },
    {
        $pull: { course: 'class' }, // åˆ é™¤æ•°ç»„çš„æ‰€æœ‰ class å€¼
    },
    (err, result) => {
        if (err) console.log('err', err);
        else console.log('result', result);
    }
);
```

<br><br>

# åˆ é™¤æ•°æ®

## remove

åˆ é™¤æ‰€æœ‰æ•°æ® - `model.remove((err, result) => {})`ï¼š

```js
StudentModel.remove((err, result) => {
    if (err) console.log('err', err);
    else console.log('result', result);
});
```

<br>

æ ¹æ®æ¡ä»¶åˆ é™¤ - `model.remove({key, value}, (err, result) => {})`ï¼š

```js
StudentModel.remove({ name: 'å°èƒ¡' }, (err, result) => {
    if (err) console.log('err', err);
    else console.log('result', result);
});
```

<br>

## findByIdAndRemove

æ ¹æ® id åˆ é™¤ - `model.findByIdAndRemove(id, (err, result) => {})`ï¼š

```js
StudentModel.findByIdAndRemove('6229febe332cf70aa225c6b4', (err, result) => {
    if (err) console.log('err', err);
    else console.log('result', result);
});
```

<br>

## deleteOne

åˆ é™¤ä¸€ä¸ªæ•°æ® - `model.deleteOne(condition, (err, result) => {})`ï¼š

```js
Student.deleteOne({ name: 'å°å‚…' }, (err, result) => {
    if (err) console.log('err', err);
    else console.log('result', result);
});
```

<br>

## deleteMany

åˆ é™¤å¤šä¸ªæ•°æ® - `model.deleteMany(condition, (err, result) => {})`ï¼š

```js
Student.deleteMany({ name: 'å°éƒ‘' }, (err, result) => {
    if (err) console.log('err', err);
    else console.log('result', result);
});
```

<br><br>

# ä¸­é—´ä»¶

å‰åé’©å­ï¼Œå³ `pre()` å’Œ `post()` æ–¹æ³•

å¯ä»¥åœ¨æ‰§è¡Œä»¥ä¸‹æ“ä½œæ—¶è®¾ç½®å‰åé’©å­ï¼š`init`ã€`validate`ã€`save`ã€`remove`ã€`count`ã€`find`ã€`findOne`ã€`findOneAndRemove`ã€`findOneAndUpdate`ã€`insertMany`ã€`update`

```js
const mongoose = require('mongoose');

mongoose.connect('mongodb://localhost:27017/demo').then(
    (_) => {
        console.log('è¿æ¥æˆåŠŸï¼'); // 2
    },
    (reason) => {
        console.log('è¿æ¥å¤±è´¥ï¼', reason);
    }
);

// åˆ›å»º Schema æ¨¡å¼å®ä¾‹
const studentSchema = new mongoose.Schema(
    {
        name: String,
        age: Number,
    },
    { versionKey: false }
);

// è®¾ç½®é’©å­å‡½æ•°
studentSchema.pre('findOne', (next) => {
    console.log('pre'); // 1
    next();
});
studentSchema.post('findOne', (res) => {
    console.log('post', 'res', res); // 3
});

// åˆ›å»ºè¡¨æ¨¡å‹
const StudentModel = mongoose.model('Student', studentSchema);

// è°ƒç”¨ findOne æ–¹æ³•
StudentModel.findOne((err, result) => {
    if (err) console.log('err', err);
    else console.log('result', result); // 4
});
```

<br><br>

# å¤šè¿æ¥

`mongoose.createConnection()` è¿”å›é“¾æ¥å¯¹è±¡ï¼š

```js
const mongoose = require('mongoose');

// åˆ›å»ºå¤šè¿æ¥
const con1 = mongoose.createConnection('mongodb://localhost:27017/demo');
const con2 = mongoose.createConnection('mongodb://localhost:27017/demo');
```

æ— è®ºæ˜¯ä½¿ç”¨ `mongoose.connect` / `mongoose.createConnection` åˆ›å»ºçš„è¿æ¥ï¼Œå…¶è¿æ¥æ± é»˜è®¤åªèƒ½è¿æ¥ 5 ä¸ªï¼Œå¯é€šè¿‡ `poolSize` è®¾ç½®ã€‚

```js
mongoose.createConnection(url, {
    poolSize: 4, // è®¾ç½®è¿æ¥æ± çš„è¿æ¥æ•°ä¸º 4
});
```

<br><br>

# è¡¨å…³è”

```js
const mongoose = require('mongoose');

mongoose.connect('mongodb://localhost:27017/node').then(
    (_) => {
        console.log('è¿æ¥æˆåŠŸï¼');
    },
    (reason) => {
        console.log('è¿æ¥å¤±è´¥ï¼', reason);
    }
);

const Schema = mongoose.Schema;

const studentSchema = new Schema({
    name: String,
    age: Number,
    course: Array,
});
const StudentModel = mongoose.model('Student', studentSchema);

const scoreSchema = new Schema({
    pass: Boolean,
    author: [
        {
            type: Schema.Types.ObjectId,
            ref: StudentModel, // å…³è” StudentModel
        },
    ],
});
const ScoreModel = mongoose.model('Score', scoreSchema);

// ScoreModel.create(
//     {
//         pass: true,
//         author: '622b321bbeaecc99728c70ee', // è¿™é‡Œå¡«å…¥æŸæ¡è®°å½•çš„ _id
//     },
//     (err, result) => {
//         if (err) console.log('err', err);
//         else console.log('result', result);
//     }
// );

ScoreModel.find()
    .populate('author') // å…³è”æŸ¥è¯¢
    .exec((err, result) => {
        if (err) console.log('err', err);
        else {
            console.log('result', result[0]);
            console.log('author', result[0].author[0]);
        }
    });
```

<br><br>

# MongoDB & sessionID

```html
<body>
    <h1 id="bb">åå­—</h1>
    <button id="box">ç‚¹å‡»</button>
</body>

<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
    box.onclick = () => {
        axios({
            method: 'post',
            url: '/register',
            data: { name: 'superman' },
        }).then((res) => console.log('data', res.data));
    };

    // å…ç™»å½•
    (() => {
        axios({ url: '/getSession' }).then((res) => {
            console.log('data', res.data);
            bb.innerText = res.data.value;
        });
    })();
</script>
```

```js
const express = require('express');
const app = express();
app.listen(8080, () => console.log('http://127.0.0.1:8080'));

app.use(express.static('./public'));

// è§£æ post çš„æ•°æ®
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// ä½¿ç”¨ mongoose
const mongoose = require('mongoose');
mongoose
    .connect('mongodb://localhost:27017/node')
    .then(() => console.log('è¿æ¥æˆåŠŸï¼'))
    .catch(() => console.log('è¿æ¥å¤±è´¥ï¼'));
const userSchema = new mongoose.Schema({
    name: String,
    pass: String,
});
const UserModel = mongoose.model('User', userSchema);

// å°† session æ”¾å…¥æ•°æ®åº“
const session = require('express-session'); // ç”¨äºæ“ä½œ session
const MongoStore = require('connect-mongo'); // ç”¨äºå­˜å‚¨ session åˆ° MongoDB
app.use(
    session({
        secret: 'keyboard cat', // åŠ å¯†çš„å­—ç¬¦ä¸², é‡Œé¢å†…å®¹å¯ä»¥éšä¾¿å†™
        resave: false, // å¼ºåˆ¶ä¿å­˜ session, å³ä½¿å®ƒæ²¡å˜åŒ–
        saveUninitialized: true, // å¼ºåˆ¶å°†æœªåˆå§‹åŒ–çš„ session å­˜å‚¨, é»˜è®¤ä¸º true
        // é…ç½® cookie
        cookie: {
            maxAge: 1000 * 60 * 60 * 24, // æœ‰æ•ˆæœŸä¸º 1 å¤©
            secure: false, // æ˜¯å¦ä»… https å¯ç”¨
        },
        store: MongoStore.create({
            mongoUrl: 'mongodb://localhost:27017/node',
        }), // å­˜å…¥ MongoDB
    })
);

// é…ç½® session
app.post('/register', (req, res) => {
    req.session.user = req.body; // æ·»åŠ  session å±æ€§
    console.log('session', req.session); // è·å– session
    res.send('è®¾ç½® session');
});

// å…ç™»å½•
app.get('/getSession', async (req, res) => {
    console.log('name', req.session.name);
    if (req.session.user) {
        // åœ¨ MongoDB ä¸­æŸ¥è¯¢ã€è·å–ç”¨æˆ·æ•°æ®
        const result = await UserModel.findOne({ name: 'superman' });
        res.send({
            code: 1,
            value: req.session.user.name, // è·å– session å±æ€§
            result,
        });
    } else {
        res.send({ code: 0, value: 'è¿‡æœŸäº†' });
    }
});
```

<br>
