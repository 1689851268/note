# ä»€ä¹ˆæ˜¯è·¨åŸŸ

è·¨åŸŸæ˜¯æŒ‡å½“æˆ‘ä»¬ä»ä¸€ä¸ªé¡µé¢è¯·æ±‚å¦ä¸€ä¸ª URL æ—¶, å¦‚æœè¯·æ±‚çš„ URL ä¸å½“å‰é¡µé¢ URL çš„**åè®®ã€åŸŸåã€ç«¯å£å·**ä¸‰è€…ä¸­ä»»æ„ä¸€ä¸ªä¸åŒ, å°±ä¼šäº§ç”Ÿè·¨åŸŸé—®é¢˜.

<br>

## è·¨åŸŸåˆ¤æ–­æ ‡å‡†

| å½“å‰é¡µé¢ URL                  | è¯·æ±‚ URL                          | è·¨åŸŸåŸå›                  | æ˜¯å¦è·¨åŸŸ |
| ----------------------------- | --------------------------------- | ------------------------ | -------- |
| `http://www.example.com`      | `https://www.example.com`         | åè®®ä¸åŒ (http vs https) | âœ… æ˜¯    |
| `http://www.example.com`      | `http://api.example.com`          | å­åŸŸåä¸åŒ               | âœ… æ˜¯    |
| `http://www.example.com`      | `http://www.other.com`            | åŸŸåä¸åŒ                 | âœ… æ˜¯    |
| `http://www.example.com:8080` | `http://www.example.com:3000`     | ç«¯å£ä¸åŒ                 | âœ… æ˜¯    |
| `http://www.example.com:8080` | `http://www.example.com:8080/api` | åªæœ‰è·¯å¾„ä¸åŒ             | âŒ å¦    |

<br><br>

# åŒæºç­–ç•¥æœºåˆ¶

## ä»€ä¹ˆæ˜¯åŒæºç­–ç•¥

è·¨åŸŸé—®é¢˜çš„æ ¹æœ¬åŸå› æ˜¯**æµè§ˆå™¨çš„åŒæºç­–ç•¥** (Same-Origin Policy), è¿™æ˜¯æµè§ˆå™¨çš„ä¸€ä¸ªé‡è¦å®‰å…¨æœºåˆ¶.

**è·¨åŸŸè¯·æ±‚æŠ¥é”™çš„ä¸‰ä¸ªå¿…è¦æ¡ä»¶:**

1. âœ… æµè§ˆå™¨åŒæºç­–ç•¥å­˜åœ¨
2. âœ… è¯·æ±‚æ˜¯ AJAX ç±»å‹ (åŒ…æ‹¬ fetchã€XMLHttpRequest)
3. âœ… è¯·æ±‚ç¡®å®è·¨åŸŸäº†

<br>

## åŒæºç­–ç•¥çš„å®‰å…¨ä½œç”¨

åŒæºç­–ç•¥æ˜¯å‡ºäº**å®‰å…¨è€ƒè™‘**è€Œè®¾ç«‹çš„:

1. **é˜²æ­¢æ¶æ„ç½‘ç«™çªƒå–æ•°æ®**

    - é˜²æ­¢æ¶æ„ç½‘ç«™è¯»å–å…¶ä»–ç½‘ç«™çš„æ•æ„Ÿä¿¡æ¯
    - ä¿æŠ¤ç”¨æˆ·çš„éšç§å’Œæ•°æ®å®‰å…¨

2. **é˜²æ­¢ CSRF æ”»å‡»**

    - é˜²æ­¢æ¶æ„ç½‘ç«™ä¼ªé€ ç”¨æˆ·èº«ä»½è¿›è¡Œæ“ä½œ
    - é¿å…è·¨ç«™è¯·æ±‚ä¼ªé€ æ”»å‡»

3. **ä¿æŠ¤ç½‘ç«™èµ„æº**
    - é˜²æ­¢å…¶ä»–ç½‘ç«™æ— æˆæƒåœ°è°ƒç”¨ API æ¥å£
    - ä¿æŠ¤æœåŠ¡å™¨èµ„æºä¸è¢«æ»¥ç”¨

<br>

## åŒæºç­–ç•¥çš„é™åˆ¶èŒƒå›´

åŒæºç­–ç•¥ä¼šé™åˆ¶ä»¥ä¸‹è¡Œä¸º:

-   ğŸš« æ— æ³•è¯»å–éåŒæºç½‘é¡µçš„ Cookieã€LocalStorage å’Œ IndexedDB
-   ğŸš« æ— æ³•æ¥è§¦éåŒæºç½‘é¡µçš„ DOM
-   ğŸš« æ— æ³•å‘éåŒæºåœ°å€å‘é€ AJAX è¯·æ±‚ (å¯ä»¥å‘é€, ä½†æµè§ˆå™¨ä¼šæ‹’ç»æ¥å—å“åº”)

<br>

**é‡è¦è¯´æ˜:** åªæœ‰ AJAX è¯·æ±‚æ‰ä¼šäº§ç”Ÿè·¨åŸŸé—®é¢˜! åƒ `<script>`ã€`<img>`ã€`<link>`ã€`<iframe>`ã€`<form>` ç­‰æ ‡ç­¾åŠ è½½è·¨åŸŸèµ„æºæ˜¯ä¸å—åŒæºç­–ç•¥é™åˆ¶çš„.

```html
<!-- âœ… è¿™äº›æ ‡ç­¾å¯ä»¥è·¨åŸŸåŠ è½½èµ„æº -->
<script src="https://cdn.example.com/library.js"></script>
<img src="https://images.example.com/photo.jpg" />
<link rel="stylesheet" href="https://styles.example.com/style.css" />
<iframe src="https://other.example.com/page.html"></iframe>
```

<br><br>

# CORS è·¨åŸŸè§£å†³æ–¹æ¡ˆ

## CORS åŸºæœ¬åŸç†

**CORS** (Cross-Origin Resource Sharing) è·¨åŸŸèµ„æºå…±äº«, æ˜¯ç›®å‰æœ€ä¸»æµå’Œæ¨èçš„è·¨åŸŸè§£å†³æ–¹æ¡ˆ.

CORS æ˜¯ä¸€ç§åŸºäº HTTP å¤´çš„æœºåˆ¶, å¯ä»¥è®©æœåŠ¡å™¨æŒ‡å®šå“ªäº›æ¥æºå¯ä»¥è®¿é—®å®ƒçš„èµ„æº:

1. æµè§ˆå™¨åœ¨å‘é€è·¨åŸŸè¯·æ±‚æ—¶, ä¼šåœ¨è¯·æ±‚å¤´ä¸­åŠ å…¥ `Origin` å­—æ®µ
2. æœåŠ¡å™¨åœ¨å“åº”æ—¶, ä¼šåœ¨å“åº”å¤´ä¸­åŠ å…¥ `Access-Control-Allow-Origin` å­—æ®µ
3. å¦‚æœæµè§ˆå™¨å‘ç°è¯¥å­—æ®µçš„å€¼åŒ…å«äº†è¯·æ±‚çš„æ¥æºæˆ–è€…æ˜¯ `*`, åˆ™è®¤ä¸ºè·¨åŸŸæˆåŠŸ

<br>

## ç®€å•è¯·æ±‚ä¸å¤æ‚è¯·æ±‚

**ç®€å•è¯·æ±‚ (ä¸è§¦å‘é¢„æ£€)** éœ€æ»¡è¶³ä»¥ä¸‹æ‰€æœ‰æ¡ä»¶:

**è¯·æ±‚æ–¹æ³•:**

```
GET
HEAD
POST
```

**å…è®¸çš„è¯·æ±‚å¤´:**

```
Accept
Accept-Language
Content-Language
Content-Type (ä½†æœ‰å€¼é™åˆ¶)
```

**Content-Type çš„é™åˆ¶å€¼:**

```
application/x-www-form-urlencoded
multipart/form-data
text/plain
```

<br>

**å¤æ‚è¯·æ±‚ (è§¦å‘é¢„æ£€è¯·æ±‚)** åŒ…å«ä»¥ä¸‹æƒ…å†µ:

**ä¸è¢«å…è®¸çš„è¯·æ±‚æ–¹æ³•:**

```
PUT
DELETE
PATCH
OPTIONS
ç­‰å…¶ä»–æ–¹æ³•
```

**ä¼šè§¦å‘é¢„æ£€çš„è¯·æ±‚å¤´:**

```
Authorization
Content-Type: application/json
X-Requested-With
è‡ªå®šä¹‰å¤´éƒ¨ (å¦‚ X-Custom-Header)
ç­‰å…¶ä»–éç®€å•è¯·æ±‚å¤´
```

<br>

## é¢„æ£€è¯·æ±‚å¤„ç†æµç¨‹

å½“æµè§ˆå™¨æ£€æµ‹åˆ°**å¤æ‚è¯·æ±‚**æ—¶, å¤„ç†æµç¨‹å¦‚ä¸‹:

**æ­¥éª¤ 1 - å‘é€ OPTIONS é¢„æ£€è¯·æ±‚:**

```
OPTIONS /api/data HTTP/1.1
Origin: https://example.com
Access-Control-Request-Method: PUT
Access-Control-Request-Headers: Content-Type
```

**æ­¥éª¤ 2 - æœåŠ¡å™¨å“åº”é¢„æ£€:**

```
Access-Control-Allow-Origin: https://example.com
Access-Control-Allow-Methods: PUT, POST, GET
Access-Control-Allow-Headers: Content-Type
Access-Control-Max-Age: 86400
```

**æ­¥éª¤ 3 - é¢„æ£€é€šè¿‡åå‘é€å®é™…è¯·æ±‚**

<br>

## CORS å“åº”æ ‡å¤´å­—æ®µé…ç½®

| å“åº”å¤´                             | ä½œç”¨                   | é…ç½®ç¤ºä¾‹                      | è¯¦ç»†è¯´æ˜                                                   |
| ---------------------------------- | ---------------------- | ----------------------------- | ---------------------------------------------------------- |
| `Access-Control-Allow-Origin`      | æŒ‡å®šå…è®¸çš„æº           | `https://example.com` æˆ– `*`  | æœ€é‡è¦çš„å“åº”å¤´, æŒ‡å®šå“ªäº›æºå¯ä»¥è®¿é—®èµ„æº                     |
| `Access-Control-Allow-Methods`     | æŒ‡å®šå…è®¸çš„è¯·æ±‚æ–¹æ³•     | `GET, POST, PUT, DELETE`      | ç”¨äºé¢„æ£€è¯·æ±‚å“åº”, å‘Šè¯‰æµè§ˆå™¨å®é™…è¯·æ±‚å…è®¸ä½¿ç”¨çš„æ–¹æ³•         |
| `Access-Control-Allow-Headers`     | æŒ‡å®šå…è®¸çš„è¯·æ±‚å¤´       | `Content-Type, Authorization` | ç”¨äºé¢„æ£€è¯·æ±‚å“åº”, æŒ‡å®šå®é™…è¯·æ±‚ä¸­å…è®¸æºå¸¦çš„æ ‡å¤´å­—æ®µ         |
| `Access-Control-Allow-Credentials` | æ˜¯å¦å…è®¸å‘é€å‡­æ®       | `true`                        | æŒ‡å®šå½“è¯·æ±‚çš„å‡­æ®æ¨¡å¼ä¸º `include` æ—¶æ˜¯å¦å…è®¸æµè§ˆå™¨è¯»å–å“åº”  |
| `Access-Control-Expose-Headers`    | æŒ‡å®šå‰ç«¯å¯è®¿é—®çš„å“åº”å¤´ | `X-Custom-Header`             | é»˜è®¤æƒ…å†µä¸‹å‰ç«¯åªèƒ½è®¿é—®åŸºæœ¬å“åº”å¤´, æ­¤å­—æ®µå¯æš´éœ²è‡ªå®šä¹‰å“åº”å¤´ |
| `Access-Control-Max-Age`           | é¢„æ£€è¯·æ±‚ç¼“å­˜æ—¶é—´       | `86400` (ç§’)                  | æŒ‡å®šé¢„æ£€è¯·æ±‚ç»“æœçš„ç¼“å­˜æ—¶é—´, é¿å…é¢‘ç¹å‘é€ OPTIONS è¯·æ±‚      |

<br>

## CORS è¯·æ±‚æ ‡å¤´å­—æ®µè¯´æ˜

| è¯·æ±‚å¤´                           | ä½œç”¨                         | è®¾ç½®æ—¶æœº           | ç¤ºä¾‹å€¼                   |
| -------------------------------- | ---------------------------- | ------------------ | ------------------------ |
| `Origin`                         | è¡¨æ˜è¯·æ±‚çš„æºç«™               | æ‰€æœ‰è·¨æºè¯·æ±‚       | `https://example.com`    |
| `Access-Control-Request-Method`  | é¢„æ£€æ—¶æŒ‡å®šå®é™…è¯·æ±‚ä½¿ç”¨çš„æ–¹æ³• | å¤æ‚è¯·æ±‚çš„é¢„æ£€é˜¶æ®µ | `PUT`                    |
| `Access-Control-Request-Headers` | é¢„æ£€æ—¶æŒ‡å®šå®é™…è¯·æ±‚æºå¸¦çš„å¤´éƒ¨ | å¤æ‚è¯·æ±‚çš„é¢„æ£€é˜¶æ®µ | `Content-Type, X-Custom` |

<br>

## CORS æ ‡å¤´å­—æ®µé…ç½®ç¤ºä¾‹

**æœåŠ¡å™¨ç«¯å“åº”å¤´é…ç½®:**

```javascript
// åŸºç¡€é…ç½®
res.setHeader("Access-Control-Allow-Origin", "https://example.com");
res.setHeader("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE, OPTIONS");
res.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization, X-Requested-With");

// é«˜çº§é…ç½®
res.setHeader("Access-Control-Allow-Credentials", "true"); // å…è®¸æºå¸¦å‡­æ®
res.setHeader("Access-Control-Expose-Headers", "X-Total-Count, X-Page-Info"); // æš´éœ²è‡ªå®šä¹‰å“åº”å¤´
res.setHeader("Access-Control-Max-Age", "86400"); // é¢„æ£€ç¼“å­˜24å°æ—¶
```

**åŠ¨æ€è®¾ç½®å…è®¸çš„æº:**

```javascript
const allowedOrigins = ["https://example1.com", "https://example2.com"];
const origin = req.headers.origin;

if (allowedOrigins.includes(origin)) {
    res.setHeader("Access-Control-Allow-Origin", origin);
    res.setHeader("Vary", "Origin"); // é‡è¦: å‘Šè¯‰ç¼“å­˜æœåŠ¡å™¨å¯¹ä¸åŒOriginè¿”å›ä¸åŒå†…å®¹
}
```

<br>

# CORS è¯·æ±‚ç±»å‹è¯¦è§£

## ç®€å•è¯·æ±‚ç¤ºä¾‹

**å‰ç«¯å‘é€ç®€å•è¯·æ±‚:**

```javascript
// âœ… ç®€å•è¯·æ±‚ - ç›´æ¥å‘é€åˆ°æœåŠ¡å™¨
fetch("https://api.example.com/data", {
    method: "GET",
    headers: {
        Accept: "application/json",
    },
});

// è¯·æ±‚å¤´ä¼šè‡ªåŠ¨åŒ…å«:
// Origin: https://example.com
```

**æœåŠ¡å™¨å“åº”ç®€å•è¯·æ±‚:**

```http
HTTP/1.1 200 OK
Access-Control-Allow-Origin: https://example.com
Content-Type: application/json

{"message": "ç®€å•è¯·æ±‚æˆåŠŸ"}
```

<br>

## é¢„æ£€è¯·æ±‚ç¤ºä¾‹

**æ­¥éª¤ 1 - æµè§ˆå™¨å‘é€é¢„æ£€è¯·æ±‚:**

```http
OPTIONS /api/data HTTP/1.1
Host: api.example.com
Origin: https://example.com
Access-Control-Request-Method: PUT
Access-Control-Request-Headers: Content-Type, Authorization
```

**æ­¥éª¤ 2 - æœåŠ¡å™¨å“åº”é¢„æ£€:**

```http
HTTP/1.1 200 OK
Access-Control-Allow-Origin: https://example.com
Access-Control-Allow-Methods: GET, POST, PUT, DELETE
Access-Control-Allow-Headers: Content-Type, Authorization
Access-Control-Max-Age: 86400
```

**æ­¥éª¤ 3 - æµè§ˆå™¨å‘é€å®é™…è¯·æ±‚:**

```javascript
// é¢„æ£€é€šè¿‡å, æµè§ˆå™¨å‘é€å®é™…è¯·æ±‚
fetch("https://api.example.com/data", {
    method: "PUT",
    headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer token123",
    },
    body: JSON.stringify({ name: "John" }),
});
```

<br>

## é™„å¸¦èº«ä»½å‡­è¯çš„è¯·æ±‚

å½“éœ€è¦å‘é€ **Cookieã€HTTP è®¤è¯ä¿¡æ¯æˆ–å®¢æˆ·ç«¯ SSL è¯æ˜** ç­‰å‡­æ®æ—¶, éœ€è¦ç‰¹æ®Šå¤„ç†:

**å‰ç«¯è®¾ç½® `credentials` é€‰é¡¹:**

```javascript
// æ–¹å¼ä¸€: fetch API
fetch("https://api.example.com/profile", {
    method: "GET",
    credentials: "include", // ğŸ“Œ å…³é”®: åŒ…å«å‡­æ®
    headers: {
        "Content-Type": "application/json",
    },
});

// æ–¹å¼äºŒ: XMLHttpRequest
const xhr = new XMLHttpRequest();
xhr.open("GET", "https://api.example.com/profile");
xhr.withCredentials = true; // ğŸ“Œ å…³é”®: è®¾ç½®ä¸º true
xhr.send();

// æ–¹å¼ä¸‰: Axios
axios.get("https://api.example.com/profile", {
    withCredentials: true, // ğŸ“Œ å…³é”®: è®¾ç½®ä¸º true
});
```

**æœåŠ¡å™¨å¿…é¡»æ˜ç¡®å…è®¸å‡­æ®:**

```javascript
// âš ï¸ é‡è¦: å½“ credentials ä¸º true æ—¶, Access-Control-Allow-Origin ä¸èƒ½ä¸º *
res.setHeader("Access-Control-Allow-Origin", "https://example.com"); // å¿…é¡»æŒ‡å®šå…·ä½“æº
res.setHeader("Access-Control-Allow-Credentials", "true"); // å¿…é¡»è®¾ç½®ä¸º true
res.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");

// å¤„ç†é¢„æ£€è¯·æ±‚
if (req.method === "OPTIONS") {
    res.setHeader("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE");
    res.status(200).end();
    return;
}
```

**âš ï¸ å‡­æ®è¯·æ±‚çš„é‡è¦é™åˆ¶:**

1. `Access-Control-Allow-Origin` **ä¸èƒ½ä½¿ç”¨é€šé…ç¬¦ `*`**, å¿…é¡»æŒ‡å®šå…·ä½“çš„æº
2. `Access-Control-Allow-Headers` **ä¸èƒ½ä½¿ç”¨é€šé…ç¬¦ `*`**, å¿…é¡»æ˜ç¡®åˆ—å‡ºå…è®¸çš„å¤´éƒ¨
3. æœåŠ¡å™¨å¿…é¡»åœ¨å“åº”ä¸­åŒ…å« `Access-Control-Allow-Credentials: true`

<br>

## ç¬¬ä¸‰æ–¹ Cookie å¤„ç†

åœ¨è·¨åŸŸè¯·æ±‚ä¸­è®¾ç½®çš„ Cookie ä¼šå—åˆ°ç¬¬ä¸‰æ–¹ Cookie ç­–ç•¥çš„å½±å“:

```javascript
// æœåŠ¡å™¨è®¾ç½® Cookie
res.setHeader("Set-Cookie", [
    "sessionId=abc123; SameSite=None; Secure", // SameSite=None å…è®¸è·¨ç«™å‘é€
    "userId=456; SameSite=Lax; Secure", // SameSite=Lax é™åˆ¶è·¨ç«™å‘é€
]);
```

**Cookie SameSite å±æ€§è¯´æ˜:**

-   `SameSite=Strict`: å®Œå…¨ç¦æ­¢ç¬¬ä¸‰æ–¹ Cookie
-   `SameSite=Lax`: å…è®¸éƒ¨åˆ†ç¬¬ä¸‰æ–¹ Cookie (å¦‚å¯¼èˆªé“¾æ¥)
-   `SameSite=None`: å…è®¸æ‰€æœ‰ç¬¬ä¸‰æ–¹ Cookie (å¿…é¡»é…åˆ Secure ä½¿ç”¨)

<br>

## CORS ä»£ç å®ç°

**å‰ç«¯ä»£ç ç¤ºä¾‹:**

```javascript
// âœ… ç®€å•è¯·æ±‚ - ç›´æ¥å‘é€
fetch("https://api.example.com/data", {
    method: "GET",
    headers: {
        Accept: "application/json",
    },
});

// âš ï¸ å¤æ‚è¯·æ±‚ - ä¼šå…ˆå‘é€é¢„æ£€
fetch("https://api.example.com/data", {
    method: "PUT",
    headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer token",
    },
    body: JSON.stringify({ data: "value" }),
});
```

**åç«¯å®ç° (Node.js + Express):**

```javascript
const express = require("express");
const cors = require("cors");
const server = express();

// æ–¹æ¡ˆä¸€: å…è®¸æ‰€æœ‰åŸŸåè·¨åŸŸ
server.use(cors());

// æ–¹æ¡ˆäºŒ: æŒ‡å®šå•ä¸ªåŸŸå
server.use(cors({ origin: "http://example.com" }));

// æ–¹æ¡ˆä¸‰: æŒ‡å®šå¤šä¸ªåŸŸå
server.use(
    cors({
        origin: ["http://example1.com", "http://example2.com"],
        credentials: true, // å…è®¸æºå¸¦å‡­æ®
    })
);

server.use(express.json());

server.post("/api/data", (req, res) => {
    res.json({ message: "è·¨åŸŸè¯·æ±‚æˆåŠŸ", data: req.body });
});

server.listen(8080, () => console.log("http://127.0.0.1:8080"));
```

<br><br>

# å…¶ä»–è·¨åŸŸè§£å†³æ–¹æ¡ˆ

## JSONP æ–¹æ¡ˆ

**åŸç†:** åˆ©ç”¨ `<script>` æ ‡ç­¾å¤©ç”Ÿå¯ä»¥è·¨åŸŸçš„ç‰¹æ€§.

**ä¼˜ç‚¹:** å…¼å®¹æ€§å¥½, æ”¯æŒè€æ—§æµè§ˆå™¨  
**ç¼ºç‚¹:** åªæ”¯æŒ GET è¯·æ±‚, å­˜åœ¨å®‰å…¨é£é™©, ä¸æ”¯æŒé”™è¯¯å¤„ç†

âš ï¸ **æé†’:** JSONP ç°åœ¨åŸºæœ¬å·²è¢« CORS å–ä»£, **å¼ºçƒˆä¸æ¨èåœ¨æ–°é¡¹ç›®ä¸­ä½¿ç”¨**. ä»…ä½œä¸ºå†å²æŠ€æœ¯äº†è§£.

**å®ç°ç¤ºä¾‹:**

```html
<!-- å‰ç«¯ä»£ç  -->
<script>
    function handleResponse(data) {
        console.log(data); // { name: 'superman' }
    }
</script>
<script src="http://127.0.0.1:8000/jsonp-server?callback=handleResponse"></script>
```

```javascript
// åç«¯ä»£ç  (Node.js)
const express = require("express");
const app = express();

app.get("/jsonp-server", (req, res) => {
    const callback = req.query.callback;
    const data = JSON.stringify({ name: "superman" });
    res.send(`${callback}(${data})`); // å“åº”å­—ç¬¦ä¸²å½¢å¼çš„ JS è¯­å¥
});

app.listen(8000);
```

<br>

## ä»£ç†æœåŠ¡å™¨æ–¹æ¡ˆ

**åŸç†:** åˆ©ç”¨æœåŠ¡å™¨ä¹‹é—´æ²¡æœ‰è·¨åŸŸé™åˆ¶çš„ç‰¹æ€§, é€šè¿‡ä»£ç†æœåŠ¡å™¨è½¬å‘è¯·æ±‚.

**ä¼˜ç‚¹:** æ”¯æŒæ‰€æœ‰ç±»å‹çš„è¯·æ±‚, ä¸éœ€è¦ä¿®æ”¹å‰ç«¯ä»£ç , å¯ä»¥å¤„ç†å¤æ‚çš„èº«ä»½éªŒè¯  
**ç¼ºç‚¹:** éœ€è¦é¢å¤–çš„æœåŠ¡å™¨èµ„æºå’Œé…ç½®, å¢åŠ äº†ç½‘ç»œå»¶è¿Ÿ

**å¼€å‘ç¯å¢ƒä»£ç†é…ç½® (Vite):**

```javascript
// vite.config.js
import { defineConfig } from "vite";

export default defineConfig({
    server: {
        proxy: {
            "/api": {
                target: "http://localhost:5000",
                changeOrigin: true,
                rewrite: (path) => path.replace(/^\/api/, ""), // å»æ‰è¯·æ±‚å‰ç¼€
            },
        },
    },
});
```

**å¼€å‘ç¯å¢ƒä»£ç†é…ç½® (Webpack):**

```javascript
// webpack.config.js
module.exports = {
    devServer: {
        proxy: {
            "/api": {
                target: "http://localhost:5000",
                changeOrigin: true,
                pathRewrite: {
                    "^/api": "", // å»æ‰è¯·æ±‚å‰ç¼€
                },
            },
        },
    },
};
```

**ç”Ÿäº§ç¯å¢ƒä»£ç†é…ç½® (Nginx):**

```nginx
server {
    listen 80;
    server_name example.com;

    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    location /api/ {
        proxy_pass http://backend-server:8080/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

<br><br>

# å®è·µæŒ‡å—ä¸é—®é¢˜æ’æŸ¥

## æœ€ä½³å®è·µå»ºè®®

**å…³é”®è¦ç‚¹:**

1. **è·¨åŸŸåˆ¤æ–­æ ‡å‡†** = åè®® + åŸŸå + ç«¯å£å·
2. **åªæœ‰ AJAX è¯·æ±‚**æ‰ä¼šå—åˆ°åŒæºç­–ç•¥é™åˆ¶
3. **CORS æ˜¯ç°ä»£é¦–é€‰**çš„è·¨åŸŸè§£å†³æ–¹æ¡ˆ
4. **ç®€å•è¯·æ±‚**ç›´æ¥å‘é€, **å¤æ‚è¯·æ±‚**éœ€è¦é¢„æ£€

**å®æ–½å»ºè®®:**

1. **ä¼˜å…ˆä½¿ç”¨ CORS**

    - ç°ä»£ã€å®‰å…¨ã€åŠŸèƒ½å®Œæ•´
    - æ”¯æŒæ‰€æœ‰ HTTP æ–¹æ³•å’Œè¯·æ±‚å¤´

2. **åˆç†è®¾ç½® CORS ç­–ç•¥**

    - ç”Ÿäº§ç¯å¢ƒé¿å…ä½¿ç”¨ `*` é€šé…ç¬¦
    - ç²¾ç¡®æŒ‡å®šå…è®¸çš„åŸŸåã€æ–¹æ³•å’Œå¤´éƒ¨
    - è°¨æ…å¼€å¯ `credentials` é€‰é¡¹

3. **å¼€å‘ç¯å¢ƒä½¿ç”¨ä»£ç†**

    - ä½¿ç”¨ Viteã€Webpack DevServer ç­‰å·¥å…·çš„ä»£ç†åŠŸèƒ½
    - é¿å…åœ¨å¼€å‘ç¯å¢ƒé…ç½®å¤æ‚çš„ CORS ç­–ç•¥

4. **ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–**
    - ä½¿ç”¨ Nginx ç­‰åå‘ä»£ç†æœåŠ¡å™¨
    - åˆç†è®¾ç½®é¢„æ£€è¯·æ±‚ç¼“å­˜æ—¶é—´ (`Access-Control-Max-Age`)
    - ç›‘æ§è·¨åŸŸè¯·æ±‚çš„æ€§èƒ½å½±å“

<br>

## å®‰å…¨æ€§æ³¨æ„äº‹é¡¹

-   è·¨åŸŸä¸æ˜¯æŠ€æœ¯ç¼ºé™·, è€Œæ˜¯æµè§ˆå™¨ä¸ºäº†ä¿æŠ¤ç”¨æˆ·å®‰å…¨è€Œå®æ–½çš„é‡è¦å®‰å…¨æœºåˆ¶
-   é€šè¿‡åˆç†çš„ CORS é…ç½®å¯ä»¥å®‰å…¨åœ°è§£å†³è·¨åŸŸé—®é¢˜
-   é¿å…ä½¿ç”¨è¿‡äºå®½æ¾çš„è·¨åŸŸç­–ç•¥, é˜²æ­¢å®‰å…¨æ¼æ´
-   ç”Ÿäº§ç¯å¢ƒä¸­åŠ¡å¿…ç²¾ç¡®é…ç½®å…è®¸çš„åŸŸå, è€Œä¸æ˜¯ä½¿ç”¨ `*`

<br>

# å¸¸è§é”™è¯¯ä¸è§£å†³æ–¹æ¡ˆ

## Access-Control-Allow-Origin ç¼ºå¤±é”™è¯¯

**é”™è¯¯ä¿¡æ¯:**

```
Access to fetch at 'https://api.example.com/data' from origin 'https://example.com' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.
```

**è§£å†³æ–¹æ¡ˆ:**

```javascript
// æœåŠ¡å™¨ç«¯æ·»åŠ å“åº”å¤´
res.setHeader("Access-Control-Allow-Origin", "https://example.com");
// æˆ–å…è®¸æ‰€æœ‰æº (ä¸æ¨èç”¨äºç”Ÿäº§ç¯å¢ƒ)
res.setHeader("Access-Control-Allow-Origin", "*");
```

<br>

## Origin ä¸åŒ¹é…é”™è¯¯

**é”™è¯¯ä¿¡æ¯:**

```
Access-Control-Allow-Origin header value 'https://other.com' does not match origin 'https://example.com'
```

**è§£å†³æ–¹æ¡ˆ:**

```javascript
// æ–¹æ¡ˆä¸€: ä¿®æ”¹ä¸ºæ­£ç¡®çš„æº
res.setHeader("Access-Control-Allow-Origin", "https://example.com");

// æ–¹æ¡ˆäºŒ: æ”¯æŒå¤šä¸ªæº
const allowedOrigins = ["https://example.com", "https://app.example.com"];
const origin = req.headers.origin;
if (allowedOrigins.includes(origin)) {
    res.setHeader("Access-Control-Allow-Origin", origin);
}
```

<br>

## é¢„æ£€è¯·æ±‚å¤±è´¥é”™è¯¯

**é”™è¯¯ä¿¡æ¯:**

```
Access to fetch at 'https://api.example.com/data' from origin 'https://example.com' has been blocked by CORS policy: Method PUT is not allowed by Access-Control-Allow-Methods in preflight response.
```

**è§£å†³æ–¹æ¡ˆ:**

```javascript
// ç¡®ä¿å¤„ç† OPTIONS é¢„æ£€è¯·æ±‚
if (req.method === "OPTIONS") {
    res.setHeader("Access-Control-Allow-Origin", "https://example.com");
    res.setHeader("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE, OPTIONS");
    res.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");
    res.setHeader("Access-Control-Max-Age", "86400");
    res.status(200).end();
    return;
}
```

<br>

## å‡­æ®è¯·æ±‚é…ç½®é”™è¯¯

**é”™è¯¯ä¿¡æ¯:**

```
Access to fetch at 'https://api.example.com/data' from origin 'https://example.com' has been blocked by CORS policy: The value of the 'Access-Control-Allow-Origin' header in the response must not be the wildcard '*' when the request's credentials mode is 'include'.
```

**è§£å†³æ–¹æ¡ˆ:**

```javascript
// âŒ é”™è¯¯é…ç½®
res.setHeader("Access-Control-Allow-Origin", "*");
res.setHeader("Access-Control-Allow-Credentials", "true");

// âœ… æ­£ç¡®é…ç½®
res.setHeader("Access-Control-Allow-Origin", "https://example.com"); // å¿…é¡»æŒ‡å®šå…·ä½“æº
res.setHeader("Access-Control-Allow-Credentials", "true");
```

<br>

## è‡ªå®šä¹‰è¯·æ±‚å¤´æœªæˆæƒé”™è¯¯

**é”™è¯¯ä¿¡æ¯:**

```
Access to fetch at 'https://api.example.com/data' from origin 'https://example.com' has been blocked by CORS policy: Request header field x-custom-header is not allowed by Access-Control-Allow-Headers in preflight response.
```

**è§£å†³æ–¹æ¡ˆ:**

```javascript
// åœ¨ Access-Control-Allow-Headers ä¸­æ·»åŠ è‡ªå®šä¹‰å¤´éƒ¨
res.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization, X-Custom-Header");
```

<br>

## è°ƒè¯•æŠ€å·§å’Œæ’æŸ¥æ¸…å•

**ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·:**

1. æ‰“å¼€ Network é¢æ¿
2. æŸ¥çœ‹æ˜¯å¦æœ‰ OPTIONS é¢„æ£€è¯·æ±‚
3. æ£€æŸ¥å“åº”å¤´ä¸­çš„ CORS ç›¸å…³å­—æ®µ
4. æŸ¥çœ‹è¯·æ±‚å¤´ä¸­çš„ Origin å­—æ®µ

**æœåŠ¡å™¨ç«¯æ—¥å¿—è°ƒè¯•:**

```javascript
// æ·»åŠ  CORS è°ƒè¯•æ—¥å¿—
app.use((req, res, next) => {
    console.log("Request Origin:", req.headers.origin);
    console.log("Request Method:", req.method);
    console.log("Request Headers:", req.headers);
    next();
});
```

**é¢„æ£€è¯·æ±‚å¤±è´¥è§£å†³æ¸…å•:**

-   [ ] æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦æ­£ç¡®å¤„ç† OPTIONS è¯·æ±‚
-   [ ] ç¡®è®¤ `Access-Control-Allow-Methods` åŒ…å«å®é™…è¯·æ±‚æ–¹æ³•
-   [ ] ç¡®è®¤ `Access-Control-Allow-Headers` åŒ…å«å®é™…è¯·æ±‚å¤´
-   [ ] éªŒè¯ `Access-Control-Allow-Origin` æ˜¯å¦æ­£ç¡®è®¾ç½®
-   [ ] æ£€æŸ¥æ˜¯å¦å¯ç”¨äº† `Access-Control-Allow-Credentials` (å¦‚æœéœ€è¦)

**å‡­æ®è¯·æ±‚å¤±è´¥è§£å†³æ¸…å•:**

-   [ ] ç¡®ä¿ `Access-Control-Allow-Origin` ä¸æ˜¯é€šé…ç¬¦ `*`
-   [ ] è®¾ç½® `Access-Control-Allow-Credentials: true`
-   [ ] å‰ç«¯æ­£ç¡®è®¾ç½® `credentials: 'include'` æˆ– `withCredentials: true`
-   [ ] æ£€æŸ¥ Cookie çš„ SameSite å±æ€§è®¾ç½®

<br>

# é«˜çº§åº”ç”¨ä¸æœ€ä½³å®è·µ

## å®‰å…¨æœ€ä½³å®è·µ

**ç²¾ç¡®é…ç½® Origin:**

```javascript
// âŒ é¿å…: ä½¿ç”¨é€šé…ç¬¦ (å®‰å…¨é£é™©)
res.setHeader("Access-Control-Allow-Origin", "*");

// âœ… æ¨è: ç²¾ç¡®æŒ‡å®šå…è®¸çš„æº
const allowedOrigins = [
    "https://app.example.com",
    "https://admin.example.com",
    process.env.NODE_ENV === "development" ? "http://localhost:3000" : null,
].filter(Boolean);

const origin = req.headers.origin;
if (allowedOrigins.includes(origin)) {
    res.setHeader("Access-Control-Allow-Origin", origin);
    res.setHeader("Vary", "Origin"); // é‡è¦: ç¼“å­˜æ§åˆ¶
}
```

**åŠ¨æ€ CORS é…ç½®:**

```javascript
// æ ¹æ®è¯·æ±‚è·¯å¾„åŠ¨æ€è®¾ç½® CORS
const corsMiddleware = (req, res, next) => {
    const { path, method } = req;

    // API è·¯å¾„å…è®¸ç‰¹å®šæº
    if (path.startsWith("/api/")) {
        res.setHeader("Access-Control-Allow-Origin", "https://app.example.com");
        res.setHeader("Access-Control-Allow-Credentials", "true");
    }

    // å…¬å…±èµ„æºå…è®¸æ‰€æœ‰æº
    if (path.startsWith("/public/")) {
        res.setHeader("Access-Control-Allow-Origin", "*");
    }

    // ç®¡ç†æ¥å£ä»…å…è®¸ç®¡ç†åŸŸå
    if (path.startsWith("/admin/")) {
        res.setHeader("Access-Control-Allow-Origin", "https://admin.example.com");
    }

    next();
};
```

**è¯·æ±‚é¢‘ç‡é™åˆ¶:**

```javascript
const rateLimit = require("express-rate-limit");

// å¯¹è·¨åŸŸè¯·æ±‚è¿›è¡Œé¢‘ç‡é™åˆ¶
const corsRateLimit = rateLimit({
    windowMs: 15 * 60 * 1000, // 15 åˆ†é’Ÿ
    max: 100, // é™åˆ¶æ¯ä¸ª IP 15 åˆ†é’Ÿå†…æœ€å¤š 100 æ¬¡è¯·æ±‚
    message: "è¯·æ±‚è¿‡äºé¢‘ç¹, è¯·ç¨åå†è¯•",
    standardHeaders: true,
    legacyHeaders: false,
});

app.use("/api", corsRateLimit);
```

<br>

## æ€§èƒ½ä¼˜åŒ–æŠ€å·§

**é¢„æ£€è¯·æ±‚ç¼“å­˜ä¼˜åŒ–:**

```javascript
// è®¾ç½®è¾ƒé•¿çš„é¢„æ£€ç¼“å­˜æ—¶é—´, å‡å°‘ OPTIONS è¯·æ±‚
res.setHeader("Access-Control-Max-Age", "86400"); // 24 å°æ—¶

// å¯¹äºé¢‘ç¹å˜åŠ¨çš„ API, ä½¿ç”¨è¾ƒçŸ­ç¼“å­˜
if (req.path.includes("/realtime/")) {
    res.setHeader("Access-Control-Max-Age", "300"); // 5 åˆ†é’Ÿ
}
```

**é¿å…ä¸å¿…è¦çš„é¢„æ£€è¯·æ±‚:**

```javascript
// ä¼˜åŒ–è¯·æ±‚å¤´, é¿å…è§¦å‘é¢„æ£€
// âŒ ä¼šè§¦å‘é¢„æ£€
fetch("/api/data", {
    method: "POST",
    headers: {
        "Content-Type": "application/json", // è§¦å‘é¢„æ£€
        "X-Custom-Header": "value", // è§¦å‘é¢„æ£€
    },
});

// âœ… ç®€å•è¯·æ±‚, ä¸è§¦å‘é¢„æ£€ (å¦‚æœå¯èƒ½)
const formData = new FormData();
formData.append("data", JSON.stringify(data));

fetch("/api/data", {
    method: "POST",
    body: formData, // Content-Type: multipart/form-data
});
```

<br>

## å‚è€ƒèµ„æº

-   [MDN CORS å®˜æ–¹æ–‡æ¡£](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Guides/CORS) - æƒå¨çš„ CORS æŠ€æœ¯æ–‡æ¡£
-   [CORS é”™è¯¯å‚è€ƒ](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS/Errors) - å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ
-   [Can I use CORS](https://caniuse.com/cors) - æµè§ˆå™¨å…¼å®¹æ€§æŸ¥è¯¢
-   [CORS Playground](https://cors-playground.com/) - åœ¨çº¿ CORS æµ‹è¯•å·¥å…·

<br>
