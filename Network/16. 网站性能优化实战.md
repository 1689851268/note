# 网站性能优化实战

## 优化方向

### 1. 网络传输优化

#### 1.1 升级服务器带宽

-   **原理**: 服务器带宽越大, 网速越快, 网站文件下载越快
-   **效果**: 从 3 分钟优化到 40 秒, 速度提升 4 倍多
-   **建议**: 个人小网站 1-5M 带宽够用, 带宽成本较高

#### 1.2 CDN 内容分发网络

-   **原理**: 类比电商区域仓库, 提前将网站文件缓存到全国各地的节点
-   **优势**:
    -   用户从最近的节点获取资源, 延迟更低
    -   能同时支持更多用户访问
-   **配置**: 可缓存图片等媒体资源, 也可缓存整套网站文件
-   **效果**: 从 40 秒优化到 6 秒, 性能提升 6 倍多
-   **注意**: CDN 按流量计费, 建议做好访问频率限制和用量监控

#### 1.3 浏览器缓存

-   **原理**: 将已请求过的网站文件存储到用户本地
-   **实现**: 通过 HTTP 缓存头配置或 CDN 的浏览器缓存过期配置
-   **效果**: 从 6 秒优化到 1.69 秒
-   **策略**:
    -   不常更新的网站缓存时间设置长一些
    -   形成完整的缓存体系: CDN 缓存解决地理距离问题, 浏览器缓存解决重复访问问题

#### 1.4 升级到 HTTP/2

-   **优势**:
    -   多路复用: 单连接同时处理多个请求
    -   解决 HTTP/1.1 的队头阻塞问题
    -   真正实现并行传输
-   **效果**: 从 6 秒优化到 1.6 秒, 性能提升 3 倍多
-   **实现**: 在 Web 服务器配置页面一键开启 HTTP/2

### 2. 文件体积优化

#### 2.1 图片压缩

-   **方法**: 将 JPG 和 PNG 图片统一压缩为 WebP 格式
-   **效果**: 减少 20% 以上的文件体积
-   **质量设置**: 一般 80% 左右对原图影响可接受
-   **实际效果**: 总体积减少 20 多倍, 加载时间从 14 秒缩短到 2 秒
-   **注意**: 用户上传图片需在后端进行压缩

#### 2.2 代码压缩

-   **原理**: 去除代码中的空格、注释、换行, 把变量名缩短
-   **工具**:
    -   独立 CSS 和 JS 文件使用官方提供的压缩版本
    -   前端项目使用打包工具自动优化压缩
-   **摇树优化**: 通过静态分析, 把代码中没有用到的地方摇掉
-   **效果**: 360 多 K 代码压缩后只有 159K, 减少一半

#### 2.3 GZIP 压缩

-   **原理**: 浏览器和服务器约定, 服务器把文件压缩后再发送
-   **实现**: 在 Web 服务器中添加配置
-   **效果**: 文件大小能减小一半多
-   **建议**: 即使效果不明显也建议开启

### 3. 加载策略优化

#### 3.1 延迟加载

-   **原理**: 用户看不到的内容就先不加载
-   **适用**: 长页面和图片较多的网站
-   **实现**: 使用 HTML 图片标签的 lazy 属性
-   **效果**: 首屏只用了 339 毫秒就加载完成, 加载时长缩短 5 倍

#### 3.2 按需加载

-   **原理**: 利用代码分割技术, 把庞大的代码包拆分成多个小模块
-   **实现**: 按照页面分割成多个小文件, 访问哪个页面就加载哪个页面的代码
-   **效果**: 缩短到 162 毫秒, 又优化一倍

#### 3.3 分层加载

-   **策略**: 先快后好, 先让用户立即看到内容, 再逐步提升质量
-   **实现方式**:
    -   **缩略图**: 列表页显示低清小图, 点击后加载高清大图
    -   **渐进式加载**: 先显示模糊预览, 然后逐渐变清晰
-   **效果**: 加载时长缩短到 118 毫秒, 又优化 25%

#### 3.4 预加载

-   **原理**: 预判用户需求, 在用户需要访问之前就把资源准备好
-   **实现方法**:

    -   **HTML 预加载**: 使用 `<link rel="preload">` 标签

        ```html
        <!-- 预加载关键 CSS -->
        <link rel="preload" href="critical.css" as="style" />

        <!-- 预加载关键 JS -->
        <link rel="preload" href="main.js" as="script" />

        <!-- 预加载字体 -->
        <link rel="preload" href="font.woff2" as="font" type="font/woff2" crossorigin />

        <!-- 预加载图片 -->
        <link rel="preload" href="hero-image.jpg" as="image" />
        ```

    -   **JavaScript 预加载**: 使用 `fetch()`

        ```javascript
        // 预加载下一页内容
        fetch("/api/articles/next-page")
            .then((response) => response.json())
            .then((data) => {
                // 将数据缓存起来，用户点击时直接使用
                window.cachedData = data;
            });
        ```

    -   **预连接**: 提前建立连接

        ```html
        <!-- 预连接到外部域名 -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="dns-prefetch" href="//cdn.example.com" />
        ```

-   **应用场景**: 用户浏览文章列表时, 预加载几篇文章详情页
-   **注意**: 需要先分析网站节奏和访问情况, 把握好度

#### 3.5 请求合并

-   **问题**: 多次调用后端接口时, 浏览器对同域名有并发请求限制
-   **解决**: 让后端提供聚合接口, 一次接口返回某页面需要的所有数据
-   **替代方案**: 自己搭建 Node 中间层做请求聚合

#### 3.6 雪碧图技术

-   **原理**: 利用 CSS 雪碧图特性, 把所有小图标合并为一张图片
-   **实现**: 前端利用 CSS 的 background-position 来加载图片的指定位置
-   **效果**: 只需要请求一次就达到同样效果

## 性能分析工具

### 浏览器开发者工具

-   **Network 面板**: 按 F12 打开, 切换到 Network 网络面板, 刷新页面查看每个资源的加载时间

### Lighthouse

-   **使用**: 浏览器开发者工具内置的 Lighthouse
-   **功能**: 一键分析, 进行全面的网站性能评估
-   **优势**: 使用方便, 还给出很多优化建议

## 优化效果总结

通过以上优化技巧, 最终网站加载时间:

-   **优化前**: 180 秒
-   **优化后**: 118 毫秒
-   **性能提升**: 1500 多倍

即使在弱网环境下, 也能很快地访问网站.

## 最佳实践建议

1. **先优化网站本身**: 建议先对网站本身进行优化, CDN 要谨慎使用
2. **针对具体场景**: 性能优化一定是针对具体场景先分析再优化
3. **持续探索**: 虽然方法交给大家了, 怎么合理运用这些方法进行优化, 需要持续探索
4. **准备分析工具**: 一定要准备一些网站性能分析工具

## 注意事项

-   CDN 和 HTTP/2 同时启用时, 性能提升可能没有想象中明显
-   对网站本身的优化越多, 网站传输的数据量就越小
-   再加上各种不稳定因素, CDN 在提速方面的效果可能就没有那么明显了
-   这就是为什么建议先对网站本身进行优化, CDN 还是要谨慎使用
