# å“ˆå¸Œå‡½æ•°å’ŒåŒºå—é“¾é“¾æ¥

å“ˆå¸Œå‡½æ•°çš„æ¦‚å¿µå¯ä»¥è¿½æº¯åˆ° 20 ä¸–çºª 50 å¹´ä»£, å½“æ—¶å®ƒä¸»è¦ç”¨äºæ•°æ®ç»“æ„ä¸­, å¦‚å“ˆå¸Œè¡¨, ç”¨æ¥å¿«é€Ÿå®šä½å’Œæ£€ç´¢æ•°æ®. åæ¥å“ˆå¸Œå‡½æ•°ç»å†äº†ä¸€ç³»åˆ—çš„å‘å±•, æ—§çš„æ ‡å‡†ä¸æ–­è¢«æ›´å®‰å…¨çš„æ–°æ ‡å‡†æ‰€æ›¿ä»£: MD4 -> MD5 -> SHA0 -> SHA1 -> SHA2 -> SHA3. ç›®å‰æœ€å…ˆè¿›çš„æ ‡å‡†æ˜¯ SHA3, SHA3 åŸºäº Keccak ç®—æ³•, ç”±æ¯”åˆ©æ—¶å¯†ç å­¦å®¶è®¾è®¡, å¹¶åœ¨ 2015 å¹´æˆä¸º NIST çš„æ ‡å‡†.

å“ˆå¸Œå‡½æ•°, ä¹Ÿç§°ä¸ºæ•£åˆ—å‡½æ•°. å®ƒå°†ä»»æ„é•¿åº¦çš„è¾“å…¥ ( é€šå¸¸ç§°ä¸º "æ¶ˆæ¯" ) , é€šè¿‡æ•°å­¦ç®—æ³•è½¬æ¢æˆå›ºå®šé•¿åº¦çš„å­—ç¬¦ä¸², è¿™ä¸ªè¾“å‡ºé€šå¸¸ç§°ä¸ºå“ˆå¸Œå€¼,æ•£åˆ—å€¼,æ¶ˆæ¯æ‘˜è¦æˆ–è€…æ•°å­—æŒ‡çº¹. ä¸‹å›¾ä»¥ SHA3-256 å“ˆå¸Œå‡½æ•°æ¥å±•ç¤º, æ— è®ºè¾“å…¥ä»€ä¹ˆ, è¾“å‡ºéƒ½æ˜¯ä¸€ä¸ªé•¿åº¦ä¸º 64 çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸².

<img src="./picture/QQ_1728131149160.png" alt="QQ_1728131149160" style="zoom:50%;" />

å“ˆå¸Œç®—æ³•çš„ç‰¹å¾:

1. æ­£å‘å¿«é€Ÿ: æ— è®ºè¾“å…¥çš„é•¿åº¦æœ‰å¤šå¤§, éƒ½èƒ½å¤Ÿå¿«é€Ÿè®¡ç®—å‡ºå“ˆå¸Œå€¼.

2. é€†å‘å›°éš¾: é€šè¿‡å“ˆå¸Œå€¼, æ— æ³•åœ¨æœ‰é™æ—¶é—´å†…é€†å‘æ¨å‡ºè¾“å…¥.

3. è¾“å…¥æ•æ„Ÿ: è¾“å…¥çš„å¾®å°å˜åŒ–, ä¼šå¯¼è‡´è¾“å‡ºçš„æ˜¾è‘—å˜åŒ–.

4. é¿å…ç¢°æ’: å¾ˆéš¾æ‰¾åˆ°ä¸¤ä¸ªä¸åŒçš„è¾“å…¥, ä½¿å¾—è¾“å‡ºçš„å“ˆå¸Œå€¼ä¸€è‡´ ( å³å‘ç”Ÿç¢°æ’ ) .

5. ä¸å¯é¢„æµ‹: é€šè¿‡è¾“å…¥æ— æ³•é¢„æµ‹è¾“å‡º, æ‰€ä»¥æŒ–çŸ¿æ—¶éšæœºæ•° nonce åªèƒ½ä» 1 å¼€å§‹ç´¯åŠ .

åŒºå—é“¾ä¸­çš„åº”ç”¨:

-   ç¡®ä¿äº¤æ˜“æ•°æ®çš„å®Œæ•´æ€§å’Œä¸å¯ç¯¡æ”¹æ€§. æ¯ç¬”äº¤æ˜“çš„å“ˆå¸Œå€¼éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„, ä»»ä½•ç»†å¾®çš„æ•°æ®å˜åŒ–éƒ½ä¼šå¯¼è‡´å“ˆå¸Œå€¼çš„å·¨å¤§å˜åŒ–, ä½¿å¾—ç½‘ç»œå‚ä¸è€…èƒ½å¤Ÿè¿…é€Ÿå‘ç°äº¤æ˜“æ•°æ®è¢«ç¯¡æ”¹çš„è¡Œä¸º.

-   å°†å„ä¸ªåŒºå—ä¸²è”èµ·æ¥å½¢æˆåŒºå—é“¾, æ¯ä¸ªåŒºå—åŒ…å«å‰ä¸€ä¸ªåŒºå—çš„å“ˆå¸Œå€¼, ä»è€Œç¡®ä¿äº†é“¾ä¸Šæ•°æ®çš„è¿è´¯æ€§å’Œä¸å¯é€†æ€§.

-   ç”¨äºæ„å»º Merkle æ ‘ä»¥é«˜æ•ˆéªŒè¯æ•°æ®.

-   å®æ–½å·¥ä½œé‡è¯æ˜æœºåˆ¶æ¥å¢å¼ºåŒºå—é“¾çš„å®‰å…¨æ€§, é€šè¿‡è§£å†³è®¡ç®—éš¾é¢˜æ¥é™åˆ¶æ–°åŒºå—çš„ç”Ÿæˆé€Ÿåº¦.

<br><br>

# æ•°å­—ç­¾å

<img src="./picture/QQ_1728131605643.png" alt="QQ_1728131605643" style="zoom:50%;" />

ç¬¬ä¸€æ­¥: è®¡ç®—ç­¾å. å°æ˜å…ˆä½¿ç”¨è‡ªå·±çš„ç§é’¥å¯¹æ¶ˆæ¯å¯†æ–‡è¿›è¡ŒåŠ å¯†, å¾—åˆ°æ¶ˆæ¯å¯†æ–‡çš„ç­¾å, å†å°†ç­¾åé™„åŠ åˆ°æ¶ˆæ¯å¯†æ–‡ä¸­ä¸€èµ·ä¼ è¾“, å‘é€ç»™å°çº¢.

ç¬¬äºŒæ­¥: æ¢å¤ç­¾å. å°çº¢æ”¶åˆ°æ¶ˆæ¯å¯†æ–‡å’Œç­¾åä¹‹å, ä½¿ç”¨å…¬å¼€è·å¾—çš„å°æ˜çš„å…¬é’¥å¯¹ç­¾åè¿›è¡Œè§£å¯†, å¾—åˆ°æ¶ˆæ¯å¯†æ–‡.

ç¬¬ä¸‰æ­¥: éªŒè¯ç­¾å. å°çº¢å°†æ”¶åˆ°çš„å¯†æ–‡å’Œè§£å¯†ç­¾åæ¢å¤å‡ºæ¥çš„å¯†æ–‡è¿›è¡Œå¯¹æ¯”, å¦‚æœä¸¤è€…ä¸€è‡´, åˆ™ç­¾åéªŒè¯æˆåŠŸ, è¯´æ˜æ”¶åˆ°çš„ä¿¡ä»¶ç¡®å®æ˜¯å°æ˜å‘å‡ºçš„, åŒæ—¶è¿˜èƒ½è¯æ˜ä¿¡ä»¶åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ²¡æœ‰è¢«ä¿®æ”¹.

> å› ä¸ºå…¬ç§é’¥åŠ å¯†ç®—æ³•æ‰§è¡Œæ¯”è¾ƒæ…¢, å¦‚æœæ¶ˆæ¯æ¯”è¾ƒå¤§, ç­¾åè¿‡ç¨‹ä¼šæ¶ˆè€—å¾ˆé•¿æ—¶é—´. æ‰€ä»¥åœ¨å®é™…åº”ç”¨ä¸­, ä¸€èˆ¬å…ˆè®¡ç®—æ¶ˆæ¯çš„å“ˆå¸Œå€¼, å†è®¡ç®—å“ˆå¸Œå€¼çš„ç­¾å, è¿™æ ·å¯ä»¥å‡å°‘ç­¾åè€—æ—¶. ( æ— è®ºæ¶ˆæ¯å†…å®¹æœ‰å¤šå°‘, è®¡ç®—çš„å“ˆå¸Œå€¼éƒ½æ˜¯å›ºå®šé•¿åº¦çš„ )

<br><br>

# äº¤æ˜“éªŒè¯

åœ¨ä»¥å¤ªåŠä¸­, æ•°å­—ç­¾åæŠ€æœ¯ç”¨äºäº¤æ˜“éªŒè¯, ç¡®ä¿äº¤æ˜“çš„çœŸå®æ€§ã€å®Œæ•´æ€§. äº¤æ˜“éªŒè¯ä¸»è¦æœ‰å¦‚ä¸‹å‡ æ­¥:

1. ç”¨æˆ·ç­¾åäº¤æ˜“. ç”¨æˆ·å°†äº¤æ˜“æ•°æ®å‡†å¤‡å¥½å, å…ˆè®¡ç®—å‡ºäº¤æ˜“æ•°æ®çš„å“ˆå¸Œå€¼, å†ä½¿ç”¨æ¤­åœ†æ›²çº¿ç­¾åç®—æ³• ( ECDSA ) å¯¹å“ˆå¸Œå€¼è¿›è¡Œç­¾å, å°†ç­¾åå€¼ ( v, r, s ) é™„åŠ åˆ°äº¤æ˜“æ•°æ®ä¸­è¿›è¡Œå¹¿æ’­.

2. çŸ¿å·¥éªŒè¯äº¤æ˜“. çŸ¿å·¥æ¥æ”¶åˆ°ä¸€ç¬”äº¤æ˜“ä¹‹å, åŒæ ·, å…ˆè®¡ç®—å‡ºäº¤æ˜“æ•°æ® ( ä¸å«ç­¾å ) çš„å“ˆå¸Œå€¼, å†ä½¿ç”¨æ¤­åœ†æ›²çº¿ç­¾åç®—æ³• ( ECDSA ) , ä»ç­¾åå’Œå“ˆå¸Œå€¼ä¸­æ¢å¤å‡ºç”¨æˆ·å…¬é’¥. æœ€åå°†æ¢å¤å‡ºçš„å…¬é’¥ä¸ç”¨æˆ·é’±åŒ…åœ°å€åšå¯¹æ¯”, å¦‚æœä¸¤è€…ä¸€è‡´, åˆ™äº¤æ˜“éªŒè¯æˆåŠŸ.

<img src="./picture/QQ_1728131864747.png" alt="QQ_1728131864747" style="zoom: 80%;" />

å¯¹äºåˆå­¦è€…æ¥è¯´, ä¸ºäº†æ–¹ä¾¿ç†è§£, å¯ä»¥ç®€å•çš„è®¤ä¸ºç”¨æˆ·é’±åŒ…åœ°å€å°±æ˜¯å…¬é’¥. ä½†æ˜¯è¯·æ³¨æ„, å®é™…ä¸Šä¸¤è€…å¹¶ä¸ç›¸ç­‰, ç”¨æˆ·é’±åŒ…åœ°å€æ˜¯ç”±å…¬é’¥å…ˆç»è¿‡å“ˆå¸Œè®¡ç®—, å†å–æœ«å°¾ 20 ä¸ªå­—èŠ‚è€Œæ¥çš„.

<br><br>

# é’±åŒ…åœ°å€çš„ç”Ÿæˆè¿‡ç¨‹

> åŠ©è®°è¯ â†’ ä¸»å¯†é’¥ â†’ n å­å¯†é’¥; å­å¯†é’¥ (ç§é’¥) â†’ å…¬é’¥; å…¬é’¥ â†’ åœ°å€

ä¸‹é¢ä»‹ç»ä¸€ä¸‹é’±åŒ…åœ°å€ç”Ÿæˆè¿‡ç¨‹ä¸­, æ¶‰åŠçš„å‡ ä¸ªå…³é”®æ­¥éª¤:

ç¬¬ä¸€æ­¥: ç”Ÿæˆç§å­. ç§å­æ˜¯ä¸€ä¸ªéšæœºç”Ÿæˆçš„æ•°å­—åºåˆ—, æ˜¯åç»­çš„èµ·ç‚¹. ç§å­å¯ä»¥ç”±ç³»ç»Ÿç”Ÿæˆçš„éšæœºæ•°æˆ–ç”¨æˆ·æä¾›çš„ç†µ ( æ¯”å¦‚éšæœºç§»åŠ¨é¼ æ ‡äº§ç”Ÿçš„æ•°æ® ) æ¥äº§ç”Ÿ.

ç¬¬äºŒæ­¥: ç”ŸæˆåŠ©è®°è¯. åŠ©è®°è¯æ˜¯å°†ç§å­è½¬æ¢æˆçš„ä¸€ç³»åˆ—æ–¹ä¾¿è®°å¿†çš„å•è¯. åœ¨ä»¥å¤ªåŠä¸­, æœ‰ä¸€ä¸ªå›ºå®šçš„ 2048 ä¸ªå•è¯çš„å•è¯åº“, é¦–å…ˆå°†ç§å­åˆ†å‰²æˆå¤šä¸ªäºŒè¿›åˆ¶æ•°æ®ç‰‡æ®µ, æ¯ä¸€ä¸ªç‰‡æ®µå¯¹åº”å•è¯åº“ä¸­çš„ä¸€ä¸ªå•è¯, æœ€ç»ˆå½¢æˆä¸€ä¸²å•è¯åºåˆ—, å³åŠ©è®°è¯.

ç¬¬ä¸‰æ­¥: ç”Ÿæˆç§é’¥. ç§é’¥æ˜¯æ§åˆ¶é’±åŒ…åœ°å€çš„å¯†é’¥. ä½¿ç”¨ä¸Šä¸€æ­¥çš„ç§å­, é€šè¿‡ HMAC-SHA512 ç®—æ³•è¿›è¡Œè®¡ç®—, å¯ä»¥å¾—åˆ°ç§é’¥.

ç¬¬å››æ­¥: ç”Ÿæˆå…¬é’¥. æœ‰äº†ç§é’¥ä¹‹å, é€šè¿‡æ¤­åœ†æ›²çº¿åŠ å¯†ç®—æ³• ( ECDSA ) , æˆ‘ä»¬å¯ä»¥è®¡ç®—å‡ºå¯¹åº”çš„å…¬é’¥.

ç¬¬äº”æ­¥: ç”Ÿæˆåœ°å€. æœ€åä¸€æ­¥æ˜¯ç”Ÿæˆé’±åŒ…åœ°å€. é¦–å…ˆä½¿ç”¨ Keccak-256 å“ˆå¸Œå‡½æ•°è®¡ç®—å…¬é’¥çš„å“ˆå¸Œå€¼, ç„¶åå–å“ˆå¸Œå€¼çš„æœ€å 20 ä¸ªå­—èŠ‚, å°±æ˜¯ä¸€ä¸ªä»¥å¤ªåŠé’±åŒ…åœ°å€.

<br><br>

# ä¿¡æ¯ä¼ è¾“

<img src="./picture/QQ_1727624455139.png" alt="QQ_1727624455139" style="zoom: 25%;" />

å‘é€æ–¹ A:

1. è®¡ç®—æ¶ˆæ¯ message çš„å“ˆå¸Œå€¼ H: `hash(message) = H`

2. ç§é’¥ privateKey â• å“ˆå¸Œå€¼ H ğŸŸ° ç­¾å signature: `signature = sign(H, privateKey)`

3. å°†æ¶ˆæ¯ message å’Œç­¾å signature å‘é€ç»™ B

æ¥æ”¶æ–¹ B:

1. è®¡ç®—æ¶ˆæ¯ message çš„å“ˆå¸Œå€¼ H1: `hash(message) = H1`

2. å…¬é’¥ publicKey â• ç­¾å signature ğŸŸ° H2: `H2 = verify(signature, publicKey)`

3. æ¯”è¾ƒ H1 å’Œ H2, å¦‚æœç›¸ç­‰ åˆ™è¯´æ˜æ¶ˆæ¯æœªè¢«ç¯¡æ”¹ä¸”ç¡®å®æ¥è‡ª A

<br><br>

# Keccak256 å‡½æ•°

```solidity
contract HashFunc {
    function hash(
        string memory _testString,
        uint _testUint
    ) public pure returns (bytes32) {
    	// å…ˆå¯¹æ•°æ®è¿›è¡Œç¼–ç , å†ç”¨ keccak256 åŠ å¯†
        return keccak256(abi.encodePacked(_testString, _testUint));
    }
}
```

encodePacked æ–¹æ³•å¯ä»¥å¯¹å¤šä¸ªå‚æ•°è¿›è¡Œç¼–ç , å¹¶å‹ç¼©ç¼–ç åçš„ç»“æœ, èŠ‚çœ gas. ä½†æŸäº›æƒ…å†µä¸‹ä¼šå¯¼è‡´å“ˆå¸Œç¢°æ’ (å“ˆå¸Œå†²çª).

ä¸ºäº†é¿å…å“ˆå¸Œç¢°æ’, å¯ä»¥ä½¿ç”¨ encode æ–¹æ³•, å®ƒä¸ä¼šå‹ç¼©ç¼–ç ç»“æœ, ä½†ä¼šæ¶ˆè€—æ›´å¤š gas.

```solidity
contract HashFunc {
    function hash(
        string memory _testString,
        uint _testUint
    ) public pure returns (bytes32) {
        // ä½¿ç”¨ encode æ–¹æ³•é¿å…å“ˆå¸Œç¢°æ’
        return keccak256(abi.encode(_testString, _testUint));
    }
}
```

é™¤äº†ä½¿ç”¨ encode æ–¹æ³•, è¿˜å¯ä»¥åœ¨ encodePacked çš„å…¥å‚ä¹‹é—´æ’å…¥ä¸€ä¸ªå‚æ•°, è¿™æ ·ä¹Ÿèƒ½é¿å…å“ˆå¸Œç¢°æ’.

```solidity
contract HashFunc {
    function hash(
        string memory _string1,
        uint _uint, // ç”¨æ¥é¿å…å“ˆå¸Œç¢°æ’çš„å‚æ•°
        string memory _string2
    ) public pure returns (bytes32) {
        // åœ¨ encodePacked çš„å…¥å‚ä¹‹é—´å†æ’å…¥ä¸€ä¸ªå‚æ•°, é¿å…å“ˆå¸Œç¢°æ’
        return keccak256(abi.encodePacked(_string1, _uint, _string2));
    }
}
```

<br><br>

# ç­¾åä¸éªŒè¯

```solidity
contract VerifySig {
    // å°†ä¸€ä¸ª 65 å­—èŠ‚é•¿çš„ç­¾åæ‹†åˆ†æˆ r,s,v ä¸‰ä¸ªéƒ¨åˆ†
    function split(
        bytes memory _signature
    ) internal pure returns (bytes32 r, bytes32 s, uint8 v) {
        require(_signature.length == 65, "invalid signature length");
        assembly {
            // ä» _signature çš„ç¬¬ 32 å­—èŠ‚å¼€å§‹åŠ è½½ 32 å­—èŠ‚çš„æ•°æ®, å¹¶å°†å…¶èµ‹å€¼ç»™ r
            // `ä» _signature çš„ç¬¬ 32 å­—èŠ‚å¼€å§‹` æ˜¯å› ä¸ºå‰ 32 å­—èŠ‚æ˜¯ _signature çš„é•¿åº¦ä¿¡æ¯, ä» 32 å­—èŠ‚å¼€å§‹æ‰æ˜¯çœŸæ­£çš„ç­¾åæ•°æ®
            r := mload(add(_signature, 32))
            // ä» _signature çš„ç¬¬ 64 å­—èŠ‚å¼€å§‹åŠ è½½ 32 å­—èŠ‚çš„æ•°æ®, å¹¶å°†å…¶èµ‹å€¼ç»™ s
            s := mload(add(_signature, 64))
            // ä» _signature çš„ç¬¬ 96 å­—èŠ‚å¼€å§‹åŠ è½½ 32 å­—èŠ‚çš„æ•°æ®, å¹¶å–å…¶ç¬¬ 1 ä¸ªå­—èŠ‚ç»™ v
            v := byte(0, mload(add(_signature, 96)))
            // åœ¨ä»¥å¤ªåŠä¸­, ç­¾åé€šè¿‡æ¤­åœ†æ›²çº¿æ•°å­—ç­¾åç®—æ³• (ECDSA, Elliptic Curve Digital Signature Algorithm) åˆ›å»º
            // å…¶ä¸­ r s æ˜¯ç­¾åçš„ä¸€éƒ¨åˆ†, v æ˜¯ç­¾åçš„æ¢å¤å› å­ (ä¸º 27 / 28), ç”¨äºæ¢å¤ç­¾åè€…çš„å…¬é’¥
        }
    }

    // è®¡ç®—ç»™å®šæ¶ˆæ¯çš„å“ˆå¸Œå€¼
    function getMessageHash(
        string memory _message
    ) public pure returns (bytes32) {
        return keccak256(abi.encodePacked(_message));
    }

    // ç”Ÿæˆä¸€ä¸ªç¬¦åˆä»¥å¤ªåŠç­¾åæ ‡å‡†çš„æ¶ˆæ¯å“ˆå¸Œå€¼
    function getEthSignedMessageHash(
        bytes32 _messageHash
    ) public pure returns (bytes32) {
        return
            keccak256(
                abi.encodePacked(
                    "\x19Ethereum Signed Message:\n32",
                    // è¿™æ˜¯ä¸€ä¸ªå›ºå®šçš„å‰ç¼€, ç”¨äºé˜²æ­¢ç­¾åé‡ç”¨æ”»å‡»
                    // è¿™ä¸ªå‰ç¼€å‘Šè¯‰ä»¥å¤ªåŠå®¢æˆ·ç«¯è¿™æ˜¯ä¸€ä¸ªç­¾åæ¶ˆæ¯, è€Œä¸æ˜¯äº¤æ˜“æˆ–å…¶ä»–æ•°æ®
                    // \x19 è¡¨ç¤ºæ¶ˆæ¯çš„é•¿åº¦;  32 è¡¨ç¤ºæ¶ˆæ¯å“ˆå¸Œçš„é•¿åº¦ä¸º 32 å­—èŠ‚
                    _messageHash
                )
            );
    }

    // ä»ç­¾åä¸­æ¢å¤å‡ºç­¾åè€…çš„åœ°å€
    function recover(
        bytes32 _ethSignedMessageHash,
        bytes memory _signature
    ) public pure returns (address) {
        (bytes32 r, bytes32 s, uint8 v) = split(_signature);
        return ecrecover(_ethSignedMessageHash, v, r, s);
    }

    // éªŒè¯æ¶ˆæ¯çš„æœ‰æ•ˆæ€§ (ç­¾åè€…æ˜¯å¦æ­£ç¡®,æ¶ˆæ¯æ˜¯å¦è¢«ç¯¡æ”¹)
    function verify(
        address _signer,
        string memory _message,
        bytes memory _signature
    ) public pure returns (bool) {
        bytes32 messageHash = getMessageHash(_message);
        bytes32 ethSignedMessageHash = getEthSignedMessageHash(messageHash);
        return recover(ethSignedMessageHash, _signature) == _signer;
    }
}
```

**éƒ¨ç½²åˆçº¦å¹¶æµ‹è¯•**:

æ¨¡æ‹Ÿå‘é€æ–¹ A:

1. å°†è¦å‘é€çš„æ¶ˆæ¯ä½œä¸ºå‚æ•°ä¼ å…¥ getMessageHash æ–¹æ³•, å¾—åˆ°æ¶ˆæ¯çš„å“ˆå¸Œå€¼ H, è¿™é‡Œä»¥å­—ç¬¦ä¸² "hello" ä¸ºä¾‹

2. F12 æ‰“å¼€æ§åˆ¶å°, æ‰§è¡Œ `ethereum.enable()`; æŸ¥çœ‹ Promise, è‹¥ä¸º fulfilled çŠ¶æ€åˆ™è¯´æ˜ MetaMask å·²è¿æ¥, å¯æŸ¥çœ‹ Promise ç»“æœå¾—åˆ° MetaMask çš„è´¦å·åœ°å€ (éœ€è¦å…ˆå®‰è£… MetaMask æ’ä»¶å¹¶ç™»å½•)

3. æ‰§è¡Œ `ethereum.request({ method: "personal_sign", params: [æ­¥éª¤ 2 å¾—åˆ°çš„ MetaMask è´¦å·åœ°å€, æ­¥éª¤ 1 å¾—åˆ°çš„å“ˆå¸Œå€¼ H] })`, ä¼šå¼¹å‡ºç­¾åæ¡†, ç‚¹å‡» sign è¿›è¡Œç­¾å; æŸ¥çœ‹ Promise, è‹¥ä¸º fulfilled çŠ¶æ€åˆ™è¯´æ˜ç­¾åæˆåŠŸ, å¯æŸ¥çœ‹ Promise ç»“æœå¾—åˆ°ç­¾å signature

4. å‡è®¾ A å°†æ­¥éª¤ 3 å¾—åˆ°çš„ç­¾å signature å’Œæ¶ˆæ¯ "hello" å‘é€ç»™äº† B

æ¨¡æ‹Ÿæ¥æ”¶æ–¹ B:

1. å°†æ”¶åˆ°çš„æ¶ˆæ¯ "hello" ä½œä¸ºå‚æ•°ä¼ å…¥ getMessageHash æ–¹æ³•, å¾—åˆ°æ¶ˆæ¯çš„å“ˆå¸Œå€¼

2. å°†æ­¥éª¤ 1 å¾—åˆ°çš„å“ˆå¸Œå€¼ä½œä¸ºå‚æ•°ä¼ å…¥ getEthSignedMessageHash æ–¹æ³•, å¾—åˆ°ç¬¦åˆä»¥å¤ªåŠç­¾åæ ‡å‡†çš„æ¶ˆæ¯å“ˆå¸Œå€¼ H1

3. å°†æ­¥éª¤ 2 å¾—åˆ°çš„æ¶ˆæ¯å“ˆå¸Œå€¼å’Œæ”¶åˆ°çš„ç­¾å signature ä½œä¸ºå‚æ•°ä¼ å…¥ recover æ–¹æ³•, å¾—åˆ°ç­¾åè€…çš„åœ°å€; æ¯”å¯¹æ˜¯å¦ä¸º A æ­¥éª¤ 2 å¾—åˆ°çš„ MetaMask è´¦å·åœ°å€, å¦‚æœä¸ä¸€è‡´ åˆ™è¯´æ˜ä¿¡æ¯è¢«ç¯¡æ”¹ / æ¶ˆæ¯ä¸æ˜¯æ¥è‡ª A

æ­¥éª¤ 1 2 3 å³ä¸º verify æ–¹æ³•çš„é€»è¾‘, å¯ç›´æ¥è°ƒç”¨ verify æ–¹æ³•è¿›è¡ŒéªŒè¯

<br><br>

# è®¿é—®æ§åˆ¶

```solidity
contract AccessControl {
    // å®šä¹‰ä¸¤ä¸ªè§’è‰²
    bytes32 public constant ROLE_ADMIN =
        keccak256(abi.encodePacked("ROLE_ADMIN"));
    bytes32 public constant ROLE_USER =
        keccak256(abi.encodePacked("ROLE_USER"));

    // å®šä¹‰ä¸€ä¸ªåŒé‡æ˜ å°„, ç”¨äºç®¡ç† "è§’è‰² - ç”¨æˆ· - æƒé™"
    mapping(bytes32 => mapping(address => bool)) public roles;

    // åˆ†é…æƒé™
    function _grantRole(bytes32 _role, address _account) internal {
        roles[_role][_account] = true;
    }

    // æ’¤é”€æƒé™
    function _revokeRole(bytes32 _role, address _account) internal {
        roles[_role][_account] = false;
    }

    // æ„é€ å‡½æ•°
    constructor() {
        _grantRole(ROLE_ADMIN, msg.sender);
    }

    // å‡½æ•°è£…é¥°å™¨, é™åˆ¶å‡½æ•°ä»…ç®¡ç†å‘˜èƒ½è°ƒç”¨
    modifier onlyAdmin() {
        require(
            roles[ROLE_ADMIN][msg.sender],
            "AccessControl: sender must be an admin to perform this action"
        );
        _;
    }

    // åˆ†é…æƒé™ (å¤–éƒ¨ä½¿ç”¨, ä»…ç®¡ç†å‘˜èƒ½è°ƒç”¨)
    function grantUserRole(address _account) public onlyAdmin {
        _grantRole(ROLE_USER, _account);
    }

    // æ’¤é”€æƒé™ (å¤–éƒ¨ä½¿ç”¨, ä»…ç®¡ç†å‘˜èƒ½è°ƒç”¨)
    function revokeUserRole(address _account) public onlyAdmin {
        _revokeRole(ROLE_USER, _account);
    }
}
```

1. éƒ¨ç½²åˆçº¦, éƒ¨ç½²è€…å°†æˆä¸ºç®¡ç†å‘˜

2. è·å–ç¼–è¾‘å™¨åœ°å€å’Œ ROLE_ADMIN çš„å“ˆå¸Œå€¼, å¡«å…¥ roles ä¸­æŸ¥çœ‹æƒé™, æ­¤å¤„åº”ä¸º true

3. æ›´æ–°ç¼–è¾‘å™¨åœ°å€, è·å–æ–°çš„ç¼–è¾‘å™¨åœ°å€å’Œ ROLE_USER çš„å“ˆå¸Œå€¼, å¡«å…¥ roles ä¸­æŸ¥çœ‹æƒé™, æ­¤å¤„åº”ä¸º false

4. ä¼ å…¥æ–°çš„ç¼–è¾‘å™¨åœ°å€, ä½¿ç”¨ç®¡ç†å‘˜åœ°å€è°ƒç”¨ grantUserRole æ–¹æ³•, æˆæƒæ–°çš„ç¼–è¾‘å™¨åœ°å€ä¸º ROLE_USER

5. è·å–æ–°çš„ç¼–è¾‘å™¨åœ°å€å’Œ ROLE_USER çš„å“ˆå¸Œå€¼, å¡«å…¥ roles ä¸­æŸ¥çœ‹æƒé™, æ­¤å¤„åº”ä¸º true

6. ä¼ å…¥æ–°çš„ç¼–è¾‘å™¨åœ°å€, ä½¿ç”¨ç®¡ç†å‘˜åœ°å€è°ƒç”¨ revokeUserRole æ–¹æ³•, å–æ¶ˆæ–°çš„ç¼–è¾‘å™¨åœ°å€çš„ ROLE_USER æƒé™

7. è·å–æ–°çš„ç¼–è¾‘å™¨åœ°å€å’Œ ROLE_USER çš„å“ˆå¸Œå€¼, å¡«å…¥ roles ä¸­æŸ¥çœ‹æƒé™, æ­¤å¤„åº”ä¸º false

8. ä¸ä½¿ç”¨ç®¡ç†å‘˜åœ°å€è°ƒç”¨ grantUserRole æ–¹æ³•, ä¼šæŠ¥é”™

<br><br>
