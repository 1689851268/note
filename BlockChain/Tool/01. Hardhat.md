# Hardhat

Hardhat 是以太坊最流行的开发环境，它可以帮你编译和部署智能合约，并且提供了 Hardhat Network 支持本地测试和运行 Solidity。

```
mkdir hardhat-demo
cd hardhat-demo
pnpm init
pnpm i hardhat -D
npx hardhat
```

```
888    888                      888 888               888
888    888                      888 888               888
888    888                      888 888               888
8888888888  8888b.  888d888 .d88888 88888b.   8888b.  888888
888    888     "88b 888P"  d88" 888 888 "88b     "88b 888
888    888 .d888888 888    888  888 888  888 .d888888 888
888    888 888  888 888    Y88b 888 888  888 888  888 Y88b.
888    888 "Y888888 888     "Y88888 888  888 "Y888888  "Y888

Welcome to Hardhat v2.22.10

? What do you want to do? ...
> Create a JavaScript project
  Create a TypeScript project
  Create a TypeScript project (with Viem)
  Create an empty hardhat.config.js
  Quit
```

这里我选了 Create a JavaScript project，然后会生成 hardhat.config.js：

```js
require("@nomicfoundation/hardhat-toolbox");

/** @type import('hardhat/config').HardhatUserConfig */
module.exports = {
    solidity: "0.8.24",
};
```

这里的 @NomicFoundation/hardhat-toolbox 是一个非常有用的 Hardhat 插件包，它集成了开发智能合约时常用的工具和插件。以下是它的一些主要功能和组件：

-   `hardhat-chai-matchers`：用于在 Hardhat 测试中使用 Chai 匹配器，方便进行断言和测试。

-   `hardhat-ethers`：提供了与 Ethers.js 的集成，方便在 Hardhat 中使用以太坊合约。

-   `hardhat-ignition`：用于快速创建和测试智能合约项目。

-   `hardhat-ignition-ethers`：与 `@nomicfoundation/hardhat-ignition` 一起使用，提供了对 Ethers.js 的额外支持。

-   `hardhat-network-helpers`：包含一些网络相关的助手函数，用于在测试中模拟网络环境。

-   `hardhat-toolbox`：是 Hardhat 的工具包，提供了一些常用的工具和配置。

-   `hardhat-verify`：用于在部署智能合约后进行验证。

<br><br>

# 编写并编译合约

1. 创建 contracts/MyERC20.sol：

```solidity
// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.24;

import "@openzeppelin/contracts/token/ERC20/ERC20.sol";

contract MyERC20 is ERC20 {
    constructor() ERC20("MyERC20", "MY20") {
        _mint(msg.sender, 1000000 * 10 ** decimals());
    }
}
```

2. 执行 `npx hardhat compile` 编译合约：

```
Compiled 7 Solidity files successfully (evm target: paris).
```

编译成功后，你会在文件夹下看到 artifacts 目录，里面的 json 文件就是编译结果。

<br><br>

# 编写单元测试

这里的单元测试非常简单，仅包含部署合约并测试合约地址是否合法。

新建测试文件夹 test，在其中新建 test.js。单元测试中，我们会用到 chai 和 ethers.js 两个库，分别用于测试和链上交互。对 ethers.js 不了解的开发者，可以看下 WTF Ethers 极简教程的前 6 讲。我们之后的教程会更详细的介绍 chai 和 mocha。

1. 创建 test/MyERC20.js:

这里会用到 chai、ethers.js 两个库，分别用于测试和链上交互

```js
const { expect } = require("chai");
const { ethers } = require("hardhat");

describe("MyERC20 合约测试", () => {
    it("合约部署", async () => {
        // ethers.getSigners 代表 eth 账号，这里我们创建了三个账号 owner, addr1, addr2
        const [owner, addr1, addr2] = await ethers.getSigners();
        // ethers.js 中的 ContractFactory 是用于部署新智能合约的抽象，因此这里的 MyERC20 是我们代币合约实例的工厂
        // MyERC20 代表 contracts 文件夹中的 MyERC20.sol 文件
        const Token = await ethers.getContractFactory("MyERC20");
        // 部署合约
        const hardhatToken = await Token.deploy();
        await hardhatToken.waitForDeployment();
        // 获取合约地址
        const ContractAddress = hardhatToken.target;
        expect(ContractAddress).to.properAddress;
    });
});
```

2. 执行 `npx hardhat test` 运行测试：

如果有多个测试文件，仅想跑指定文件可以使用 `npx hardhat test --grep <pattern>`；其中，`<pattern>` 是一个正则表达式模式，用于匹配要运行的测试文件的名称或描述。比如，`npx hardhat test --grep MyERC20` 会运行名称中包含 `MyERC20` 的测试文件。

```shell
  MyERC20 合约测试
    ✔ 合约部署 (897ms)


  1 passing (902ms)
```

<br><br>

# 部署合约

1. 创建 scripts/deploy.js：

```js
const { ethers } = require("hardhat");

async function main() {
    const Contract = await ethers.getContractFactory("MyERC20");
    const token = await Contract.deploy();
    await token.waitForDeployment();
    console.log("成功部署合约:", token.target);
}

// 运行脚本
main().catch((error) => {
    console.error("error:", error);
    process.exitCode = 1;
});
```

2. 执行 `npx hardhat run --network hardhat scripts/deploy.js` 部署合约到本地测试网络：

hardhat 会提供一个默认的网络，参考 https://hardhat.org/hardhat-network/docs/overview

```shell
成功部署合约: 0x5FbDB2315678afecb367f032d93F642f64180aa3
```

<br><br>

# 部署合约到 Sepolia 测试网络

前置准备：

1.  申请 Infura 的 API Key，用于连接以太坊网络

2.  到水龙头领取测试代币

3.  导出 MetaMask 私钥

4.  申请 Etherscan 的 API Key，用于验证合约

配置网络：

1.  修改 hardhat.config.js：

```js
require("@nomicfoundation/hardhat-toolbox");

const INFURA_API_KEY = "YOUR_INFURA_API_KEY";

const META_MASK_PRIVATE_KEY = "YOUR_META_MASK_PRIVATE_KEY";

const ETHERSCAN_API_KEY = "YOUR_ETHERSCAN_API_KEY";

module.exports = {
    solidity: "0.8.24",
    networks: {
        sepolia: {
            url: `https://sepolia.infura.io/v3/${INFURA_API_KEY}`,
            accounts: [META_MASK_PRIVATE_KEY],
        },
    },
    etherscan: {
        apiKey: ETHERSCAN_API_KEY,
    },
};
```

2.  执行 `npx hardhat run --network sepolia scripts/deploy.js` 部署合约到 Sepolia 测试网络：

```shell
成功部署合约: 0xb9b5835239B98691Fbe48ed82787982258DC0A87
```

可以通过 https://sepolia.etherscan.io 查看合约部署情况

同理你也可以配置多个网络，比如 Mainnet，Holesky 等。

<br><br>
