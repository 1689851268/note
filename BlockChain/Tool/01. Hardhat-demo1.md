# Hardhat é¡¹ç›®

Hardhat æ˜¯ä¸€ä¸ªä»¥å¤ªåŠè½¯ä»¶çš„å¼€å‘ç¯å¢ƒ, ç”¨äºç¼–è¾‘ã€ç¼–è¯‘ã€è°ƒè¯•å’Œéƒ¨ç½² DApp / æ™ºèƒ½åˆçº¦.

æ­å»º Hardhat é¡¹ç›®:

1. æ‰§è¡Œä»¥ä¸‹å‘½ä»¤:

```
mkdir hardhat-demo
cd hardhat-demo
pnpm init
pnpm i hardhat -D
npx hardhat init
```

2. é€‰æ‹©é¡¹ç›®ç±»å‹ï¼ˆæœ¬ä¾‹é€‰æ‹© "Create a JavaScript project"ï¼‰, ä¸€è·¯å›è½¦å³å¯

åˆ›å»ºå¥½çš„ Hardhat é¡¹ç›®ä¸»è¦åŒ…å«ä»¥ä¸‹æ–‡ä»¶(å¤¹):

```
hardhat-demo
â”œâ”€â”€ contracts // åˆçº¦æ–‡ä»¶å¤¹
â”‚   â””â”€â”€ Lock.sol
â”œâ”€â”€ ignition // å¯åŠ¨æ–‡ä»¶å¤¹
â”‚   â””â”€â”€ modules
â”‚       â””â”€â”€ Lock.js
â”œâ”€â”€ test // æµ‹è¯•æ–‡ä»¶å¤¹
â”‚   â””â”€â”€ Lock.js
â””â”€â”€ hardhat.config.js // é…ç½®æ–‡ä»¶
```

æŸ¥çœ‹é…ç½®æ–‡ä»¶ hardhat.config.js:

```js
require("@nomicfoundation/hardhat-toolbox");

/** @type import('hardhat/config').HardhatUserConfig */
module.exports = {
    solidity: "0.8.27", // ç¼–è¯‘å™¨ç‰ˆæœ¬
};
```

<br><br>

# Hardhat Task

å¯ä»¥ä½¿ç”¨ `npx hardhat` æŸ¥çœ‹å½“å‰æ‰€æœ‰å¯ç”¨çš„ä»»åŠ¡åŠå…¶æè¿°:

```
Hardhat version 2.22.11

Usage: hardhat [GLOBAL OPTIONS] [SCOPE] <TASK> [TASK OPTIONS]

GLOBAL OPTIONS:

  --config              A Hardhat config file.
  --emoji               Use emoji in messages.
  --flamegraph          Generate a flamegraph of your Hardhat tasks
  --help                Shows this message, or a task's help if its name is provided
  --max-memory          The maximum amount of memory that Hardhat can use.
  --network             The network to connect to.
  --show-stack-traces   Show stack traces (always enabled on CI servers).
  --tsconfig            A TypeScript config file.
  --typecheck           Enable TypeScript type-checking of your scripts/tests
  --verbose             Enables Hardhat verbose logging
  --version             Shows hardhat's version.


AVAILABLE TASKS:

  check                 Check whatever you need
  clean                 Clears the cache and deletes all artifacts
  compile               Compiles the entire project, building all artifacts
  console               Opens a hardhat console
  coverage              Generates a code coverage report for tests
  flatten               Flattens and prints contracts and their dependencies. If no file is passed, all the contracts in the project will be flattened.
  gas-reporter:merge
  help                  Prints this message
  node                  Starts a JSON-RPC server on top of Hardhat Network
  run                   Runs a user-defined script after compiling the project
  test                  Runs mocha tests
  typechain             Generate Typechain typings for compiled contracts
  verify                Verifies a contract on Etherscan or Sourcify


AVAILABLE TASK SCOPES:

  ignition              Deploy your smart contracts using Hardhat Ignition
  vars                  Manage your configuration variables

To get help for a specific task run: npx hardhat help [SCOPE] <TASK>
```

<br><br>

# ç¼–è¯‘åˆçº¦

æŸ¥çœ‹ contracts/Lock.sol:

```solidity
// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.27;

import "hardhat/console.sol"; // Import the console library

contract Lock {
    uint public unlockTime;
    address payable public owner;

    event Withdrawal(uint amount, uint when);

    constructor(uint _unlockTime) payable {
        require(
            block.timestamp < _unlockTime,
            "Unlock time should be in the future"
        );

        unlockTime = _unlockTime;
        owner = payable(msg.sender);
    }

    function withdraw() public {
        console.log(
            "Unlock time is %o and block timestamp is %o",
            unlockTime,
            block.timestamp
        ); // Log the unlock time and the current block timestamp

        require(block.timestamp >= unlockTime, "You can't withdraw yet");
        require(msg.sender == owner, "You aren't the owner");

        emit Withdrawal(address(this).balance, block.timestamp);

        owner.transfer(address(this).balance);
    }
}
```

æ‰§è¡Œ `npx hardhat compile` ç¼–è¯‘åˆçº¦:

```
Compiled 2 Solidity files successfully (evm target: paris).
```

åœ¨ç¼–è¯‘å‰, hardhat ä¼šåˆ¤æ–­æ˜¯å¦æœ‰ç¬¦åˆè¦æ±‚çš„ç¼–è¯‘å™¨, å¦‚æœæ²¡æœ‰åˆ™ä¼šè¿ç½‘ä¸‹è½½ç¼–è¯‘å™¨.

ç¼–è¯‘æˆåŠŸå, ä¼šç”Ÿæˆ artifacts ç›®å½•, é‡Œé¢çš„ json æ–‡ä»¶å°±æ˜¯ç¼–è¯‘ç»“æœ, åŒ…å«äº†åˆçº¦çš„ ABI å’Œå­—èŠ‚ç ç­‰ä¿¡æ¯.

<br><br>

# æµ‹è¯•åˆçº¦

æŸ¥çœ‹ test/Lock.js:

```js
const { time, loadFixture } = require("@nomicfoundation/hardhat-toolbox/network-helpers");
const { anyValue } = require("@nomicfoundation/hardhat-chai-matchers/withArgs");
const { expect } = require("chai");

describe("Lock", function () {
    // We define a fixture to reuse the same setup in every test.
    // We use loadFixture to run this setup once, snapshot that state,
    // and reset Hardhat Network to that snapshot in every test.
    async function deployOneYearLockFixture() {
        const ONE_YEAR_IN_SECS = 365 * 24 * 60 * 60;
        const ONE_GWEI = 1_000_000_000;

        const lockedAmount = ONE_GWEI;
        const unlockTime = (await time.latest()) + ONE_YEAR_IN_SECS;

        // Contracts are deployed using the first signer/account by default
        const [owner, otherAccount] = await ethers.getSigners();

        const Lock = await ethers.getContractFactory("Lock");
        const lock = await Lock.deploy(unlockTime, { value: lockedAmount });

        return { lock, unlockTime, lockedAmount, owner, otherAccount };
    }

    describe("Deployment", function () {
        it("Should set the right unlockTime", async function () {
            const { lock, unlockTime } = await loadFixture(deployOneYearLockFixture);
            expect(await lock.unlockTime()).to.equal(unlockTime);
        });

        it("Should set the right owner", async function () {
            const { lock, owner } = await loadFixture(deployOneYearLockFixture);
            expect(await lock.owner()).to.equal(owner.address);
        });

        it("Should receive and store the funds to lock", async function () {
            const { lock, lockedAmount } = await loadFixture(deployOneYearLockFixture);
            expect(await ethers.provider.getBalance(lock.target)).to.equal(lockedAmount);
        });

        it("Should fail if the unlockTime is not in the future", async function () {
            // We don't use the fixture here because we want a different deployment
            const latestTime = await time.latest();
            const Lock = await ethers.getContractFactory("Lock");
            await expect(Lock.deploy(latestTime, { value: 1 })).to.be.revertedWith(
                "Unlock time should be in the future"
            );
        });
    });

    describe("Withdrawals", function () {
        describe("Validations", function () {
            it("Should revert with the right error if called too soon", async function () {
                const { lock } = await loadFixture(deployOneYearLockFixture);
                await expect(lock.withdraw()).to.be.revertedWith("You can't withdraw yet");
            });

            it("Should revert with the right error if called from another account", async function () {
                const { lock, unlockTime, otherAccount } = await loadFixture(deployOneYearLockFixture);
                // We can increase the time in Hardhat Network
                await time.increaseTo(unlockTime);
                // We use lock.connect() to send a transaction from another account
                await expect(lock.connect(otherAccount).withdraw()).to.be.revertedWith("You aren't the owner");
            });

            it("Shouldn't fail if the unlockTime has arrived and the owner calls it", async function () {
                const { lock, unlockTime } = await loadFixture(deployOneYearLockFixture);
                // Transactions are sent using the first signer by default
                await time.increaseTo(unlockTime);
                await expect(lock.withdraw()).not.to.be.reverted;
            });
        });

        describe("Events", function () {
            it("Should emit an event on withdrawals", async function () {
                const { lock, unlockTime, lockedAmount } = await loadFixture(deployOneYearLockFixture);
                await time.increaseTo(unlockTime);
                await expect(lock.withdraw()).to.emit(lock, "Withdrawal").withArgs(lockedAmount, anyValue); // We accept any value as `when` arg
            });
        });

        describe("Transfers", function () {
            it("Should transfer the funds to the owner", async function () {
                const { lock, unlockTime, lockedAmount, owner } = await loadFixture(deployOneYearLockFixture);
                await time.increaseTo(unlockTime);
                await expect(lock.withdraw()).to.changeEtherBalances([owner, lock], [lockedAmount, -lockedAmount]);
            });
        });
    });
});
```

æ‰§è¡Œ `npx hardhat test` è¿è¡Œæµ‹è¯•:

```
  Lock
    Deployment
      âœ” Should set the right unlockTime (1039ms)
      âœ” Should set the right owner
      âœ” Should receive and store the funds to lock
      âœ” Should fail if the unlockTime is not in the future
    Withdrawals
      Validations
Unlock time is '1758446024' and block timestamp is '1726910026'
        âœ” Should revert with the right error if called too soon
Unlock time is '1758446024' and block timestamp is '1758446025'
        âœ” Should revert with the right error if called from another account
Unlock time is '1758446024' and block timestamp is '1758446025'
        âœ” Shouldn't fail if the unlockTime has arrived and the owner calls it
      Events
Unlock time is '1758446024' and block timestamp is '1758446025'
        âœ” Should emit an event on withdrawals
      Transfers
Unlock time is '1758446024' and block timestamp is '1758446025'
        âœ” Should transfer the funds to the owner (39ms)


  9 passing (1s)
```

<br><br>

# éƒ¨ç½²åˆçº¦

æŸ¥çœ‹ ignition/modules/Lock.js:

```js
// This setup uses Hardhat Ignition to manage smart contract deployments.
// Learn more about it at https://hardhat.org/ignition

const { buildModule } = require("@nomicfoundation/hardhat-ignition/modules");

const JAN_1ST_2030 = 1893456000;
const ONE_GWEI = 1_000_000_000n;

module.exports = buildModule("LockModule", (m) => {
    const unlockTime = m.getParameter("unlockTime", JAN_1ST_2030);
    const lockedAmount = m.getParameter("lockedAmount", ONE_GWEI);

    const lock = m.contract("Lock", [unlockTime], {
        value: lockedAmount,
    });

    return { lock };
});
```

æ‰§è¡Œ `npx hardhat ignition deploy ignition/modules/Lock.js` éƒ¨ç½²åˆçº¦:

```
You are running Hardhat Ignition against an in-process instance of Hardhat Network.
This will execute the deployment, but the results will be lost.
You can use --network <network-name> to deploy to a different network.

Hardhat Ignition ğŸš€

Deploying [ LockModule ]

Batch #1
  Executed LockModule#Lock

[ LockModule ] successfully deployed ğŸš€

Deployed Addresses

LockModule#Lock - 0x5FbDB2315678afecb367f032d93F642f64180aa3
```

<br><br>

# è¿æ¥ Hardhat ç½‘ç»œ

é»˜è®¤æƒ…å†µä¸‹, Hardhat åœ¨å¯åŠ¨æ—¶ ä¼šåœ¨å†…å­˜ä¸­å¯åŠ¨ä¸€ä¸ªæ–°çš„ Hardhat Network å®ä¾‹. ä¹Ÿå¯ä»¥ç‹¬ç«‹è¿è¡Œ Hardhat Network, ä»¥ä¾¿å¤–éƒ¨å®¢æˆ·ç«¯ (å¦‚é’±åŒ…ã€Dapp å‰ç«¯æˆ– Hardhat Ignition éƒ¨ç½²) è¿æ¥.

æ‰§è¡Œ `npx hardhat node` ç‹¬ç«‹è¿è¡Œ Hardhat Network:

```
Started HTTP and WebSocket JSON-RPC server at http://127.0.0.1:8545/

Accounts
========

WARNING: These accounts, and their private keys, are publicly known.
Any funds sent to them on Mainnet or any other live network WILL BE LOST.

Account #0: 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 (10000 ETH)
Private Key: 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80

...

Account #19: 0x8626f6940E2eb28930eFb4CeF49B2d1F2C9C1199 (10000 ETH)
Private Key: 0xdf57089febbacf7ba0bc227dafbffa9fc08a93fdc68e1e42411a14efcf23656e

WARNING: These accounts, and their private keys, are publicly known.
Any funds sent to them on Mainnet or any other live network WILL BE LOST.
```

è¿™å°†å‘ Hardhat Network å…¬å¼€ä¸€ä¸ª JSON-RPC æ¥å£. è¦ä½¿ç”¨å®ƒ, éœ€è¦å°†æ‚¨çš„é’±åŒ…æˆ–åº”ç”¨ç¨‹åºè¿æ¥åˆ° http://127.0.0.1:8545

å¦‚æœè¦è¿æ¥ Hardhat åˆ°è¿™ä¸ªèŠ‚ç‚¹, éœ€è¦ä½¿ç”¨ `--network localhost`:

```
npx hardhat ignition deploy ./ignition/modules/Lock.js --network localhost
```

<br><br>
